<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>regex â€“ examples/re-gen-cabals.lhs</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="lib/lhs-styles.css" />
  <link rel="stylesheet" href="lib/bs.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/>
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="mask-icon" href="/safari-pinned-tab.svg"/>
  <meta name="theme-color" content="#ffffff"/>
</head>
<body>
<div class='bcdiv'>
  <ol class='breadcrumb'>
    <li><a href="." style="font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;" id="branding">[<span style='color:red;'>re</span>|${<span style='color:red;'>gex</span>}(.*)|<span></span>]</a></li>
    <li><a title='source file' href='https://github.com/iconnect/regex/blob/master/examples/re-gen-cabals.lhs'>examples/re-gen-cabals.lhs</a></li>
</ol>
</div>
<div class='litcontent'>
<header id="title-block-header">
<h1 class="title">examples/re-gen-cabals.lhs</h1>
</header>
<h1 id="regex-cabal-gen">Regex Cabal Gen</h1>
<p>This tool generates the cabal files for the regex and regex-examples packages as well as the cabal file for the development tree (contaiing the combined targets of both packages). In addition it contains scripts for bumping the version number and generating the Hackage releases.</p>
<p>The tool is self-testing: run it with no arguments (or <code>cabal test</code>).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude          #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="ot">{-# LANGUAGE RecordWildCards            #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="ot">{-# LANGUAGE CPP                        #-}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Main</span> (main) <span class="kw">where</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span>               <span class="kw">as</span> <span class="dt">LBS</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Char</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.IORef</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.List</span>                                <span class="kw">as</span> <span class="dt">L</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span>                                 <span class="kw">as</span> <span class="dt">Map</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Maybe</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Monoid</span>                              <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span>                                <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Encoding</span>                       <span class="kw">as</span> <span class="dt">TE</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Prelude.Compat</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Shelly</span>                                   <span class="kw">as</span> <span class="dt">SH</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Directory</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Environment</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Exit</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.IO</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">TestKit</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.Printf</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Replace</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.TDFA.ByteString.Lazy</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.RE.TDFA.Text</span>                        <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Grep</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Sed</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true"></a>  (pn,as) <span class="ot">&lt;-</span> (,) <span class="op">&lt;$&gt;</span> getProgName <span class="op">&lt;*&gt;</span> getArgs</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true"></a>  <span class="kw">case</span> as <span class="kw">of</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true"></a>    []                    <span class="ot">-&gt;</span> test</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true"></a>    [<span class="st">&quot;test&quot;</span>]              <span class="ot">-&gt;</span> test</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true"></a>    [<span class="st">&quot;bump-version&quot;</span>,vrn]  <span class="ot">-&gt;</span> bumpVersion vrn <span class="op">&gt;&gt;</span> gen</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true"></a>    [<span class="st">&quot;test-release&quot;</span>,vrn]  <span class="ot">-&gt;</span> test_release <span class="op">$</span> T.pack vrn</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true"></a>    [<span class="st">&quot;commit-message&quot;</span>]    <span class="ot">-&gt;</span> commit_message</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true"></a>    [<span class="st">&quot;sdist&quot;</span>]             <span class="ot">-&gt;</span> sdist</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true"></a>    [<span class="st">&quot;gen&quot;</span>]               <span class="ot">-&gt;</span> gen</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true"></a>    _                     <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true"></a>      <span class="kw">let</span> prg <span class="ot">=</span> ((<span class="st">&quot;  &quot;</span><span class="op">++</span>pn<span class="op">++</span><span class="st">&quot; &quot;</span>)<span class="op">++</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true"></a>      hPutStr stderr <span class="op">$</span> <span class="fu">unlines</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true"></a>        [ <span class="st">&quot;usage:&quot;</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true"></a>        , prg <span class="st">&quot;--help&quot;</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true"></a>        , prg <span class="st">&quot;[test]&quot;</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true"></a>        , prg <span class="st">&quot;bump-version &lt;version&gt;&quot;</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true"></a>        , prg <span class="st">&quot;test-release &lt;version&gt;&quot;</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true"></a>        , prg <span class="st">&quot;commit-message&quot;</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true"></a>        , prg <span class="st">&quot;sdist&quot;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true"></a>        , prg <span class="st">&quot;gen&quot;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true"></a>        ]</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true"></a>      exitWith <span class="op">$</span> <span class="dt">ExitFailure</span> <span class="dv">1</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true"></a><span class="ot">test ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true"></a>test <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true"></a>  createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true"></a>  gen1 <span class="st">&quot;lib/cabal-masters/mega-regex.cabal&quot;</span> <span class="st">&quot;tmp/mega-regex.cabal&quot;</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true"></a>  ok <span class="ot">&lt;-</span> cmp <span class="st">&quot;tmp/mega-regex.cabal&quot;</span> <span class="st">&quot;lib/mega-regex.cabal&quot;</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true"></a>  <span class="kw">case</span> ok <span class="kw">of</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true"></a>    <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true"></a>    <span class="dt">False</span> <span class="ot">-&gt;</span> exitWith <span class="op">$</span> <span class="dt">ExitFailure</span> <span class="dv">1</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true"></a><span class="ot">gen ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true"></a>gen <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true"></a>  gen1  <span class="st">&quot;lib/cabal-masters/mega-regex.cabal&quot;</span>       <span class="st">&quot;lib/mega-regex.cabal&quot;</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true"></a>  gen1  <span class="st">&quot;lib/cabal-masters/regex.cabal&quot;</span>            <span class="st">&quot;lib/regex.cabal&quot;</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true"></a>  gen1  <span class="st">&quot;lib/cabal-masters/regex-with-pcre.cabal&quot;</span>  <span class="st">&quot;lib/regex-with-pcre.cabal&quot;</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true"></a>  gen1  <span class="st">&quot;lib/cabal-masters/regex-examples.cabal&quot;</span>   <span class="st">&quot;lib/regex-examples.cabal&quot;</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true"></a>  establish <span class="st">&quot;mega-regex&quot;</span> <span class="st">&quot;regex&quot;</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true"></a><span class="ot">gen1 ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true"></a>gen1 in_f out_f <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true"></a>    ctx <span class="ot">&lt;-</span> setup</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true"></a>    LBS.writeFile out_f <span class="op">=&lt;&lt;</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true"></a>      sed&#39; (gc_script ctx) <span class="op">=&lt;&lt;</span> substVersion_ <span class="op">=&lt;&lt;</span> include <span class="op">=&lt;&lt;</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true"></a>        LBS.readFile in_f</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true"></a></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Ctx</span> <span class="ot">=</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true"></a>  <span class="dt">Ctx</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true"></a>    {<span class="ot"> _ctx_w_error             ::</span> <span class="dt">IORef</span> <span class="dt">Bool</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true"></a>    ,<span class="ot"> _ctx_filter_pcre         ::</span> <span class="dt">IORef</span> <span class="dt">Bool</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true"></a>    ,<span class="ot"> _ctx_package_constraints ::</span> <span class="dt">IORef</span> (<span class="dt">Map.Map</span> <span class="dt">LBS.ByteString</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true"></a>    ,<span class="ot"> _ctx_test_exe            ::</span> <span class="dt">IORef</span> (<span class="dt">Maybe</span> <span class="dt">TestExe</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true"></a>    }</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">TestExe</span> <span class="ot">=</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true"></a>  <span class="dt">TestExe</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true"></a>    {<span class="ot"> _te_test ::</span> <span class="dt">Bool</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true"></a>    ,<span class="ot"> _te_exe  ::</span> <span class="dt">Bool</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true"></a>    ,<span class="ot"> _te_name ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true"></a>    ,<span class="ot"> _te_text ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true"></a>    }</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true"></a><span class="ot">setup ::</span> <span class="dt">IO</span> <span class="dt">Ctx</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true"></a>setup <span class="ot">=</span> <span class="dt">Ctx</span> <span class="op">&lt;$&gt;</span> (newIORef <span class="dt">True</span>) <span class="op">&lt;*&gt;</span> (newIORef <span class="dt">False</span>) <span class="op">&lt;*&gt;</span> (newIORef Map.empty) <span class="op">&lt;*&gt;</span> (newIORef <span class="dt">Nothing</span>)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true"></a><span class="ot">gc_script ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">Edits</span> <span class="dt">IO</span> <span class="dt">RE</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true"></a>gc_script ctx <span class="ot">=</span> <span class="dt">Select</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true"></a>    [ <span class="dt">LineEdit</span> [re|^%Werror$|]                            <span class="op">$</span> w_error_gen              ctx</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^%Wwarn$|]                             <span class="op">$</span> w_warn_gen               ctx</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^%filter-regex-with-pcre$|]            <span class="op">$</span> w_filter_pcre            ctx</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^%- +${pkg}(@{%id-}) +${cond}(.*)$|]   <span class="op">$</span> cond_gen                 ctx</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^%build-depends-${lb}(lib|prog) +${list}(@{%id-}( +@{%id-})*)$|]</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true"></a>                                                          <span class="op">$</span> build_depends_gen        ctx</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^%test +${i}(@{%id-})$|]               <span class="op">$</span> test_exe_gen <span class="dt">True</span>  <span class="dt">False</span> ctx</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^%exe +${i}(@{%id-})$|]                <span class="op">$</span> test_exe_gen <span class="dt">False</span> <span class="dt">True</span>  ctx</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^%test-exe +${i}(@{%id-})$|]           <span class="op">$</span> test_exe_gen <span class="dt">True</span>  <span class="dt">True</span>  ctx</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^.*$|]                                 <span class="op">$</span> default_gen              ctx</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true"></a>    ]</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true"></a></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true"></a>w_error_gen, w_warn_gen, w_filter_pcre, cond_gen, build_depends_gen,</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true"></a><span class="ot">  default_gen ::</span> <span class="dt">Ctx</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true"></a>w_error_gen   <span class="dt">Ctx</span>{<span class="op">..</span>} _ _ <span class="ot">=</span> writeIORef _ctx_w_error     <span class="dt">True</span>  <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="dt">Delete</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true"></a>w_warn_gen    <span class="dt">Ctx</span>{<span class="op">..</span>} _ _ <span class="ot">=</span> writeIORef _ctx_w_error     <span class="dt">False</span> <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="dt">Delete</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true"></a>w_filter_pcre <span class="dt">Ctx</span>{<span class="op">..</span>} _ _ <span class="ot">=</span> writeIORef _ctx_filter_pcre <span class="dt">True</span>  <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="dt">Delete</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true"></a></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true"></a>cond_gen <span class="dt">Ctx</span>{<span class="op">..</span>} _ mtchs <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true"></a>    modifyIORef _ctx_package_constraints <span class="op">$</span> Map.insert pkg cond</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true"></a>    <span class="fu">return</span> <span class="dt">Delete</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true"></a>    pkg  <span class="ot">=</span> captureText [cp|pkg|]  mtch</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true"></a>    cond <span class="ot">=</span> captureText [cp|cond|] mtch</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true"></a></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true"></a>    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true"></a></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true"></a>build_depends_gen ctx<span class="op">@</span><span class="dt">Ctx</span>{<span class="op">..</span>} _ mtchs <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true"></a>    we <span class="ot">&lt;-</span> readIORef _ctx_w_error</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true"></a>    fp <span class="ot">&lt;-</span> readIORef _ctx_filter_pcre</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true"></a>    mp <span class="ot">&lt;-</span> readIORef _ctx_package_constraints</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true"></a>    put ctx <span class="op">$</span> mk_build_depends lb we fp mp lst</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true"></a>    lb   <span class="ot">=</span> captureText [cp|lb|] mtch <span class="op">==</span> <span class="st">&quot;lib&quot;</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true"></a>    lst  <span class="ot">=</span> LBS.words <span class="op">$</span> captureText [cp|list|] mtch</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true"></a>    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true"></a></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true"></a>default_gen ctx<span class="op">@</span><span class="dt">Ctx</span>{<span class="op">..</span>} _ mtchs <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true"></a>    mb <span class="ot">&lt;-</span> readIORef _ctx_test_exe</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true"></a>    <span class="kw">case</span> mb <span class="kw">of</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">ReplaceWith</span> ln</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true"></a>      <span class="dt">Just</span> te <span class="ot">-&gt;</span> <span class="kw">case</span> <span class="fu">isSpace</span> <span class="op">$</span> LBS.head <span class="op">$</span> ln <span class="op">M.&lt;&gt;</span> <span class="st">&quot;\n&quot;</span> <span class="kw">of</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true"></a>        <span class="dt">True</span>  <span class="ot">-&gt;</span> put ctx ln</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true"></a>        <span class="dt">False</span> <span class="ot">-&gt;</span> adjust_le (<span class="op">M.&lt;&gt;</span>ln) <span class="op">&lt;$&gt;</span> close_test_exe ctx te</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true"></a>    ln   <span class="ot">=</span> matchSource mtch</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true"></a>    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true"></a></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true"></a><span class="ot">test_exe_gen ::</span> <span class="dt">Bool</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">Ctx</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true"></a>test_exe_gen is_t is_e ctx _ mtchs <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true"></a>    mb <span class="ot">&lt;-</span> readIORef  (_ctx_test_exe ctx)</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true"></a>    le <span class="ot">&lt;-</span> <span class="fu">maybe</span> (<span class="fu">return</span> <span class="dt">Delete</span>) (close_test_exe ctx) mb</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true"></a>    writeIORef (_ctx_test_exe ctx) <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true"></a>      <span class="dt">TestExe</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true"></a>        { _te_test <span class="ot">=</span> is_t</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true"></a>        , _te_exe  <span class="ot">=</span> is_e</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true"></a>        , _te_name <span class="ot">=</span> i</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true"></a>        , _te_text <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true"></a>        }</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true"></a>    <span class="fu">return</span> le</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true"></a>    i    <span class="ot">=</span> captureText [cp|i|] mtch</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true"></a></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true"></a>    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true"></a></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true"></a><span class="ot">close_test_exe ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">TestExe</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true"></a>close_test_exe ctx<span class="op">@</span><span class="dt">Ctx</span>{<span class="op">..</span>} te <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true"></a>  writeIORef _ctx_test_exe <span class="dt">Nothing</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true"></a>  put ctx <span class="op">$</span> <span class="fu">mconcat</span> <span class="op">$</span> <span class="fu">concat</span> <span class="op">$</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true"></a>    [ [ mk_test_exe <span class="dt">False</span> te <span class="st">&quot;Executable&quot;</span> <span class="op">|</span> _te_exe  te ]</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true"></a>    , [ mk_test_exe <span class="dt">True</span>  te <span class="st">&quot;Test-Suite&quot;</span> <span class="op">|</span> _te_test te ]</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true"></a>    ]</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true"></a></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true"></a><span class="ot">put ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true"></a>put <span class="dt">Ctx</span>{<span class="op">..</span>} lbs <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true"></a>    mb <span class="ot">&lt;-</span> readIORef _ctx_test_exe</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true"></a>    <span class="kw">case</span> mb <span class="kw">of</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">ReplaceWith</span> lbs</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true"></a>      <span class="dt">Just</span> te <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true"></a>        writeIORef _ctx_test_exe <span class="op">$</span> <span class="dt">Just</span> te { _te_text <span class="ot">=</span> _te_text te <span class="op">M.&lt;&gt;</span> lbs <span class="op">M.&lt;&gt;</span> <span class="st">&quot;\n&quot;</span> }</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true"></a>        <span class="fu">return</span> <span class="dt">Delete</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true"></a></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true"></a><span class="ot">mk_test_exe ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">TestExe</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true"></a>mk_test_exe is_t te te_lbs_kw <span class="ot">=</span> (<span class="op">M.&lt;&gt;</span> _te_text te) <span class="op">$</span> LBS.unlines <span class="op">$</span> <span class="fu">concat</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true"></a>    [ [ LBS.pack <span class="op">$</span> printf <span class="st">&quot;%s %s&quot;</span> (LBS.unpack te_lbs_kw) nm ]</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true"></a>    , [ <span class="st">&quot;    type:               exitcode-stdio-1.0&quot;</span> <span class="op">|</span> is_t ]</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true"></a>    ]</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true"></a>    nm <span class="ot">=</span> <span class="kw">case</span> is_t <span class="kw">of</span></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true"></a>      <span class="dt">True</span>  <span class="ot">-&gt;</span> LBS.unpack <span class="op">$</span> _te_name te <span class="op">M.&lt;&gt;</span> <span class="st">&quot;-test&quot;</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true"></a>      <span class="dt">False</span> <span class="ot">-&gt;</span> LBS.unpack <span class="op">$</span> _te_name te</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true"></a></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true"></a><span class="ot">mk_build_depends ::</span> <span class="dt">Bool</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true"></a>                 <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true"></a>                 <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true"></a>                 <span class="ot">-&gt;</span> <span class="dt">Map.Map</span> <span class="dt">LBS.ByteString</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true"></a>                 <span class="ot">-&gt;</span> [<span class="dt">LBS.ByteString</span>]</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true"></a>                 <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true"></a>mk_build_depends lb we fp mp pks0 <span class="ot">=</span> LBS.unlines <span class="op">$</span></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true"></a>        [ <span class="st">&quot;    Default-Language:   Haskell2010&quot;</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true"></a>        , <span class="st">&quot;&quot;</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true"></a>        ] <span class="op">++</span> <span class="fu">filter</span> (<span class="kw">if</span> lb <span class="kw">then</span> <span class="fu">const</span> <span class="dt">True</span> <span class="kw">else</span> <span class="fu">const</span> <span class="dt">False</span>)</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true"></a>        [ <span class="st">&quot;    Other-Extensions:&quot;</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true"></a>        , <span class="st">&quot;      AllowAmbiguousTypes&quot;</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true"></a>        , <span class="st">&quot;      CPP&quot;</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true"></a>        , <span class="st">&quot;      DeriveDataTypeable&quot;</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true"></a>        , <span class="st">&quot;      DeriveGeneric&quot;</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true"></a>        , <span class="st">&quot;      ExistentialQuantification&quot;</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true"></a>        , <span class="st">&quot;      FlexibleContexts&quot;</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true"></a>        , <span class="st">&quot;      FlexibleInstances&quot;</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true"></a>        , <span class="st">&quot;      FunctionalDependencies&quot;</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true"></a>        , <span class="st">&quot;      GeneralizedNewtypeDeriving&quot;</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true"></a>        , <span class="st">&quot;      MultiParamTypeClasses&quot;</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true"></a>        , <span class="st">&quot;      NoImplicitPrelude&quot;</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true"></a>        , <span class="st">&quot;      OverloadedStrings&quot;</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true"></a>        , <span class="st">&quot;      QuasiQuotes&quot;</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true"></a>        , <span class="st">&quot;      RecordWildCards&quot;</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true"></a>        , <span class="st">&quot;      ScopedTypeVariables&quot;</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true"></a>        , <span class="st">&quot;      TemplateHaskell&quot;</span></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true"></a>        , <span class="st">&quot;      TypeSynonymInstances&quot;</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true"></a>        , <span class="st">&quot;      UndecidableInstances&quot;</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true"></a>        , <span class="st">&quot;&quot;</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true"></a>        , <span class="st">&quot;    if !impl(ghc &gt;= 8.0)&quot;</span></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true"></a>        , <span class="st">&quot;      Other-Extensions: TemplateHaskell&quot;</span></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true"></a>        , <span class="st">&quot;    else&quot;</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true"></a>        , <span class="st">&quot;      Other-Extensions: TemplateHaskellQuotes&quot;</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true"></a>        , <span class="st">&quot;&quot;</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true"></a>        ] <span class="op">++</span></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true"></a>        [ <span class="st">&quot;    GHC-Options:&quot;</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true"></a>        , <span class="st">&quot;      -Wall&quot;</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true"></a>        , <span class="st">&quot;      -fwarn-tabs&quot;</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true"></a>        , <span class="st">&quot;      &quot;</span> <span class="op">M.&lt;&gt;</span> w_error_or_warn</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true"></a>        , <span class="st">&quot;&quot;</span></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true"></a>        , <span class="st">&quot;    Build-depends:&quot;</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true"></a>        ] <span class="op">++</span> (<span class="fu">map</span> fmt <span class="op">$</span> <span class="fu">zip</span> (<span class="dt">True</span> <span class="op">:</span> <span class="fu">repeat</span> <span class="dt">False</span>) <span class="op">$</span> L.sortBy comp pks)</span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true"></a>    w_error_or_warn <span class="ot">=</span> <span class="kw">case</span> we <span class="kw">of</span></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true"></a>      <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="st">&quot;-Werror&quot;</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true"></a>      <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="st">&quot;-Wwarn&quot;</span></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true"></a></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true"></a>    pks <span class="ot">=</span> <span class="kw">case</span> fp <span class="kw">of</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true"></a>      <span class="dt">False</span> <span class="ot">-&gt;</span> pks0</span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true"></a>      <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="fu">filter</span> (<span class="op">/=</span> <span class="st">&quot;regex-with-pcre&quot;</span>) pks0</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true"></a></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true"></a>    fmt (isf,pk) <span class="ot">=</span> LBS.pack <span class="op">$</span></span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true"></a>      printf <span class="st">&quot;      %c %-20s %s&quot;</span></span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true"></a>        (<span class="kw">if</span> isf <span class="kw">then</span> <span class="ch">&#39; &#39;</span> <span class="kw">else</span> <span class="ch">&#39;,&#39;</span>)</span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true"></a>        (LBS.unpack pk)</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true"></a>        (<span class="fu">maybe</span> <span class="st">&quot;&quot;</span> LBS.unpack <span class="op">$</span> Map.lookup pk mp)</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true"></a></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true"></a>    comp x y <span class="ot">=</span> <span class="kw">case</span> (x<span class="op">==</span><span class="st">&quot;regex&quot;</span>,y<span class="op">==</span><span class="st">&quot;regex&quot;</span>) <span class="kw">of</span></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true"></a>      (<span class="dt">True</span> ,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">EQ</span></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true"></a>      (<span class="dt">True</span> ,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="dt">LT</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true"></a>      (<span class="dt">False</span>,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">GT</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true"></a>      (<span class="dt">False</span>,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="kw">case</span> (x<span class="op">==</span><span class="st">&quot;regex-with-pcre&quot;</span>,y<span class="op">==</span><span class="st">&quot;regex-with-pcre&quot;</span>) <span class="kw">of</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true"></a>        (<span class="dt">True</span> ,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">EQ</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true"></a>        (<span class="dt">True</span> ,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="dt">LT</span></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true"></a>        (<span class="dt">False</span>,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">GT</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true"></a>        (<span class="dt">False</span>,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="fu">compare</span> x y</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true"></a></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true"></a><span class="ot">adjust_le ::</span> (<span class="dt">LBS.ByteString</span><span class="ot">-&gt;</span><span class="dt">LBS.ByteString</span>)</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true"></a>adjust_le f le <span class="ot">=</span> <span class="kw">case</span> le <span class="kw">of</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true"></a>  <span class="dt">NoEdit</span>          <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;adjust_le: not enough context&quot;</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true"></a>  <span class="dt">ReplaceWith</span> lbs <span class="ot">-&gt;</span> <span class="dt">ReplaceWith</span> <span class="op">$</span> f lbs</span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true"></a>  <span class="dt">Delete</span>          <span class="ot">-&gt;</span> <span class="dt">ReplaceWith</span> <span class="op">$</span> f <span class="st">&quot;&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="ot">sdist ::</span> <span class="dt">IO</span> ()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>sdist <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  sdist&#39;    <span class="st">&quot;regex&quot;</span>            <span class="st">&quot;lib/README-regex.md&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>  sdist&#39;    <span class="st">&quot;regex-with-pcre&quot;</span>  <span class="st">&quot;lib/README-regex.md&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>  sdist&#39;    <span class="st">&quot;regex-examples&quot;</span>   <span class="st">&quot;lib/README-regex-examples.md&quot;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>  establish <span class="st">&quot;mega-regex&quot;</span> <span class="st">&quot;regex&quot;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>  vrn <span class="ot">&lt;-</span> readCurrentVersion</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>  <span class="kw">let</span> vrn_t <span class="ot">=</span> T.pack <span class="op">$</span> presentVrn vrn</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>  test_release vrn_t</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>  smy_t <span class="ot">&lt;-</span> summary vrn</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>  commit_message_ <span class="st">&quot;tmp/commit.txt&quot;</span> vrn smy_t</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>  SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>    SH.run_ <span class="st">&quot;git&quot;</span> [<span class="st">&quot;add&quot;</span>,<span class="st">&quot;--all&quot;</span>]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>    SH.run_ <span class="st">&quot;git&quot;</span> [<span class="st">&quot;commit&quot;</span>,<span class="st">&quot;-F&quot;</span>,<span class="st">&quot;tmp/commit.txt&quot;</span>]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>    SH.run_ <span class="st">&quot;git&quot;</span> [<span class="st">&quot;tag&quot;</span>,vrn_t,<span class="st">&quot;-m&quot;</span>,smy_t]</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a><span class="ot">sdist&#39; ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">SH.FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>sdist&#39; nm readme <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>  establish nm nm</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>  SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>    SH.cp readme <span class="st">&quot;README.markdown&quot;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>    SH.run_ <span class="st">&quot;stack&quot;</span> [<span class="st">&quot;sdist&quot;</span>,<span class="st">&quot;--stack-yaml&quot;</span>,<span class="st">&quot;stack-8.8.yaml&quot;</span>]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>    (pth,tb) <span class="ot">&lt;-</span> analyse_so <span class="op">&lt;$&gt;</span> SH.lastStderr</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>    SH.cp (SH.fromText <span class="op">$</span> pth) <span class="op">$</span> SH.fromText <span class="op">$</span> <span class="st">&quot;releases/&quot;</span> <span class="op">M.&lt;&gt;</span> tb</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a>    analyse_so so <span class="ot">=</span> (mtch<span class="op">!$$</span>[cp|pth|],mtch<span class="op">!$$</span>[cp|tb|])</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true"></a>      <span class="kw">where</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true"></a>        mtch <span class="ot">=</span> so <span class="op">T.?=~</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true"></a>          [re|^.*Wrote sdist tarball to ${pth}(.*${tb}(regex-.*\.tar\.gz))$|]</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true"></a><span class="ot">establish ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true"></a>establish nm nm&#39; <span class="ot">=</span> SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true"></a>    SH.rm_f <span class="st">&quot;mega-regex.cabal&quot;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true"></a>    SH.rm_f <span class="st">&quot;regex-with-pcre.cabal&quot;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true"></a>    SH.rm_f <span class="st">&quot;regex.cabal&quot;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true"></a>    SH.rm_f <span class="st">&quot;regex-examples.cabal&quot;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true"></a>    SH.cp (SH.fromText sf) (SH.fromText df)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true"></a>    sf <span class="ot">=</span> <span class="st">&quot;lib/&quot;</span> <span class="op">M.&lt;&gt;</span> nm <span class="op">M.&lt;&gt;</span> <span class="st">&quot;.cabal&quot;</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true"></a>    df <span class="ot">=</span> nm&#39; <span class="op">M.&lt;&gt;</span> <span class="st">&quot;.cabal&quot;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true"></a><span class="ot">test_release ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true"></a>test_release vrn_t <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true"></a>    setCurrentDirectory <span class="st">&quot;releases&quot;</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true"></a>    SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true"></a>      SH.rm_rf <span class="st">&quot;test-regex-examples&quot;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true"></a>      unpack <span class="st">&quot;.&quot;</span> <span class="st">&quot;regex-examples&quot;</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true"></a>    setCurrentDirectory <span class="st">&quot;test-regex-examples&quot;</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true"></a>    SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true"></a>      unpack <span class="st">&quot;..&quot;</span> <span class="st">&quot;regex&quot;</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true"></a>      unpack <span class="st">&quot;..&quot;</span> <span class="st">&quot;regex-with-pcre&quot;</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true"></a>      SH.cp <span class="st">&quot;../../lib/release-testing/stack.yaml&quot;</span> <span class="st">&quot;.&quot;</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true"></a>      SH.run_ <span class="st">&quot;stack&quot;</span> [<span class="st">&quot;--no-terminal&quot;</span>,<span class="st">&quot;test&quot;</span>, <span class="st">&quot;--haddock&quot;</span>, <span class="st">&quot;--no-haddock-deps&quot;</span>]</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true"></a>    setCurrentDirectory <span class="st">&quot;../..&quot;</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true"></a>    unpack rp pn <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true"></a>        SH.run_ <span class="st">&quot;tar&quot;</span> [<span class="st">&quot;xzf&quot;</span>,rp <span class="op">M.&lt;&gt;</span> <span class="st">&quot;/&quot;</span> <span class="op">M.&lt;&gt;</span> pn_vrn <span class="op">M.&lt;&gt;</span> <span class="st">&quot;.tar.gz&quot;</span>]</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true"></a>        SH.mv (SH.fromText pn_vrn) (SH.fromText <span class="op">$</span> <span class="st">&quot;test-&quot;</span> <span class="op">M.&lt;&gt;</span> pn)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true"></a>      <span class="kw">where</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true"></a>        pn_vrn <span class="ot">=</span> pn <span class="op">M.&lt;&gt;</span> <span class="st">&quot;-&quot;</span> <span class="op">M.&lt;&gt;</span> vrn_t</span></code></pre></div>
<h2 id="building-the-release-commit-message-from-the-changelog">Building the Release Commit Message from the Changelog</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ot">commit_message ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>commit_message <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>  vrn   <span class="ot">&lt;-</span> readCurrentVersion</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  smy_t <span class="ot">&lt;-</span> summary vrn</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>  commit_message_ <span class="st">&quot;tmp/commit.txt&quot;</span> vrn smy_t</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>  LBS.readFile <span class="st">&quot;tmp/commit.txt&quot;</span> <span class="op">&gt;&gt;=</span> LBS.putStrLn</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a><span class="ot">commit_message_ ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Vrn</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>commit_message_ fp vrn<span class="op">@</span><span class="dt">Vrn</span>{<span class="op">..</span>} smy_t <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>    rex <span class="ot">&lt;-</span> escape (<span class="st">&quot;^&quot;</span><span class="op">++</span>) vrn_s</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>    parse_commit smy_ln <span class="op">&lt;$&gt;</span> grepLines rex <span class="st">&quot;changelog&quot;</span> <span class="op">&gt;&gt;=</span> LBS.writeFile fp</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    smy_ln <span class="ot">=</span> vrn_s <span class="op">++</span> <span class="st">&quot;: &quot;</span> <span class="op">++</span> T.unpack smy_t</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>    vrn_s  <span class="ot">=</span> presentVrn vrn</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a><span class="ot">parse_commit ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Line</span> <span class="dt">LBS.ByteString</span>] <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>parse_commit hdr lns0 <span class="ot">=</span> <span class="kw">case</span> lns0 <span class="kw">of</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>    _<span class="op">:</span>_<span class="op">:</span>ln<span class="op">:</span>lns <span class="op">|</span> anyMatches <span class="op">$</span> getLineMatches ln</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>      <span class="ot">-&gt;</span> LBS.unlines <span class="op">$</span> LBS.pack hdr <span class="op">:</span> <span class="fu">map</span> fixes (<span class="fu">takeWhile</span> is_bullet lns)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>    _ <span class="ot">-&gt;</span> <span class="fu">error</span> oops</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>    is_bullet <span class="dt">Line</span>{<span class="op">..</span>} <span class="ot">=</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>        LBS.take <span class="dv">4</span> (matchesSource getLineMatches) <span class="op">==</span> <span class="st">&quot;  * &quot;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>    fixes <span class="dt">Line</span>{<span class="op">..</span>} <span class="ot">=</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>        matchesSource getLineMatches <span class="op">*=~/</span> [ed|#${n}([0-9]+)///fixes #${n}|]</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a>    oops <span class="ot">=</span> <span class="fu">unlines</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a>      [ <span class="st">&quot;failed to parse changelog&quot;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a>      , <span class="st">&quot;(expected line 3 to start with the current version)&quot;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a>      ]</span></code></pre></div>
<h2 id="extracting-the-summary-from-the-roadmap">Extracting the summary from the Roadmap</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="ot">summary ::</span> <span class="dt">Vrn</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">T.Text</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>summary vrn <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>  <span class="kw">let</span> vrn_res <span class="ot">=</span> <span class="fu">concat</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>        [ <span class="fu">show</span> <span class="op">$</span> _vrn_a vrn</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>        , <span class="st">&quot;\\.&quot;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>        , <span class="fu">show</span> <span class="op">$</span> _vrn_b vrn</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>        , <span class="st">&quot;\\.&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>        , <span class="fu">show</span> <span class="op">$</span> _vrn_c vrn</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>        , <span class="st">&quot;\\.&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>        , <span class="fu">show</span> <span class="op">$</span> _vrn_d vrn</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>        ]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>  rex <span class="ot">&lt;-</span> compileRegex <span class="op">$</span> <span class="st">&quot;- \\[[xX]\\] +@{%date} +v&quot;</span><span class="op">++</span>vrn_res<span class="op">++</span><span class="st">&quot; +\\[?${smy}([^]]+)&quot;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>  lns <span class="ot">&lt;-</span> linesMatched <span class="dt">LinesMatched</span> <span class="op">&lt;$&gt;</span> grepLines rex <span class="st">&quot;lib/md/roadmap-incl.md&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>  <span class="kw">case</span> lns <span class="kw">of</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>    [<span class="dt">Line</span> _ (<span class="dt">Matches</span> _ [mtch])] <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> TE.decodeUtf8 <span class="op">$</span> LBS.toStrict <span class="op">$</span> mtch <span class="op">!$$</span> [cp|smy|]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>    _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;failed to locate the summary text in the roadmap&quot;</span></span></code></pre></div>
</div>    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-92650418-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>
