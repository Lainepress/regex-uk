<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>regex â€“ examples/re-gen-cabals.lhs</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="lib/lhs-styles.css" />
  <link rel="stylesheet" href="lib/bs.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/>
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="mask-icon" href="/safari-pinned-tab.svg"/>
  <meta name="theme-color" content="#ffffff"/>
</head>
<body>
<div class='bcdiv'>
  <ol class='breadcrumb'>
    <li><a href="." style="font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;" id="branding">[<span style='color:red;'>re</span>|${<span style='color:red;'>gex</span>}(.*)|<span></span>]</a></li>
    <li><a title='source file' href='https://github.com/iconnect/regex/blob/master/examples/re-gen-cabals.lhs'>examples/re-gen-cabals.lhs</a></li>
</ol>
</div>
<div class='litcontent'>
<header id="title-block-header">
<h1 class="title">examples/re-gen-cabals.lhs</h1>
</header>
<h1 id="regex-cabal-gen">Regex Cabal Gen</h1>
<p>This tool generates the cabal files for the regex and regex-examples packages as well as the cabal file for the development tree (contaiing the combined targets of both packages). In addition it contains scripts for bumping the version number and generating the Hackage releases.</p>
<p>The tool is self-testing: run it with no arguments (or <code>cabal test</code>).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE NoImplicitPrelude          #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE RecordWildCards            #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="ot">{-# LANGUAGE CPP                        #-}</span></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">module</span> <span class="dt">Main</span> (main) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span>               <span class="kw">as</span> <span class="dt">LBS</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span>           <span class="dt">Data.Char</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">import</span>           <span class="dt">Data.IORef</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.List</span>                                <span class="kw">as</span> <span class="dt">L</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span>                                 <span class="kw">as</span> <span class="dt">Map</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="kw">import</span>           <span class="dt">Data.Maybe</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Monoid</span>                              <span class="kw">as</span> <span class="dt">M</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span>                                <span class="kw">as</span> <span class="dt">T</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Encoding</span>                       <span class="kw">as</span> <span class="dt">TE</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="kw">import</span>           <span class="dt">Prelude.Compat</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Shelly</span>                                   <span class="kw">as</span> <span class="dt">SH</span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="kw">import</span>           <span class="dt">System.Directory</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="kw">import</span>           <span class="dt">System.Environment</span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="kw">import</span>           <span class="dt">System.Exit</span></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="kw">import</span>           <span class="dt">System.IO</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="kw">import</span>           <span class="dt">TestKit</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="kw">import</span>           <span class="dt">Text.Printf</span></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="kw">import</span>           <span class="dt">Text.RE.Replace</span></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="kw">import</span>           <span class="dt">Text.RE.TDFA.ByteString.Lazy</span></a>
<a class="sourceLine" id="cb1-29" title="29"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.RE.TDFA.Text</span>                        <span class="kw">as</span> <span class="dt">T</span></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Grep</span></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Sed</span></a>
<a class="sourceLine" id="cb1-32" title="32"></a>
<a class="sourceLine" id="cb1-33" title="33"></a>
<a class="sourceLine" id="cb1-34" title="34"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-35" title="35">main <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-36" title="36">  (pn,as) <span class="ot">&lt;-</span> (,) <span class="op">&lt;$&gt;</span> getProgName <span class="op">&lt;*&gt;</span> getArgs</a>
<a class="sourceLine" id="cb1-37" title="37">  <span class="kw">case</span> as <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-38" title="38">    []                    <span class="ot">-&gt;</span> test</a>
<a class="sourceLine" id="cb1-39" title="39">    [<span class="st">&quot;test&quot;</span>]              <span class="ot">-&gt;</span> test</a>
<a class="sourceLine" id="cb1-40" title="40">    [<span class="st">&quot;bump-version&quot;</span>,vrn]  <span class="ot">-&gt;</span> bumpVersion vrn <span class="op">&gt;&gt;</span> gen</a>
<a class="sourceLine" id="cb1-41" title="41">    [<span class="st">&quot;test-release&quot;</span>,vrn]  <span class="ot">-&gt;</span> test_release <span class="op">$</span> T.pack vrn</a>
<a class="sourceLine" id="cb1-42" title="42">    [<span class="st">&quot;commit-message&quot;</span>]    <span class="ot">-&gt;</span> commit_message</a>
<a class="sourceLine" id="cb1-43" title="43">    [<span class="st">&quot;sdist&quot;</span>]             <span class="ot">-&gt;</span> sdist</a>
<a class="sourceLine" id="cb1-44" title="44">    [<span class="st">&quot;gen&quot;</span>]               <span class="ot">-&gt;</span> gen</a>
<a class="sourceLine" id="cb1-45" title="45">    _                     <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-46" title="46">      <span class="kw">let</span> prg <span class="ot">=</span> ((<span class="st">&quot;  &quot;</span><span class="op">++</span>pn<span class="op">++</span><span class="st">&quot; &quot;</span>)<span class="op">++</span>)</a>
<a class="sourceLine" id="cb1-47" title="47">      hPutStr stderr <span class="op">$</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb1-48" title="48">        [ <span class="st">&quot;usage:&quot;</span></a>
<a class="sourceLine" id="cb1-49" title="49">        , prg <span class="st">&quot;--help&quot;</span></a>
<a class="sourceLine" id="cb1-50" title="50">        , prg <span class="st">&quot;[test]&quot;</span></a>
<a class="sourceLine" id="cb1-51" title="51">        , prg <span class="st">&quot;bump-version &lt;version&gt;&quot;</span></a>
<a class="sourceLine" id="cb1-52" title="52">        , prg <span class="st">&quot;test-release &lt;version&gt;&quot;</span></a>
<a class="sourceLine" id="cb1-53" title="53">        , prg <span class="st">&quot;commit-message&quot;</span></a>
<a class="sourceLine" id="cb1-54" title="54">        , prg <span class="st">&quot;sdist&quot;</span></a>
<a class="sourceLine" id="cb1-55" title="55">        , prg <span class="st">&quot;gen&quot;</span></a>
<a class="sourceLine" id="cb1-56" title="56">        ]</a>
<a class="sourceLine" id="cb1-57" title="57">      exitWith <span class="op">$</span> <span class="dt">ExitFailure</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-58" title="58"></a>
<a class="sourceLine" id="cb1-59" title="59"><span class="ot">test ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-60" title="60">test <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-61" title="61">  createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></a>
<a class="sourceLine" id="cb1-62" title="62">  gen1 <span class="st">&quot;lib/cabal-masters/mega-regex.cabal&quot;</span> <span class="st">&quot;tmp/mega-regex.cabal&quot;</span></a>
<a class="sourceLine" id="cb1-63" title="63">  ok <span class="ot">&lt;-</span> cmp <span class="st">&quot;tmp/mega-regex.cabal&quot;</span> <span class="st">&quot;lib/mega-regex.cabal&quot;</span></a>
<a class="sourceLine" id="cb1-64" title="64">  <span class="kw">case</span> ok <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-65" title="65">    <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> ()</a>
<a class="sourceLine" id="cb1-66" title="66">    <span class="dt">False</span> <span class="ot">-&gt;</span> exitWith <span class="op">$</span> <span class="dt">ExitFailure</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-67" title="67"></a>
<a class="sourceLine" id="cb1-68" title="68"><span class="ot">gen ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-69" title="69">gen <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-70" title="70">  gen1  <span class="st">&quot;lib/cabal-masters/mega-regex.cabal&quot;</span>       <span class="st">&quot;lib/mega-regex.cabal&quot;</span></a>
<a class="sourceLine" id="cb1-71" title="71">  gen1  <span class="st">&quot;lib/cabal-masters/regex.cabal&quot;</span>            <span class="st">&quot;lib/regex.cabal&quot;</span></a>
<a class="sourceLine" id="cb1-72" title="72">  gen1  <span class="st">&quot;lib/cabal-masters/regex-with-pcre.cabal&quot;</span>  <span class="st">&quot;lib/regex-with-pcre.cabal&quot;</span></a>
<a class="sourceLine" id="cb1-73" title="73">  gen1  <span class="st">&quot;lib/cabal-masters/regex-examples.cabal&quot;</span>   <span class="st">&quot;lib/regex-examples.cabal&quot;</span></a>
<a class="sourceLine" id="cb1-74" title="74">  establish <span class="st">&quot;mega-regex&quot;</span> <span class="st">&quot;regex&quot;</span></a>
<a class="sourceLine" id="cb1-75" title="75"></a>
<a class="sourceLine" id="cb1-76" title="76"><span class="ot">gen1 ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-77" title="77">gen1 in_f out_f <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-78" title="78">    ctx <span class="ot">&lt;-</span> setup</a>
<a class="sourceLine" id="cb1-79" title="79">    LBS.writeFile out_f <span class="op">=&lt;&lt;</span></a>
<a class="sourceLine" id="cb1-80" title="80">      sed&#39; (gc_script ctx) <span class="op">=&lt;&lt;</span> substVersion_ <span class="op">=&lt;&lt;</span> include <span class="op">=&lt;&lt;</span></a>
<a class="sourceLine" id="cb1-81" title="81">        LBS.readFile in_f</a>
<a class="sourceLine" id="cb1-82" title="82"></a>
<a class="sourceLine" id="cb1-83" title="83"><span class="kw">data</span> <span class="dt">Ctx</span> <span class="ot">=</span></a>
<a class="sourceLine" id="cb1-84" title="84">  <span class="dt">Ctx</span></a>
<a class="sourceLine" id="cb1-85" title="85">    {<span class="ot"> _ctx_w_error             ::</span> <span class="dt">IORef</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-86" title="86">    ,<span class="ot"> _ctx_filter_pcre         ::</span> <span class="dt">IORef</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-87" title="87">    ,<span class="ot"> _ctx_package_constraints ::</span> <span class="dt">IORef</span> (<span class="dt">Map.Map</span> <span class="dt">LBS.ByteString</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb1-88" title="88">    ,<span class="ot"> _ctx_test_exe            ::</span> <span class="dt">IORef</span> (<span class="dt">Maybe</span> <span class="dt">TestExe</span>)</a>
<a class="sourceLine" id="cb1-89" title="89">    }</a>
<a class="sourceLine" id="cb1-90" title="90"></a>
<a class="sourceLine" id="cb1-91" title="91"><span class="kw">data</span> <span class="dt">TestExe</span> <span class="ot">=</span></a>
<a class="sourceLine" id="cb1-92" title="92">  <span class="dt">TestExe</span></a>
<a class="sourceLine" id="cb1-93" title="93">    {<span class="ot"> _te_test ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-94" title="94">    ,<span class="ot"> _te_exe  ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-95" title="95">    ,<span class="ot"> _te_name ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-96" title="96">    ,<span class="ot"> _te_text ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-97" title="97">    }</a>
<a class="sourceLine" id="cb1-98" title="98">  <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb1-99" title="99"></a>
<a class="sourceLine" id="cb1-100" title="100"><span class="ot">setup ::</span> <span class="dt">IO</span> <span class="dt">Ctx</span></a>
<a class="sourceLine" id="cb1-101" title="101">setup <span class="ot">=</span> <span class="dt">Ctx</span> <span class="op">&lt;$&gt;</span> (newIORef <span class="dt">True</span>) <span class="op">&lt;*&gt;</span> (newIORef <span class="dt">False</span>) <span class="op">&lt;*&gt;</span> (newIORef Map.empty) <span class="op">&lt;*&gt;</span> (newIORef <span class="dt">Nothing</span>)</a>
<a class="sourceLine" id="cb1-102" title="102"></a>
<a class="sourceLine" id="cb1-103" title="103"><span class="ot">gc_script ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">Edits</span> <span class="dt">IO</span> <span class="dt">RE</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-104" title="104">gc_script ctx <span class="ot">=</span> <span class="dt">Select</span></a>
<a class="sourceLine" id="cb1-105" title="105">    [ <span class="dt">LineEdit</span> [re|^%Werror$|]                            <span class="op">$</span> w_error_gen              ctx</a>
<a class="sourceLine" id="cb1-106" title="106">    , <span class="dt">LineEdit</span> [re|^%Wwarn$|]                             <span class="op">$</span> w_warn_gen               ctx</a>
<a class="sourceLine" id="cb1-107" title="107">    , <span class="dt">LineEdit</span> [re|^%filter-regex-with-pcre$|]            <span class="op">$</span> w_filter_pcre            ctx</a>
<a class="sourceLine" id="cb1-108" title="108">    , <span class="dt">LineEdit</span> [re|^%- +${pkg}(@{%id-}) +${cond}(.*)$|]   <span class="op">$</span> cond_gen                 ctx</a>
<a class="sourceLine" id="cb1-109" title="109">    , <span class="dt">LineEdit</span> [re|^%build-depends-${lb}(lib|prog) +${list}(@{%id-}( +@{%id-})*)$|]</a>
<a class="sourceLine" id="cb1-110" title="110">                                                          <span class="op">$</span> build_depends_gen        ctx</a>
<a class="sourceLine" id="cb1-111" title="111">    , <span class="dt">LineEdit</span> [re|^%test +${i}(@{%id-})$|]               <span class="op">$</span> test_exe_gen <span class="dt">True</span>  <span class="dt">False</span> ctx</a>
<a class="sourceLine" id="cb1-112" title="112">    , <span class="dt">LineEdit</span> [re|^%exe +${i}(@{%id-})$|]                <span class="op">$</span> test_exe_gen <span class="dt">False</span> <span class="dt">True</span>  ctx</a>
<a class="sourceLine" id="cb1-113" title="113">    , <span class="dt">LineEdit</span> [re|^%test-exe +${i}(@{%id-})$|]           <span class="op">$</span> test_exe_gen <span class="dt">True</span>  <span class="dt">True</span>  ctx</a>
<a class="sourceLine" id="cb1-114" title="114">    , <span class="dt">LineEdit</span> [re|^.*$|]                                 <span class="op">$</span> default_gen              ctx</a>
<a class="sourceLine" id="cb1-115" title="115">    ]</a>
<a class="sourceLine" id="cb1-116" title="116"></a>
<a class="sourceLine" id="cb1-117" title="117">w_error_gen, w_warn_gen, w_filter_pcre, cond_gen, build_depends_gen,</a>
<a class="sourceLine" id="cb1-118" title="118"><span class="ot">  default_gen ::</span> <span class="dt">Ctx</span></a>
<a class="sourceLine" id="cb1-119" title="119">              <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb1-120" title="120">              <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-121" title="121">              <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb1-122" title="122"></a>
<a class="sourceLine" id="cb1-123" title="123">w_error_gen   <span class="dt">Ctx</span>{<span class="op">..</span>} _ _ <span class="ot">=</span> writeIORef _ctx_w_error     <span class="dt">True</span>  <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="dt">Delete</span></a>
<a class="sourceLine" id="cb1-124" title="124">w_warn_gen    <span class="dt">Ctx</span>{<span class="op">..</span>} _ _ <span class="ot">=</span> writeIORef _ctx_w_error     <span class="dt">False</span> <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="dt">Delete</span></a>
<a class="sourceLine" id="cb1-125" title="125">w_filter_pcre <span class="dt">Ctx</span>{<span class="op">..</span>} _ _ <span class="ot">=</span> writeIORef _ctx_filter_pcre <span class="dt">True</span>  <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="dt">Delete</span></a>
<a class="sourceLine" id="cb1-126" title="126"></a>
<a class="sourceLine" id="cb1-127" title="127">cond_gen <span class="dt">Ctx</span>{<span class="op">..</span>} _ mtchs <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-128" title="128">    modifyIORef _ctx_package_constraints <span class="op">$</span> Map.insert pkg cond</a>
<a class="sourceLine" id="cb1-129" title="129">    <span class="fu">return</span> <span class="dt">Delete</span></a>
<a class="sourceLine" id="cb1-130" title="130">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-131" title="131">    pkg  <span class="ot">=</span> captureText [cp|pkg|]  mtch</a>
<a class="sourceLine" id="cb1-132" title="132">    cond <span class="ot">=</span> captureText [cp|cond|] mtch</a>
<a class="sourceLine" id="cb1-133" title="133"></a>
<a class="sourceLine" id="cb1-134" title="134">    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-135" title="135"></a>
<a class="sourceLine" id="cb1-136" title="136">build_depends_gen ctx<span class="op">@</span><span class="dt">Ctx</span>{<span class="op">..</span>} _ mtchs <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-137" title="137">    we <span class="ot">&lt;-</span> readIORef _ctx_w_error</a>
<a class="sourceLine" id="cb1-138" title="138">    fp <span class="ot">&lt;-</span> readIORef _ctx_filter_pcre</a>
<a class="sourceLine" id="cb1-139" title="139">    mp <span class="ot">&lt;-</span> readIORef _ctx_package_constraints</a>
<a class="sourceLine" id="cb1-140" title="140">    put ctx <span class="op">$</span> mk_build_depends lb we fp mp lst</a>
<a class="sourceLine" id="cb1-141" title="141">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-142" title="142">    lb   <span class="ot">=</span> captureText [cp|lb|] mtch <span class="op">==</span> <span class="st">&quot;lib&quot;</span></a>
<a class="sourceLine" id="cb1-143" title="143">    lst  <span class="ot">=</span> LBS.words <span class="op">$</span> captureText [cp|list|] mtch</a>
<a class="sourceLine" id="cb1-144" title="144">    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-145" title="145"></a>
<a class="sourceLine" id="cb1-146" title="146">default_gen ctx<span class="op">@</span><span class="dt">Ctx</span>{<span class="op">..</span>} _ mtchs <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-147" title="147">    mb <span class="ot">&lt;-</span> readIORef _ctx_test_exe</a>
<a class="sourceLine" id="cb1-148" title="148">    <span class="kw">case</span> mb <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-149" title="149">      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">ReplaceWith</span> ln</a>
<a class="sourceLine" id="cb1-150" title="150">      <span class="dt">Just</span> te <span class="ot">-&gt;</span> <span class="kw">case</span> <span class="fu">isSpace</span> <span class="op">$</span> LBS.head <span class="op">$</span> ln <span class="op">M.&lt;&gt;</span> <span class="st">&quot;\n&quot;</span> <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-151" title="151">        <span class="dt">True</span>  <span class="ot">-&gt;</span> put ctx ln</a>
<a class="sourceLine" id="cb1-152" title="152">        <span class="dt">False</span> <span class="ot">-&gt;</span> adjust_le (<span class="op">M.&lt;&gt;</span>ln) <span class="op">&lt;$&gt;</span> close_test_exe ctx te</a>
<a class="sourceLine" id="cb1-153" title="153">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-154" title="154">    ln   <span class="ot">=</span> matchSource mtch</a>
<a class="sourceLine" id="cb1-155" title="155">    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-156" title="156"></a>
<a class="sourceLine" id="cb1-157" title="157"><span class="ot">test_exe_gen ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-158" title="158">             <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-159" title="159">             <span class="ot">-&gt;</span> <span class="dt">Ctx</span></a>
<a class="sourceLine" id="cb1-160" title="160">             <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb1-161" title="161">             <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-162" title="162">             <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb1-163" title="163">test_exe_gen is_t is_e ctx _ mtchs <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-164" title="164">    mb <span class="ot">&lt;-</span> readIORef  (_ctx_test_exe ctx)</a>
<a class="sourceLine" id="cb1-165" title="165">    le <span class="ot">&lt;-</span> <span class="fu">maybe</span> (<span class="fu">return</span> <span class="dt">Delete</span>) (close_test_exe ctx) mb</a>
<a class="sourceLine" id="cb1-166" title="166">    writeIORef (_ctx_test_exe ctx) <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span></a>
<a class="sourceLine" id="cb1-167" title="167">      <span class="dt">TestExe</span></a>
<a class="sourceLine" id="cb1-168" title="168">        { _te_test <span class="ot">=</span> is_t</a>
<a class="sourceLine" id="cb1-169" title="169">        , _te_exe  <span class="ot">=</span> is_e</a>
<a class="sourceLine" id="cb1-170" title="170">        , _te_name <span class="ot">=</span> i</a>
<a class="sourceLine" id="cb1-171" title="171">        , _te_text <span class="ot">=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-172" title="172">        }</a>
<a class="sourceLine" id="cb1-173" title="173">    <span class="fu">return</span> le</a>
<a class="sourceLine" id="cb1-174" title="174">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-175" title="175">    i    <span class="ot">=</span> captureText [cp|i|] mtch</a>
<a class="sourceLine" id="cb1-176" title="176"></a>
<a class="sourceLine" id="cb1-177" title="177">    mtch <span class="ot">=</span> allMatches mtchs <span class="op">!!</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-178" title="178"></a>
<a class="sourceLine" id="cb1-179" title="179"><span class="ot">close_test_exe ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">TestExe</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb1-180" title="180">close_test_exe ctx<span class="op">@</span><span class="dt">Ctx</span>{<span class="op">..</span>} te <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-181" title="181">  writeIORef _ctx_test_exe <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb1-182" title="182">  put ctx <span class="op">$</span> <span class="fu">mconcat</span> <span class="op">$</span> <span class="fu">concat</span> <span class="op">$</span></a>
<a class="sourceLine" id="cb1-183" title="183">    [ [ mk_test_exe <span class="dt">False</span> te <span class="st">&quot;Executable&quot;</span> <span class="op">|</span> _te_exe  te ]</a>
<a class="sourceLine" id="cb1-184" title="184">    , [ mk_test_exe <span class="dt">True</span>  te <span class="st">&quot;Test-Suite&quot;</span> <span class="op">|</span> _te_test te ]</a>
<a class="sourceLine" id="cb1-185" title="185">    ]</a>
<a class="sourceLine" id="cb1-186" title="186"></a>
<a class="sourceLine" id="cb1-187" title="187"><span class="ot">put ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb1-188" title="188">put <span class="dt">Ctx</span>{<span class="op">..</span>} lbs <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-189" title="189">    mb <span class="ot">&lt;-</span> readIORef _ctx_test_exe</a>
<a class="sourceLine" id="cb1-190" title="190">    <span class="kw">case</span> mb <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-191" title="191">      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">ReplaceWith</span> lbs</a>
<a class="sourceLine" id="cb1-192" title="192">      <span class="dt">Just</span> te <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-193" title="193">        writeIORef _ctx_test_exe <span class="op">$</span> <span class="dt">Just</span> te { _te_text <span class="ot">=</span> _te_text te <span class="op">M.&lt;&gt;</span> lbs <span class="op">M.&lt;&gt;</span> <span class="st">&quot;\n&quot;</span> }</a>
<a class="sourceLine" id="cb1-194" title="194">        <span class="fu">return</span> <span class="dt">Delete</span></a>
<a class="sourceLine" id="cb1-195" title="195"></a>
<a class="sourceLine" id="cb1-196" title="196"><span class="ot">mk_test_exe ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">TestExe</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-197" title="197">mk_test_exe is_t te te_lbs_kw <span class="ot">=</span> (<span class="op">M.&lt;&gt;</span> _te_text te) <span class="op">$</span> LBS.unlines <span class="op">$</span> <span class="fu">concat</span></a>
<a class="sourceLine" id="cb1-198" title="198">    [ [ LBS.pack <span class="op">$</span> printf <span class="st">&quot;%s %s&quot;</span> (LBS.unpack te_lbs_kw) nm ]</a>
<a class="sourceLine" id="cb1-199" title="199">    , [ <span class="st">&quot;    type:               exitcode-stdio-1.0&quot;</span> <span class="op">|</span> is_t ]</a>
<a class="sourceLine" id="cb1-200" title="200">    ]</a>
<a class="sourceLine" id="cb1-201" title="201">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-202" title="202">    nm <span class="ot">=</span> <span class="kw">case</span> is_t <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-203" title="203">      <span class="dt">True</span>  <span class="ot">-&gt;</span> LBS.unpack <span class="op">$</span> _te_name te <span class="op">M.&lt;&gt;</span> <span class="st">&quot;-test&quot;</span></a>
<a class="sourceLine" id="cb1-204" title="204">      <span class="dt">False</span> <span class="ot">-&gt;</span> LBS.unpack <span class="op">$</span> _te_name te</a>
<a class="sourceLine" id="cb1-205" title="205"></a>
<a class="sourceLine" id="cb1-206" title="206"><span class="ot">mk_build_depends ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-207" title="207">                 <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-208" title="208">                 <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-209" title="209">                 <span class="ot">-&gt;</span> <span class="dt">Map.Map</span> <span class="dt">LBS.ByteString</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-210" title="210">                 <span class="ot">-&gt;</span> [<span class="dt">LBS.ByteString</span>]</a>
<a class="sourceLine" id="cb1-211" title="211">                 <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-212" title="212">mk_build_depends lb we fp mp pks0 <span class="ot">=</span> LBS.unlines <span class="op">$</span></a>
<a class="sourceLine" id="cb1-213" title="213">        [ <span class="st">&quot;    Default-Language:   Haskell2010&quot;</span></a>
<a class="sourceLine" id="cb1-214" title="214">        , <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-215" title="215">        ] <span class="op">++</span> <span class="fu">filter</span> (<span class="kw">if</span> lb <span class="kw">then</span> <span class="fu">const</span> <span class="dt">True</span> <span class="kw">else</span> <span class="fu">const</span> <span class="dt">False</span>)</a>
<a class="sourceLine" id="cb1-216" title="216">        [ <span class="st">&quot;    Other-Extensions:&quot;</span></a>
<a class="sourceLine" id="cb1-217" title="217">        , <span class="st">&quot;      AllowAmbiguousTypes&quot;</span></a>
<a class="sourceLine" id="cb1-218" title="218">        , <span class="st">&quot;      CPP&quot;</span></a>
<a class="sourceLine" id="cb1-219" title="219">        , <span class="st">&quot;      DeriveDataTypeable&quot;</span></a>
<a class="sourceLine" id="cb1-220" title="220">        , <span class="st">&quot;      DeriveGeneric&quot;</span></a>
<a class="sourceLine" id="cb1-221" title="221">        , <span class="st">&quot;      ExistentialQuantification&quot;</span></a>
<a class="sourceLine" id="cb1-222" title="222">        , <span class="st">&quot;      FlexibleContexts&quot;</span></a>
<a class="sourceLine" id="cb1-223" title="223">        , <span class="st">&quot;      FlexibleInstances&quot;</span></a>
<a class="sourceLine" id="cb1-224" title="224">        , <span class="st">&quot;      FunctionalDependencies&quot;</span></a>
<a class="sourceLine" id="cb1-225" title="225">        , <span class="st">&quot;      GeneralizedNewtypeDeriving&quot;</span></a>
<a class="sourceLine" id="cb1-226" title="226">        , <span class="st">&quot;      MultiParamTypeClasses&quot;</span></a>
<a class="sourceLine" id="cb1-227" title="227">        , <span class="st">&quot;      NoImplicitPrelude&quot;</span></a>
<a class="sourceLine" id="cb1-228" title="228">        , <span class="st">&quot;      OverloadedStrings&quot;</span></a>
<a class="sourceLine" id="cb1-229" title="229">        , <span class="st">&quot;      QuasiQuotes&quot;</span></a>
<a class="sourceLine" id="cb1-230" title="230">        , <span class="st">&quot;      RecordWildCards&quot;</span></a>
<a class="sourceLine" id="cb1-231" title="231">        , <span class="st">&quot;      ScopedTypeVariables&quot;</span></a>
<a class="sourceLine" id="cb1-232" title="232">        , <span class="st">&quot;      TemplateHaskell&quot;</span></a>
<a class="sourceLine" id="cb1-233" title="233">        , <span class="st">&quot;      TypeSynonymInstances&quot;</span></a>
<a class="sourceLine" id="cb1-234" title="234">        , <span class="st">&quot;      UndecidableInstances&quot;</span></a>
<a class="sourceLine" id="cb1-235" title="235">        , <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-236" title="236">        , <span class="st">&quot;    if !impl(ghc &gt;= 8.0)&quot;</span></a>
<a class="sourceLine" id="cb1-237" title="237">        , <span class="st">&quot;      Other-Extensions: TemplateHaskell&quot;</span></a>
<a class="sourceLine" id="cb1-238" title="238">        , <span class="st">&quot;    else&quot;</span></a>
<a class="sourceLine" id="cb1-239" title="239">        , <span class="st">&quot;      Other-Extensions: TemplateHaskellQuotes&quot;</span></a>
<a class="sourceLine" id="cb1-240" title="240">        , <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-241" title="241">        ] <span class="op">++</span></a>
<a class="sourceLine" id="cb1-242" title="242">        [ <span class="st">&quot;    GHC-Options:&quot;</span></a>
<a class="sourceLine" id="cb1-243" title="243">        , <span class="st">&quot;      -Wall&quot;</span></a>
<a class="sourceLine" id="cb1-244" title="244">        , <span class="st">&quot;      -fwarn-tabs&quot;</span></a>
<a class="sourceLine" id="cb1-245" title="245">        , <span class="st">&quot;      &quot;</span> <span class="op">M.&lt;&gt;</span> w_error_or_warn</a>
<a class="sourceLine" id="cb1-246" title="246">        , <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-247" title="247">        , <span class="st">&quot;    Build-depends:&quot;</span></a>
<a class="sourceLine" id="cb1-248" title="248">        ] <span class="op">++</span> (<span class="fu">map</span> fmt <span class="op">$</span> <span class="fu">zip</span> (<span class="dt">True</span> <span class="op">:</span> <span class="fu">repeat</span> <span class="dt">False</span>) <span class="op">$</span> L.sortBy comp pks)</a>
<a class="sourceLine" id="cb1-249" title="249">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-250" title="250">    w_error_or_warn <span class="ot">=</span> <span class="kw">case</span> we <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-251" title="251">      <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="st">&quot;-Werror&quot;</span></a>
<a class="sourceLine" id="cb1-252" title="252">      <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="st">&quot;-Wwarn&quot;</span></a>
<a class="sourceLine" id="cb1-253" title="253"></a>
<a class="sourceLine" id="cb1-254" title="254">    pks <span class="ot">=</span> <span class="kw">case</span> fp <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-255" title="255">      <span class="dt">False</span> <span class="ot">-&gt;</span> pks0</a>
<a class="sourceLine" id="cb1-256" title="256">      <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="fu">filter</span> (<span class="op">/=</span> <span class="st">&quot;regex-with-pcre&quot;</span>) pks0</a>
<a class="sourceLine" id="cb1-257" title="257"></a>
<a class="sourceLine" id="cb1-258" title="258">    fmt (isf,pk) <span class="ot">=</span> LBS.pack <span class="op">$</span></a>
<a class="sourceLine" id="cb1-259" title="259">      printf <span class="st">&quot;      %c %-20s %s&quot;</span></a>
<a class="sourceLine" id="cb1-260" title="260">        (<span class="kw">if</span> isf <span class="kw">then</span> <span class="ch">&#39; &#39;</span> <span class="kw">else</span> <span class="ch">&#39;,&#39;</span>)</a>
<a class="sourceLine" id="cb1-261" title="261">        (LBS.unpack pk)</a>
<a class="sourceLine" id="cb1-262" title="262">        (<span class="fu">maybe</span> <span class="st">&quot;&quot;</span> LBS.unpack <span class="op">$</span> Map.lookup pk mp)</a>
<a class="sourceLine" id="cb1-263" title="263"></a>
<a class="sourceLine" id="cb1-264" title="264">    comp x y <span class="ot">=</span> <span class="kw">case</span> (x<span class="op">==</span><span class="st">&quot;regex&quot;</span>,y<span class="op">==</span><span class="st">&quot;regex&quot;</span>) <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-265" title="265">      (<span class="dt">True</span> ,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">EQ</span></a>
<a class="sourceLine" id="cb1-266" title="266">      (<span class="dt">True</span> ,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="dt">LT</span></a>
<a class="sourceLine" id="cb1-267" title="267">      (<span class="dt">False</span>,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">GT</span></a>
<a class="sourceLine" id="cb1-268" title="268">      (<span class="dt">False</span>,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="kw">case</span> (x<span class="op">==</span><span class="st">&quot;regex-with-pcre&quot;</span>,y<span class="op">==</span><span class="st">&quot;regex-with-pcre&quot;</span>) <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-269" title="269">        (<span class="dt">True</span> ,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">EQ</span></a>
<a class="sourceLine" id="cb1-270" title="270">        (<span class="dt">True</span> ,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="dt">LT</span></a>
<a class="sourceLine" id="cb1-271" title="271">        (<span class="dt">False</span>,<span class="dt">True</span> ) <span class="ot">-&gt;</span> <span class="dt">GT</span></a>
<a class="sourceLine" id="cb1-272" title="272">        (<span class="dt">False</span>,<span class="dt">False</span>) <span class="ot">-&gt;</span> <span class="fu">compare</span> x y</a>
<a class="sourceLine" id="cb1-273" title="273"></a>
<a class="sourceLine" id="cb1-274" title="274"><span class="ot">adjust_le ::</span> (<span class="dt">LBS.ByteString</span><span class="ot">-&gt;</span><span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb1-275" title="275">          <span class="ot">-&gt;</span> <span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-276" title="276">          <span class="ot">-&gt;</span> <span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb1-277" title="277">adjust_le f le <span class="ot">=</span> <span class="kw">case</span> le <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-278" title="278">  <span class="dt">NoEdit</span>          <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;adjust_le: not enough context&quot;</span></a>
<a class="sourceLine" id="cb1-279" title="279">  <span class="dt">ReplaceWith</span> lbs <span class="ot">-&gt;</span> <span class="dt">ReplaceWith</span> <span class="op">$</span> f lbs</a>
<a class="sourceLine" id="cb1-280" title="280">  <span class="dt">Delete</span>          <span class="ot">-&gt;</span> <span class="dt">ReplaceWith</span> <span class="op">$</span> f <span class="st">&quot;&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="ot">sdist ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-2" title="2">sdist <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-3" title="3">  createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></a>
<a class="sourceLine" id="cb2-4" title="4">  sdist&#39;    <span class="st">&quot;regex&quot;</span>            <span class="st">&quot;lib/README-regex.md&quot;</span></a>
<a class="sourceLine" id="cb2-5" title="5">  sdist&#39;    <span class="st">&quot;regex-with-pcre&quot;</span>  <span class="st">&quot;lib/README-regex.md&quot;</span></a>
<a class="sourceLine" id="cb2-6" title="6">  sdist&#39;    <span class="st">&quot;regex-examples&quot;</span>   <span class="st">&quot;lib/README-regex-examples.md&quot;</span></a>
<a class="sourceLine" id="cb2-7" title="7">  establish <span class="st">&quot;mega-regex&quot;</span> <span class="st">&quot;regex&quot;</span></a>
<a class="sourceLine" id="cb2-8" title="8">  vrn <span class="ot">&lt;-</span> readCurrentVersion</a>
<a class="sourceLine" id="cb2-9" title="9">  <span class="kw">let</span> vrn_t <span class="ot">=</span> T.pack <span class="op">$</span> presentVrn vrn</a>
<a class="sourceLine" id="cb2-10" title="10">  test_release vrn_t</a>
<a class="sourceLine" id="cb2-11" title="11">  smy_t <span class="ot">&lt;-</span> summary vrn</a>
<a class="sourceLine" id="cb2-12" title="12">  commit_message_ <span class="st">&quot;tmp/commit.txt&quot;</span> vrn smy_t</a>
<a class="sourceLine" id="cb2-13" title="13">  SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-14" title="14">    SH.run_ <span class="st">&quot;git&quot;</span> [<span class="st">&quot;add&quot;</span>,<span class="st">&quot;--all&quot;</span>]</a>
<a class="sourceLine" id="cb2-15" title="15">    SH.run_ <span class="st">&quot;git&quot;</span> [<span class="st">&quot;commit&quot;</span>,<span class="st">&quot;-F&quot;</span>,<span class="st">&quot;tmp/commit.txt&quot;</span>]</a>
<a class="sourceLine" id="cb2-16" title="16">    SH.run_ <span class="st">&quot;git&quot;</span> [<span class="st">&quot;tag&quot;</span>,vrn_t,<span class="st">&quot;-m&quot;</span>,smy_t]</a>
<a class="sourceLine" id="cb2-17" title="17"></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="ot">sdist&#39; ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">SH.FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-19" title="19">sdist&#39; nm readme <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-20" title="20">  establish nm nm</a>
<a class="sourceLine" id="cb2-21" title="21">  SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-22" title="22">    SH.cp readme <span class="st">&quot;README.markdown&quot;</span></a>
<a class="sourceLine" id="cb2-23" title="23">    SH.run_ <span class="st">&quot;stack&quot;</span> [<span class="st">&quot;sdist&quot;</span>,<span class="st">&quot;--stack-yaml&quot;</span>,<span class="st">&quot;stack-8.0.yaml&quot;</span>]</a>
<a class="sourceLine" id="cb2-24" title="24">    (pth,tb) <span class="ot">&lt;-</span> analyse_so <span class="op">&lt;$&gt;</span> SH.lastStderr</a>
<a class="sourceLine" id="cb2-25" title="25">    SH.cp (SH.fromText <span class="op">$</span> pth) <span class="op">$</span> SH.fromText <span class="op">$</span> <span class="st">&quot;releases/&quot;</span> <span class="op">M.&lt;&gt;</span> tb</a>
<a class="sourceLine" id="cb2-26" title="26">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-27" title="27">    analyse_so so <span class="ot">=</span> (mtch<span class="op">!$$</span>[cp|pth|],mtch<span class="op">!$$</span>[cp|tb|])</a>
<a class="sourceLine" id="cb2-28" title="28">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-29" title="29">        mtch <span class="ot">=</span> so <span class="op">T.?=~</span></a>
<a class="sourceLine" id="cb2-30" title="30">          [re|^.*Wrote sdist tarball to ${pth}(.*${tb}(regex-.*\.tar\.gz))$|]</a>
<a class="sourceLine" id="cb2-31" title="31"></a>
<a class="sourceLine" id="cb2-32" title="32"><span class="ot">establish ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-33" title="33">establish nm nm&#39; <span class="ot">=</span> SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-34" title="34">    SH.rm_f <span class="st">&quot;mega-regex.cabal&quot;</span></a>
<a class="sourceLine" id="cb2-35" title="35">    SH.rm_f <span class="st">&quot;regex-with-pcre.cabal&quot;</span></a>
<a class="sourceLine" id="cb2-36" title="36">    SH.rm_f <span class="st">&quot;regex.cabal&quot;</span></a>
<a class="sourceLine" id="cb2-37" title="37">    SH.rm_f <span class="st">&quot;regex-examples.cabal&quot;</span></a>
<a class="sourceLine" id="cb2-38" title="38">    SH.cp (SH.fromText sf) (SH.fromText df)</a>
<a class="sourceLine" id="cb2-39" title="39">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-40" title="40">    sf <span class="ot">=</span> <span class="st">&quot;lib/&quot;</span> <span class="op">M.&lt;&gt;</span> nm <span class="op">M.&lt;&gt;</span> <span class="st">&quot;.cabal&quot;</span></a>
<a class="sourceLine" id="cb2-41" title="41">    df <span class="ot">=</span> nm&#39; <span class="op">M.&lt;&gt;</span> <span class="st">&quot;.cabal&quot;</span></a>
<a class="sourceLine" id="cb2-42" title="42"></a>
<a class="sourceLine" id="cb2-43" title="43"><span class="ot">test_release ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-44" title="44">test_release vrn_t <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-45" title="45">    setCurrentDirectory <span class="st">&quot;releases&quot;</span></a>
<a class="sourceLine" id="cb2-46" title="46">    SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-47" title="47">      SH.rm_rf <span class="st">&quot;test-regex-examples&quot;</span></a>
<a class="sourceLine" id="cb2-48" title="48">      unpack <span class="st">&quot;.&quot;</span> <span class="st">&quot;regex-examples&quot;</span></a>
<a class="sourceLine" id="cb2-49" title="49">    setCurrentDirectory <span class="st">&quot;test-regex-examples&quot;</span></a>
<a class="sourceLine" id="cb2-50" title="50">    SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-51" title="51">      unpack <span class="st">&quot;..&quot;</span> <span class="st">&quot;regex&quot;</span></a>
<a class="sourceLine" id="cb2-52" title="52">      unpack <span class="st">&quot;..&quot;</span> <span class="st">&quot;regex-with-pcre&quot;</span></a>
<a class="sourceLine" id="cb2-53" title="53">      SH.cp <span class="st">&quot;../../lib/release-testing/stack.yaml&quot;</span> <span class="st">&quot;.&quot;</span></a>
<a class="sourceLine" id="cb2-54" title="54">      SH.run_ <span class="st">&quot;stack&quot;</span> [<span class="st">&quot;--no-terminal&quot;</span>,<span class="st">&quot;test&quot;</span>, <span class="st">&quot;--haddock&quot;</span>, <span class="st">&quot;--no-haddock-deps&quot;</span>]</a>
<a class="sourceLine" id="cb2-55" title="55">    setCurrentDirectory <span class="st">&quot;../..&quot;</span></a>
<a class="sourceLine" id="cb2-56" title="56">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-57" title="57">    unpack rp pn <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-58" title="58">        SH.run_ <span class="st">&quot;tar&quot;</span> [<span class="st">&quot;xzf&quot;</span>,rp <span class="op">M.&lt;&gt;</span> <span class="st">&quot;/&quot;</span> <span class="op">M.&lt;&gt;</span> pn_vrn <span class="op">M.&lt;&gt;</span> <span class="st">&quot;.tar.gz&quot;</span>]</a>
<a class="sourceLine" id="cb2-59" title="59">        SH.mv (SH.fromText pn_vrn) (SH.fromText <span class="op">$</span> <span class="st">&quot;test-&quot;</span> <span class="op">M.&lt;&gt;</span> pn)</a>
<a class="sourceLine" id="cb2-60" title="60">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-61" title="61">        pn_vrn <span class="ot">=</span> pn <span class="op">M.&lt;&gt;</span> <span class="st">&quot;-&quot;</span> <span class="op">M.&lt;&gt;</span> vrn_t</a></code></pre></div>
<h2 id="building-the-release-commit-message-from-the-changelog">Building the Release Commit Message from the Changelog</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="ot">commit_message ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-2" title="2">commit_message <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-3" title="3">  createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></a>
<a class="sourceLine" id="cb3-4" title="4">  vrn   <span class="ot">&lt;-</span> readCurrentVersion</a>
<a class="sourceLine" id="cb3-5" title="5">  smy_t <span class="ot">&lt;-</span> summary vrn</a>
<a class="sourceLine" id="cb3-6" title="6">  commit_message_ <span class="st">&quot;tmp/commit.txt&quot;</span> vrn smy_t</a>
<a class="sourceLine" id="cb3-7" title="7">  LBS.readFile <span class="st">&quot;tmp/commit.txt&quot;</span> <span class="op">&gt;&gt;=</span> LBS.putStrLn</a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="ot">commit_message_ ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Vrn</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-10" title="10">commit_message_ fp vrn<span class="op">@</span><span class="dt">Vrn</span>{<span class="op">..</span>} smy_t <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-11" title="11">    rex <span class="ot">&lt;-</span> escape (<span class="st">&quot;^&quot;</span><span class="op">++</span>) vrn_s</a>
<a class="sourceLine" id="cb3-12" title="12">    parse_commit smy_ln <span class="op">&lt;$&gt;</span> grepLines rex <span class="st">&quot;changelog&quot;</span> <span class="op">&gt;&gt;=</span> LBS.writeFile fp</a>
<a class="sourceLine" id="cb3-13" title="13">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-14" title="14">    smy_ln <span class="ot">=</span> vrn_s <span class="op">++</span> <span class="st">&quot;: &quot;</span> <span class="op">++</span> T.unpack smy_t</a>
<a class="sourceLine" id="cb3-15" title="15">    vrn_s  <span class="ot">=</span> presentVrn vrn</a>
<a class="sourceLine" id="cb3-16" title="16"></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="ot">parse_commit ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Line</span> <span class="dt">LBS.ByteString</span>] <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb3-18" title="18">parse_commit hdr lns0 <span class="ot">=</span> <span class="kw">case</span> lns0 <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-19" title="19">    _<span class="op">:</span>_<span class="op">:</span>ln<span class="op">:</span>lns <span class="op">|</span> anyMatches <span class="op">$</span> getLineMatches ln</a>
<a class="sourceLine" id="cb3-20" title="20">      <span class="ot">-&gt;</span> LBS.unlines <span class="op">$</span> LBS.pack hdr <span class="op">:</span> <span class="fu">map</span> fixes (<span class="fu">takeWhile</span> is_bullet lns)</a>
<a class="sourceLine" id="cb3-21" title="21">    _ <span class="ot">-&gt;</span> <span class="fu">error</span> oops</a>
<a class="sourceLine" id="cb3-22" title="22">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-23" title="23">    is_bullet <span class="dt">Line</span>{<span class="op">..</span>} <span class="ot">=</span></a>
<a class="sourceLine" id="cb3-24" title="24">        LBS.take <span class="dv">4</span> (matchesSource getLineMatches) <span class="op">==</span> <span class="st">&quot;  * &quot;</span></a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26">    fixes <span class="dt">Line</span>{<span class="op">..</span>} <span class="ot">=</span></a>
<a class="sourceLine" id="cb3-27" title="27">        matchesSource getLineMatches <span class="op">*=~/</span> [ed|#${n}([0-9]+)///fixes #${n}|]</a>
<a class="sourceLine" id="cb3-28" title="28"></a>
<a class="sourceLine" id="cb3-29" title="29">    oops <span class="ot">=</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb3-30" title="30">      [ <span class="st">&quot;failed to parse changelog&quot;</span></a>
<a class="sourceLine" id="cb3-31" title="31">      , <span class="st">&quot;(expected line 3 to start with the current version)&quot;</span></a>
<a class="sourceLine" id="cb3-32" title="32">      ]</a></code></pre></div>
<h2 id="extracting-the-summary-from-the-roadmap">Extracting the summary from the Roadmap</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="ot">summary ::</span> <span class="dt">Vrn</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">T.Text</span></a>
<a class="sourceLine" id="cb4-2" title="2">summary vrn <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="kw">let</span> vrn_res <span class="ot">=</span> <span class="fu">concat</span></a>
<a class="sourceLine" id="cb4-4" title="4">        [ <span class="fu">show</span> <span class="op">$</span> _vrn_a vrn</a>
<a class="sourceLine" id="cb4-5" title="5">        , <span class="st">&quot;\\.&quot;</span></a>
<a class="sourceLine" id="cb4-6" title="6">        , <span class="fu">show</span> <span class="op">$</span> _vrn_b vrn</a>
<a class="sourceLine" id="cb4-7" title="7">        , <span class="st">&quot;\\.&quot;</span></a>
<a class="sourceLine" id="cb4-8" title="8">        , <span class="fu">show</span> <span class="op">$</span> _vrn_c vrn</a>
<a class="sourceLine" id="cb4-9" title="9">        , <span class="st">&quot;\\.&quot;</span></a>
<a class="sourceLine" id="cb4-10" title="10">        , <span class="fu">show</span> <span class="op">$</span> _vrn_d vrn</a>
<a class="sourceLine" id="cb4-11" title="11">        ]</a>
<a class="sourceLine" id="cb4-12" title="12">  rex <span class="ot">&lt;-</span> compileRegex <span class="op">$</span> <span class="st">&quot;- \\[[xX]\\] +@{%date} +v&quot;</span><span class="op">++</span>vrn_res<span class="op">++</span><span class="st">&quot; +\\[?${smy}([^]]+)&quot;</span></a>
<a class="sourceLine" id="cb4-13" title="13">  lns <span class="ot">&lt;-</span> linesMatched <span class="dt">LinesMatched</span> <span class="op">&lt;$&gt;</span> grepLines rex <span class="st">&quot;lib/md/roadmap-incl.md&quot;</span></a>
<a class="sourceLine" id="cb4-14" title="14">  <span class="kw">case</span> lns <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-15" title="15">    [<span class="dt">Line</span> _ (<span class="dt">Matches</span> _ [mtch])] <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> TE.decodeUtf8 <span class="op">$</span> LBS.toStrict <span class="op">$</span> mtch <span class="op">!$$</span> [cp|smy|]</a>
<a class="sourceLine" id="cb4-16" title="16">    _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;failed to locate the summary text in the roadmap&quot;</span></a></code></pre></div>
</div>    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-92650418-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>
