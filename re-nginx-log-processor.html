<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>regex â€“ examples/re-nginx-log-processor.lhs</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="lib/lhs-styles.css" />
  <link rel="stylesheet" href="lib/bs.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/>
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="mask-icon" href="/safari-pinned-tab.svg"/>
  <meta name="theme-color" content="#ffffff"/>
</head>
<body>
<div class='bcdiv'>
  <ol class='breadcrumb'>
    <li><a href="." style="font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;" id="branding">[<span style='color:red;'>re</span>|${<span style='color:red;'>gex</span>}(.*)|<span></span>]</a></li>
    <li><a title='source file' href='https://github.com/iconnect/regex/blob/master/examples/re-nginx-log-processor.lhs'>examples/re-nginx-log-processor.lhs</a></li>
</ol>
</div>
<div class='litcontent'>
<header id="title-block-header">
<h1 class="title">examples/re-nginx-log-processor.lhs</h1>
</header>
<h1 id="example-nginx-log-processor">Example: NGINX Log Processor</h1>
<p>This example program reads lines from NGINX error-log files and access-log files converts them into a unified output format.</p>
<p>It is an example of developing REs at scale using macros with the regex test bench.</p>
<p>The tool is self-testing: run it with no arguments (or <code>cabal test</code>).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude          #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="ot">{-# LANGUAGE RecordWildCards            #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Main</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>  ( main</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>  <span class="co">-- development</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>  , parse_a</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>  , parse_e</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>  ) <span class="kw">where</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Control.Applicative</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Control.Monad</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span>               <span class="kw">as</span> <span class="dt">LBS</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Char</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Functor.Identity</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.HashMap.Lazy</span>                        <span class="kw">as</span> <span class="dt">HML</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Maybe</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.String</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span>                                <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Time</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Prelude.Compat</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Directory</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Environment</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Exit</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.FilePath</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.IO</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">TestKit</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.Printf</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.RE.PCRE</span>                             <span class="kw">as</span> <span class="dt">PCRE</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.PCRE.ByteString.Lazy</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.RE.PCRE.String</span>                      <span class="kw">as</span> <span class="dt">S</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.REOptions</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Replace</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.TestBench</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Sed</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  as  <span class="ot">&lt;-</span> getArgs</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  <span class="kw">case</span> as <span class="kw">of</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    [<span class="st">&quot;--macro&quot;</span>      ] <span class="ot">-&gt;</span> <span class="fu">putStr</span>      lp_macro_table</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    [<span class="st">&quot;--macro&quot;</span>,mid_s] <span class="ot">-&gt;</span> <span class="fu">putStrLn</span>  <span class="op">$</span> lp_macro_summary <span class="op">$</span> <span class="dt">MacroID</span> mid_s</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>    [<span class="st">&quot;--regex&quot;</span>      ] <span class="ot">-&gt;</span> <span class="fu">putStr</span>      lp_macro_sources</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>    [<span class="st">&quot;--regex&quot;</span>,mid_s] <span class="ot">-&gt;</span> <span class="fu">putStrLn</span>  <span class="op">$</span> lp_macro_source  <span class="op">$</span> <span class="dt">MacroID</span> mid_s</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    [<span class="st">&quot;--test&quot;</span>       ] <span class="ot">-&gt;</span> test</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>    []                <span class="ot">-&gt;</span> test</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    [in_file          ] <span class="op">|</span> is_file in_file <span class="ot">-&gt;</span> go <span class="dt">True</span>  in_file <span class="st">&quot;-&quot;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>    [in_file,out_file ] <span class="op">|</span> is_file in_file <span class="ot">-&gt;</span> go <span class="dt">True</span>  in_file out_file</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>    _                                     <span class="ot">-&gt;</span> usage</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>    is_file <span class="ot">=</span> <span class="fu">not</span> <span class="op">.</span> (<span class="op">==</span> <span class="st">&quot;--&quot;</span>) <span class="op">.</span> <span class="fu">take</span> <span class="dv">2</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>    usage <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a>      pnm <span class="ot">&lt;-</span> getProgName</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>      <span class="kw">let</span> prg <span class="ot">=</span> ((pnm<span class="op">++</span><span class="st">&quot; &quot;</span>)<span class="op">++</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>      <span class="fu">putStr</span> <span class="op">$</span> <span class="fu">unlines</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>        [ <span class="st">&quot;usage:&quot;</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>        , prg <span class="st">&quot; --help&quot;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>        , prg <span class="st">&quot; --macro&quot;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>        , prg <span class="st">&quot; --macro &lt;macro-id&gt;&quot;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>        , prg <span class="st">&quot; --regex&quot;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>        , prg <span class="st">&quot; --regex &lt;macro-id&gt;&quot;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a>        , prg <span class="st">&quot;[--test]&quot;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true"></a>        , prg <span class="st">&quot;(-|&lt;in-file&gt;) [-|&lt;out-file&gt;]&quot;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true"></a>        ]</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="co">-- go</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="ot">test ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>test <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;============================================================&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;Testing the macro environment.&quot;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;nginx-log-processor&quot;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>    is_docs <span class="ot">&lt;-</span> doesDirectoryExist <span class="st">&quot;docs&quot;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>    when is_docs <span class="op">$</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>      dumpMacroTable  (fp <span class="st">&quot;docs&quot;</span> <span class="st">&quot;.txt&quot;</span>) (fp <span class="st">&quot;docs&quot;</span> <span class="st">&quot;-src.txt&quot;</span>) regexType lp_env</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    dumpMacroTable    (fp <span class="st">&quot;data&quot;</span> <span class="st">&quot;.txt&quot;</span>) (fp <span class="st">&quot;data&quot;</span> <span class="st">&quot;-src.txt&quot;</span>) regexType lp_env</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>    me_ok <span class="ot">&lt;-</span> testMacroEnv <span class="st">&quot;nginx-log-processor&quot;</span> regexType lp_env</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;============================================================&quot;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;Testing the log processor on reference data.&quot;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>    lp_ok <span class="ot">&lt;-</span> test_log_processor</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;============================================================&quot;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>    <span class="kw">case</span> me_ok <span class="op">&amp;&amp;</span> lp_ok <span class="kw">of</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>      <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>      <span class="dt">False</span> <span class="ot">-&gt;</span> exitWith <span class="op">$</span> <span class="dt">ExitFailure</span> <span class="dv">1</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>    fp dir sfx <span class="ot">=</span> dir <span class="op">&lt;/&gt;</span> (rty_s <span class="op">++</span> <span class="st">&quot;-nginx-log-processor&quot;</span> <span class="op">++</span> sfx)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>    rty_s      <span class="ot">=</span> <span class="fu">map</span> <span class="fu">toLower</span> <span class="op">$</span> presentRegexType regexType</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a><span class="ot">test_log_processor ::</span> <span class="dt">IO</span> <span class="dt">Bool</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a>test_log_processor <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a>    createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a>    go <span class="dt">False</span> <span class="st">&quot;data/access-errors.log&quot;</span> <span class="st">&quot;tmp/events.log&quot;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a>    cmp <span class="st">&quot;tmp/events.log&quot;</span> <span class="st">&quot;data/events.log&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co">-- go</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="ot">go ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>go rprt_flg in_file out_file <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>  ctx <span class="ot">&lt;-</span> setup rprt_flg</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>  sed (script ctx) in_file out_file</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ot">script ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">Edits</span> <span class="dt">IO</span> <span class="dt">RE</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>script ctx <span class="ot">=</span> <span class="dt">Select</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>    [ on [re_|@{access}|]     <span class="dt">ACC</span> parse_access</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>    , on [re_|@{access_deg}|] <span class="dt">AQQ</span> parse_deg_access</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>    , on [re_|@{error}|]      <span class="dt">ERR</span> parse_error</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>    , on [re_|.*|]            <span class="dt">QQQ</span> parse_def</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>    ]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>    on rex src prs <span class="ot">=</span> <span class="dt">Function</span> (rex lpo) <span class="dt">TOP</span> <span class="op">$</span> process_line ctx src prs</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>    parse_def      <span class="ot">=</span> <span class="fu">fmap</span> capturedText <span class="op">.</span> matchCapture</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ot">process_line ::</span> <span class="dt">IsEvent</span> a</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>             <span class="ot">=&gt;</span> <span class="dt">Ctx</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">Source</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>             <span class="ot">-&gt;</span> (<span class="dt">Match</span> <span class="dt">LBS.ByteString</span><span class="ot">-&gt;</span><span class="dt">Maybe</span> a)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">RELocation</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>             <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>process_line ctx src prs lno cs _ _ <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>    when (event_is_notifiable event) <span class="op">$</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>      flag_event ctx event</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span> presentEvent event</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a>    event     <span class="ot">=</span> <span class="fu">maybe</span> def_event (mkEvent lno src) <span class="op">$</span> prs cs</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a>    def_event <span class="ot">=</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a>      <span class="dt">Event</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a>        { _event_line     <span class="ot">=</span> lno</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a>        , _event_source   <span class="ot">=</span> src</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a>        , _event_utc      <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;1970-01-01 00:00:00&quot;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a>        , _event_severity <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a>        , _event_address  <span class="ot">=</span> (<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a>        , _event_details  <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a>        }</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a><span class="co">-- Ctx, setup, event_is_notifiable, flag_event</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Ctx</span> <span class="ot">=</span> <span class="dt">Bool</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a><span class="ot">setup ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Ctx</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true"></a>setup <span class="ot">=</span> <span class="fu">return</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true"></a><span class="ot">event_is_notifiable ::</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true"></a>event_is_notifiable <span class="dt">Event</span>{<span class="op">..</span>} <span class="ot">=</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true"></a>  <span class="fu">fromEnum</span> (fromMaybe <span class="dt">Debug</span> _event_severity) <span class="op">&lt;=</span> <span class="fu">fromEnum</span> <span class="dt">Err</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true"></a><span class="ot">flag_event ::</span> <span class="dt">Ctx</span> <span class="ot">-&gt;</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true"></a>flag_event <span class="dt">False</span> <span class="ot">=</span> <span class="fu">const</span> <span class="op">$</span> <span class="fu">return</span> ()</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true"></a>flag_event <span class="dt">True</span>  <span class="ot">=</span> LBS.hPutStrLn stderr <span class="op">.</span> presentEvent</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true"></a><span class="co">-- Event, presentEvent, IsEvent</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Event</span> <span class="ot">=</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true"></a>  <span class="dt">Event</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true"></a>    {<span class="ot"> _event_line     ::</span> <span class="dt">LineNo</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true"></a>    ,<span class="ot"> _event_source   ::</span> <span class="dt">Source</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true"></a>    ,<span class="ot"> _event_utc      ::</span> <span class="dt">UTCTime</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true"></a>    ,<span class="ot"> _event_severity ::</span> <span class="dt">Maybe</span> <span class="dt">Severity</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true"></a>    ,<span class="ot"> _event_address  ::</span> <span class="dt">IPV4Address</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true"></a>    ,<span class="ot"> _event_details  ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true"></a>    }</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Source</span> <span class="ot">=</span> <span class="dt">ACC</span> <span class="op">|</span> <span class="dt">AQQ</span> <span class="op">|</span> <span class="dt">ERR</span> <span class="op">|</span> <span class="dt">QQQ</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>,<span class="dt">Read</span>)</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true"></a></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true"></a><span class="ot">presentEvent ::</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true"></a>presentEvent <span class="dt">Event</span>{<span class="op">..</span>} <span class="ot">=</span> LBS.pack <span class="op">$</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true"></a>  printf <span class="st">&quot;%04d %s %s %-7s %3d.%3d.%3d.%3d [%s]&quot;</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true"></a>    (getLineNo                _event_line    )</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true"></a>    (<span class="fu">show</span>                     _event_source  )</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true"></a>    (<span class="fu">show</span>                     _event_utc     )</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true"></a>    (<span class="fu">maybe</span> <span class="st">&quot;-&quot;</span> svrty_kw       _event_severity)</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true"></a>                              a b c d</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true"></a>    (LBS.unpack               _event_details )</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true"></a>    (a,b,c,d) <span class="ot">=</span> _event_address</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true"></a></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true"></a>    svrty_kw  <span class="ot">=</span> T.unpack <span class="op">.</span> <span class="fu">fst</span> <span class="op">.</span> severityKeywords</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true"></a></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true"></a><span class="kw">class</span> <span class="dt">IsEvent</span> a <span class="kw">where</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true"></a><span class="ot">  mkEvent ::</span> <span class="dt">LineNo</span> <span class="ot">-&gt;</span> <span class="dt">Source</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Event</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">IsEvent</span> <span class="dt">Access</span> <span class="kw">where</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true"></a>  mkEvent lno src <span class="dt">Access</span>{<span class="op">..</span>} <span class="ot">=</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true"></a>    <span class="dt">Event</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true"></a>      { _event_line     <span class="ot">=</span> lno</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true"></a>      , _event_source   <span class="ot">=</span> src</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true"></a>      , _event_utc      <span class="ot">=</span> _a_time_local</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true"></a>      , _event_severity <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true"></a>      , _event_address  <span class="ot">=</span> _a_remote_addr</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true"></a>      , _event_details  <span class="ot">=</span> LBS.pack <span class="op">$</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true"></a>          printf <span class="st">&quot;%s %d %d %s %s %s&quot;</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true"></a>            (T.unpack _a_request        )</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true"></a>                      _a_status</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true"></a>                      _a_body_bytes</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true"></a>            (T.unpack _a_http_referrer  )</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true"></a>            (T.unpack _a_http_user_agent)</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true"></a>            (T.unpack _a_other          )</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true"></a>      }</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true"></a></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">IsEvent</span> <span class="dt">Error</span> <span class="kw">where</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true"></a>  mkEvent lno src <span class="dt">ERROR</span>{<span class="op">..</span>} <span class="ot">=</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true"></a>    <span class="dt">Event</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true"></a>      { _event_line     <span class="ot">=</span> lno</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true"></a>      , _event_source   <span class="ot">=</span> src</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true"></a>      , _event_utc      <span class="ot">=</span> <span class="dt">UTCTime</span> _e_date <span class="op">$</span> timeOfDayToTime _e_time</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true"></a>      , _event_severity <span class="ot">=</span> <span class="dt">Just</span> _e_severity</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true"></a>      , _event_address  <span class="ot">=</span> (<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true"></a>      , _event_details  <span class="ot">=</span> LBS.pack <span class="op">$</span> printf <span class="st">&quot;%d#%d: %s&quot;</span> pid tid <span class="op">$</span> LBS.unpack _e_other</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true"></a>      }</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true"></a>    <span class="kw">where</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true"></a>      (pid,tid) <span class="ot">=</span> _e_pid_tid</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">IsEvent</span> <span class="dt">LBS.ByteString</span> <span class="kw">where</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true"></a>  mkEvent lno src lbs <span class="ot">=</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true"></a>    <span class="dt">Event</span></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true"></a>      { _event_line     <span class="ot">=</span> lno</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true"></a>      , _event_source   <span class="ot">=</span> src</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true"></a>      , _event_utc      <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;1970-01-01 00:00:00Z&quot;</span></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true"></a>      , _event_severity <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true"></a>      , _event_address  <span class="ot">=</span> (<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true"></a>      , _event_details  <span class="ot">=</span> lbs</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true"></a>      }</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true"></a></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true"></a></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true"></a><span class="co">-- REOptions and Prelude</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true"></a></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true"></a><span class="ot">lpo ::</span> <span class="dt">PCRE.REOptions</span></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true"></a>lpo <span class="ot">=</span> PCRE.makeREOptions lp_prelude</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true"></a><span class="ot">lp_prelude ::</span> <span class="dt">Macros</span> <span class="dt">RE</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true"></a>lp_prelude <span class="ot">=</span> runIdentity <span class="op">$</span> mkMacros mk regexType <span class="dt">ExclCaptures</span> lp_env</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true"></a>    mk   <span class="ot">=</span> <span class="fu">maybe</span> oops <span class="dt">Identity</span> <span class="op">.</span> PCRE.compileRegexWithOptions PCRE.noPreludeREOptions</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true"></a></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true"></a>    oops <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;lp_prelude&quot;</span></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true"></a></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true"></a><span class="ot">lp_macro_table ::</span> <span class="dt">String</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true"></a>lp_macro_table <span class="ot">=</span> formatMacroTable regexType lp_env</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true"></a></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true"></a><span class="ot">lp_macro_summary ::</span> <span class="dt">MacroID</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true"></a>lp_macro_summary <span class="ot">=</span> formatMacroSummary regexType lp_env</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true"></a></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true"></a><span class="ot">lp_macro_sources ::</span> <span class="dt">String</span></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true"></a>lp_macro_sources <span class="ot">=</span> formatMacroSources regexType <span class="dt">ExclCaptures</span> lp_env</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true"></a></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true"></a><span class="ot">lp_macro_source ::</span> <span class="dt">MacroID</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true"></a>lp_macro_source <span class="ot">=</span> formatMacroSource regexType <span class="dt">ExclCaptures</span> lp_env</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true"></a></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true"></a><span class="ot">lp_env ::</span> <span class="dt">MacroEnv</span></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true"></a>lp_env <span class="ot">=</span> PCRE.preludeEnv <span class="ot">`HML.union`</span> HML.fromList</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true"></a>    [ f <span class="st">&quot;user&quot;</span>        user_macro</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true"></a>    , f <span class="st">&quot;pid#tid:&quot;</span>    pid_tid_macro</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true"></a>    , f <span class="st">&quot;access&quot;</span>      access_macro</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true"></a>    , f <span class="st">&quot;access_deg&quot;</span>  access_deg_macro</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true"></a>    , f <span class="st">&quot;error&quot;</span>       error_macro</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true"></a>    ]</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true"></a>    f mid mk <span class="ot">=</span> (mid, mk lp_env mid)</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true"></a></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true"></a></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true"></a><span class="co">-- The Macro Descriptors</span></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true"></a></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true"></a><span class="ot">user_macro ::</span> <span class="dt">MacroEnv</span> <span class="ot">-&gt;</span> <span class="dt">MacroID</span> <span class="ot">-&gt;</span> <span class="dt">MacroDescriptor</span></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true"></a>user_macro env mid <span class="ot">=</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true"></a>  runTests regexType parse_user samples env mid</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true"></a>    <span class="dt">MacroDescriptor</span></span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true"></a>      { macroSource          <span class="ot">=</span> <span class="st">&quot;(?:-|[^[:space:]]+)&quot;</span></span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true"></a>      , macroSamples         <span class="ot">=</span> <span class="fu">map</span> <span class="fu">fst</span> samples</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true"></a>      , macroCounterSamples <span class="ot">=</span> counter_samples</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true"></a>      , macroTestResults    <span class="ot">=</span> []</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true"></a>      , macroParser          <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;parse_user&quot;</span></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true"></a>      , macroDescription     <span class="ot">=</span> <span class="st">&quot;a user ident (per RFC1413)&quot;</span></span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true"></a>      }</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true"></a><span class="ot">    samples ::</span> [(<span class="dt">String</span>,<span class="dt">User</span>)]</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true"></a>    samples <span class="ot">=</span></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true"></a>        [ f <span class="st">&quot;joe&quot;</span></span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true"></a>        ]</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true"></a>      <span class="kw">where</span></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true"></a>        f nm <span class="ot">=</span> (nm,<span class="dt">User</span> <span class="op">$</span> LBS.pack nm)</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true"></a></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true"></a>    counter_samples <span class="ot">=</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true"></a>        [ <span class="st">&quot;joe user&quot;</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true"></a>        ]</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true"></a></span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true"></a><span class="ot">pid_tid_macro ::</span> <span class="dt">MacroEnv</span> <span class="ot">-&gt;</span> <span class="dt">MacroID</span> <span class="ot">-&gt;</span> <span class="dt">MacroDescriptor</span></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true"></a>pid_tid_macro env mid <span class="ot">=</span></span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true"></a>  runTests regexType parse_pid_tid samples env mid</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true"></a>    <span class="dt">MacroDescriptor</span></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true"></a>      { macroSource          <span class="ot">=</span> <span class="st">&quot;(?:@{%nat})#(?:@{%nat}):&quot;</span></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true"></a>      , macroSamples         <span class="ot">=</span> <span class="fu">map</span> <span class="fu">fst</span> samples</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true"></a>      , macroCounterSamples <span class="ot">=</span> counter_samples</span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true"></a>      , macroTestResults    <span class="ot">=</span> []</span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true"></a>      , macroParser          <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;parse_pid_tid&quot;</span></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true"></a>      , macroDescription     <span class="ot">=</span> <span class="st">&quot;&lt;PID&gt;#&lt;TID&gt;:&quot;</span></span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true"></a>      }</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true"></a><span class="ot">    samples ::</span> [(<span class="dt">String</span>,(<span class="dt">Int</span>,<span class="dt">Int</span>))]</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true"></a>    samples <span class="ot">=</span></span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true"></a>        [ f <span class="st">&quot;1378#0:&quot;</span> (<span class="dv">1378</span>,<span class="dv">0</span>)</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true"></a>        ]</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true"></a>      <span class="kw">where</span></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true"></a>        f <span class="ot">=</span> (,)</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true"></a></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true"></a>    counter_samples <span class="ot">=</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true"></a>        [ <span class="st">&quot;&quot;</span></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true"></a>        , <span class="st">&quot;24#:&quot;</span></span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true"></a>        , <span class="st">&quot;24.365:&quot;</span></span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true"></a>        ]</span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true"></a></span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true"></a><span class="ot">access_macro ::</span> <span class="dt">MacroEnv</span> <span class="ot">-&gt;</span> <span class="dt">MacroID</span> <span class="ot">-&gt;</span> <span class="dt">MacroDescriptor</span></span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true"></a>access_macro env mid <span class="ot">=</span></span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true"></a>  runTests&#39; regexType (parse_access <span class="op">.</span> <span class="fu">fmap</span> LBS.pack) samples env mid</span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true"></a>    <span class="dt">MacroDescriptor</span></span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true"></a>      { macroSource          <span class="ot">=</span> access_re</span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true"></a>      , macroSamples         <span class="ot">=</span> <span class="fu">map</span> <span class="fu">fst</span> samples</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true"></a>      , macroCounterSamples <span class="ot">=</span> counter_samples</span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true"></a>      , macroTestResults    <span class="ot">=</span> []</span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true"></a>      , macroParser          <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;parse_a&quot;</span></span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true"></a>      , macroDescription     <span class="ot">=</span> <span class="st">&quot;an Nginx access log file line&quot;</span></span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true"></a>      }</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true"></a><span class="ot">    samples ::</span> [(<span class="dt">String</span>,<span class="dt">Access</span>)]</span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true"></a>    samples <span class="ot">=</span></span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true"></a>        [ (,) <span class="st">&quot;192.168.100.200 - - [12/Jan/2016:12:08:36 +0000] \&quot;GET / HTTP/1.1\&quot; 200 3700 \&quot;-\&quot; \&quot;My Agent\&quot; \&quot;-\&quot;&quot;</span></span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true"></a>            <span class="dt">Access</span></span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true"></a>              { _a_remote_addr      <span class="ot">=</span> (<span class="dv">192</span>,<span class="dv">168</span>,<span class="dv">100</span>,<span class="dv">200</span>)</span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true"></a>              , _a_remote_user      <span class="ot">=</span> <span class="st">&quot;-&quot;</span></span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true"></a>              , _a_time_local       <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;2016-01-12 12:08:36 UTC&quot;</span></span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true"></a>              , _a_request          <span class="ot">=</span> <span class="st">&quot;GET / HTTP/1.1&quot;</span></span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true"></a>              , _a_status           <span class="ot">=</span> <span class="dv">200</span></span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true"></a>              , _a_body_bytes       <span class="ot">=</span> <span class="dv">3700</span></span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true"></a>              , _a_http_referrer    <span class="ot">=</span> <span class="st">&quot;-&quot;</span></span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true"></a>              , _a_http_user_agent  <span class="ot">=</span> <span class="st">&quot;My Agent&quot;</span></span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true"></a>              , _a_other            <span class="ot">=</span> <span class="st">&quot;-&quot;</span></span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true"></a>              }</span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true"></a>        ]</span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true"></a></span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true"></a>    counter_samples <span class="ot">=</span></span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true"></a>        [ <span class="st">&quot;&quot;</span></span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true"></a>        , <span class="st">&quot; -  [] \&quot;\&quot;   \&quot;\&quot; \&quot;\&quot; \&quot;\&quot;&quot;</span></span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true"></a>        ]</span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true"></a></span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true"></a><span class="ot">access_deg_macro ::</span> <span class="dt">MacroEnv</span> <span class="ot">-&gt;</span> <span class="dt">MacroID</span> <span class="ot">-&gt;</span> <span class="dt">MacroDescriptor</span></span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true"></a>access_deg_macro env mid <span class="ot">=</span></span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true"></a>  runTests&#39; regexType (parse_deg_access <span class="op">.</span> <span class="fu">fmap</span> LBS.pack) samples env mid</span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true"></a>    <span class="dt">MacroDescriptor</span></span>
<span id="cb6-251"><a href="#cb6-251" aria-hidden="true"></a>      { macroSource          <span class="ot">=</span> <span class="st">&quot; -  \\[\\] \&quot;\&quot;   \&quot;\&quot; \&quot;\&quot; \&quot;\&quot;&quot;</span></span>
<span id="cb6-252"><a href="#cb6-252" aria-hidden="true"></a>      , macroSamples         <span class="ot">=</span> <span class="fu">map</span> <span class="fu">fst</span> samples</span>
<span id="cb6-253"><a href="#cb6-253" aria-hidden="true"></a>      , macroCounterSamples <span class="ot">=</span> counter_samples</span>
<span id="cb6-254"><a href="#cb6-254" aria-hidden="true"></a>      , macroTestResults    <span class="ot">=</span> []</span>
<span id="cb6-255"><a href="#cb6-255" aria-hidden="true"></a>      , macroParser          <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb6-256"><a href="#cb6-256" aria-hidden="true"></a>      , macroDescription     <span class="ot">=</span> <span class="st">&quot;a degenerate Nginx access log file line&quot;</span></span>
<span id="cb6-257"><a href="#cb6-257" aria-hidden="true"></a>      }</span>
<span id="cb6-258"><a href="#cb6-258" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-259"><a href="#cb6-259" aria-hidden="true"></a><span class="ot">    samples ::</span> [(<span class="dt">String</span>,<span class="dt">Access</span>)]</span>
<span id="cb6-260"><a href="#cb6-260" aria-hidden="true"></a>    samples <span class="ot">=</span></span>
<span id="cb6-261"><a href="#cb6-261" aria-hidden="true"></a>        [ (,) <span class="st">&quot; -  [] \&quot;\&quot;   \&quot;\&quot; \&quot;\&quot; \&quot;\&quot;&quot;</span> deg_access</span>
<span id="cb6-262"><a href="#cb6-262" aria-hidden="true"></a>        ]</span>
<span id="cb6-263"><a href="#cb6-263" aria-hidden="true"></a></span>
<span id="cb6-264"><a href="#cb6-264" aria-hidden="true"></a>    counter_samples <span class="ot">=</span></span>
<span id="cb6-265"><a href="#cb6-265" aria-hidden="true"></a>        [ <span class="st">&quot;&quot;</span></span>
<span id="cb6-266"><a href="#cb6-266" aria-hidden="true"></a>        , <span class="st">&quot;foo&quot;</span></span>
<span id="cb6-267"><a href="#cb6-267" aria-hidden="true"></a>        ]</span>
<span id="cb6-268"><a href="#cb6-268" aria-hidden="true"></a></span>
<span id="cb6-269"><a href="#cb6-269" aria-hidden="true"></a><span class="ot">error_macro ::</span> <span class="dt">MacroEnv</span> <span class="ot">-&gt;</span> <span class="dt">MacroID</span> <span class="ot">-&gt;</span> <span class="dt">MacroDescriptor</span></span>
<span id="cb6-270"><a href="#cb6-270" aria-hidden="true"></a>error_macro env mid <span class="ot">=</span></span>
<span id="cb6-271"><a href="#cb6-271" aria-hidden="true"></a>  runTests&#39; regexType (parse_error <span class="op">.</span> <span class="fu">fmap</span> LBS.pack) samples env mid</span>
<span id="cb6-272"><a href="#cb6-272" aria-hidden="true"></a>    <span class="dt">MacroDescriptor</span></span>
<span id="cb6-273"><a href="#cb6-273" aria-hidden="true"></a>      { macroSource          <span class="ot">=</span> error_re</span>
<span id="cb6-274"><a href="#cb6-274" aria-hidden="true"></a>      , macroSamples         <span class="ot">=</span> <span class="fu">map</span> <span class="fu">fst</span> samples</span>
<span id="cb6-275"><a href="#cb6-275" aria-hidden="true"></a>      , macroCounterSamples <span class="ot">=</span> counter_samples</span>
<span id="cb6-276"><a href="#cb6-276" aria-hidden="true"></a>      , macroTestResults    <span class="ot">=</span> []</span>
<span id="cb6-277"><a href="#cb6-277" aria-hidden="true"></a>      , macroParser          <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;parse_e&quot;</span></span>
<span id="cb6-278"><a href="#cb6-278" aria-hidden="true"></a>      , macroDescription     <span class="ot">=</span> <span class="st">&quot;an Nginx error log file line&quot;</span></span>
<span id="cb6-279"><a href="#cb6-279" aria-hidden="true"></a>      }</span>
<span id="cb6-280"><a href="#cb6-280" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb6-281"><a href="#cb6-281" aria-hidden="true"></a><span class="ot">    samples ::</span> [(<span class="dt">String</span>,<span class="dt">Error</span>)]</span>
<span id="cb6-282"><a href="#cb6-282" aria-hidden="true"></a>    samples <span class="ot">=</span></span>
<span id="cb6-283"><a href="#cb6-283" aria-hidden="true"></a>        [ (,) <span class="st">&quot;2016/12/21 11:53:35 [emerg] 1378#0: foo&quot;</span></span>
<span id="cb6-284"><a href="#cb6-284" aria-hidden="true"></a>            <span class="dt">ERROR</span></span>
<span id="cb6-285"><a href="#cb6-285" aria-hidden="true"></a>              { _e_date     <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;2016-12-21&quot;</span></span>
<span id="cb6-286"><a href="#cb6-286" aria-hidden="true"></a>              , _e_time     <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;11:53:35&quot;</span></span>
<span id="cb6-287"><a href="#cb6-287" aria-hidden="true"></a>              , _e_severity <span class="ot">=</span> <span class="dt">Emerg</span></span>
<span id="cb6-288"><a href="#cb6-288" aria-hidden="true"></a>              , _e_pid_tid  <span class="ot">=</span> (<span class="dv">1378</span>,<span class="dv">0</span>)</span>
<span id="cb6-289"><a href="#cb6-289" aria-hidden="true"></a>              , _e_other    <span class="ot">=</span> <span class="st">&quot; foo&quot;</span></span>
<span id="cb6-290"><a href="#cb6-290" aria-hidden="true"></a>              }</span>
<span id="cb6-291"><a href="#cb6-291" aria-hidden="true"></a>        , (,) <span class="st">&quot;2017/01/04 05:40:19 [error] 31623#0: *1861296 no \&quot;ssl_certificate\&quot; is defined in server listening on SSL port while SSL handshaking, client: 192.168.31.38, server: 0.0.0.0:80&quot;</span></span>
<span id="cb6-292"><a href="#cb6-292" aria-hidden="true"></a>            <span class="dt">ERROR</span></span>
<span id="cb6-293"><a href="#cb6-293" aria-hidden="true"></a>              { _e_date     <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;2017-01-04&quot;</span></span>
<span id="cb6-294"><a href="#cb6-294" aria-hidden="true"></a>              , _e_time     <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;05:40:19&quot;</span></span>
<span id="cb6-295"><a href="#cb6-295" aria-hidden="true"></a>              , _e_severity <span class="ot">=</span> <span class="dt">Err</span></span>
<span id="cb6-296"><a href="#cb6-296" aria-hidden="true"></a>              , _e_pid_tid  <span class="ot">=</span> (<span class="dv">31623</span>,<span class="dv">0</span>)</span>
<span id="cb6-297"><a href="#cb6-297" aria-hidden="true"></a>              , _e_other    <span class="ot">=</span> <span class="st">&quot; *1861296 no \&quot;ssl_certificate\&quot; is defined in server listening on SSL port while SSL handshaking, client: 192.168.31.38, server: 0.0.0.0:80&quot;</span></span>
<span id="cb6-298"><a href="#cb6-298" aria-hidden="true"></a>              }</span>
<span id="cb6-299"><a href="#cb6-299" aria-hidden="true"></a>        ]</span>
<span id="cb6-300"><a href="#cb6-300" aria-hidden="true"></a></span>
<span id="cb6-301"><a href="#cb6-301" aria-hidden="true"></a>    counter_samples <span class="ot">=</span></span>
<span id="cb6-302"><a href="#cb6-302" aria-hidden="true"></a>        [ <span class="st">&quot;&quot;</span></span>
<span id="cb6-303"><a href="#cb6-303" aria-hidden="true"></a>        , <span class="st">&quot;foo&quot;</span></span>
<span id="cb6-304"><a href="#cb6-304" aria-hidden="true"></a>        ]</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="co">-- Access, access_re, deg_access, parse_deg_access, parse_access</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Access</span> <span class="ot">=</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>  <span class="dt">Access</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    {<span class="ot"> _a_remote_addr      ::</span> <span class="op">!</span><span class="dt">IPV4Address</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    ,<span class="ot"> _a_remote_user      ::</span> <span class="op">!</span><span class="dt">User</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>    ,<span class="ot"> _a_time_local       ::</span> <span class="op">!</span><span class="dt">UTCTime</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>    ,<span class="ot"> _a_request          ::</span> <span class="op">!</span><span class="dt">T.Text</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a>    ,<span class="ot"> _a_status           ::</span> <span class="op">!</span><span class="dt">Int</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a>    ,<span class="ot"> _a_body_bytes       ::</span> <span class="op">!</span><span class="dt">Int</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a>    ,<span class="ot"> _a_http_referrer    ::</span> <span class="op">!</span><span class="dt">T.Text</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a>    ,<span class="ot"> _a_http_user_agent  ::</span> <span class="op">!</span><span class="dt">T.Text</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a>    ,<span class="ot"> _a_other            ::</span> <span class="op">!</span><span class="dt">T.Text</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a>    }</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>,<span class="dt">Show</span>)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ot">access_re ::</span> <span class="dt">RegexSource</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>access_re <span class="ot">=</span> <span class="dt">RegexSource</span> <span class="op">$</span> <span class="fu">unwords</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>  [ <span class="st">&quot;(@{%address.ipv4})&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>  , <span class="st">&quot;-&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>  , <span class="st">&quot;(@{user})&quot;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>  , <span class="st">&quot;\\[(@{%datetime.clf})\\]&quot;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>  , <span class="st">&quot;(@{%string.simple})&quot;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>  , <span class="st">&quot;(@{%nat})&quot;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>  , <span class="st">&quot;(@{%nat})&quot;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>  , <span class="st">&quot;(@{%string.simple})&quot;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>  , <span class="st">&quot;(@{%string.simple})&quot;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>  , <span class="st">&quot;(@{%string.simple})&quot;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>  ]</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="ot">deg_access ::</span> <span class="dt">Access</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>deg_access <span class="ot">=</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>  <span class="dt">Access</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    { _a_remote_addr      <span class="ot">=</span> (<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>    , _a_remote_user      <span class="ot">=</span> <span class="st">&quot;-&quot;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>    , _a_time_local       <span class="ot">=</span> <span class="fu">read</span> <span class="st">&quot;1970-01-01 00:00:00Z&quot;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>    , _a_request          <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>    , _a_status           <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>    , _a_body_bytes       <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>    , _a_http_referrer    <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>    , _a_http_user_agent  <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>    , _a_other            <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a>    }</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a><span class="ot">parse_deg_access ::</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Access</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a>parse_deg_access <span class="dt">Match</span>{<span class="op">..</span>} <span class="ot">=</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>  <span class="kw">case</span> matchSource <span class="op">==</span> <span class="st">&quot; -  [] \&quot;\&quot;   \&quot;\&quot; \&quot;\&quot; \&quot;\&quot;&quot;</span> <span class="kw">of</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>    <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="dt">Just</span> deg_access</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>    <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a><span class="ot">parse_a ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Access</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>parse_a lbs <span class="ot">=</span> parse_access <span class="op">$</span> lbs <span class="op">?=~</span> [re_|@{access}|] lpo</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a><span class="ot">parse_access ::</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Access</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a>parse_access cs <span class="ot">=</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>  <span class="dt">Access</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>    <span class="op">&lt;$&gt;</span> f parseIPv4Address  [cp|1|]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parse_user        [cp|2|]</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseDateTimeCLF  [cp|3|]</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseSimpleString [cp|4|]</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseInteger      [cp|5|]</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseInteger      [cp|6|]</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseSimpleString [cp|7|]</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseSimpleString [cp|8|]</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseSimpleString [cp|9|]</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true"></a>    f psr i <span class="ot">=</span> psr <span class="op">$</span> capturedText <span class="op">$</span> capture i cs</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true"></a><span class="co">-- Error, error_re, parse_error</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Error</span> <span class="ot">=</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true"></a>  <span class="dt">ERROR</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true"></a>    {<span class="ot"> _e_date     ::</span> <span class="dt">Day</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true"></a>    ,<span class="ot"> _e_time     ::</span> <span class="dt">TimeOfDay</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true"></a>    ,<span class="ot"> _e_severity ::</span> <span class="dt">Severity</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true"></a>    ,<span class="ot"> _e_pid_tid  ::</span> (<span class="dt">Int</span>,<span class="dt">Int</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true"></a>    ,<span class="ot"> _e_other    ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true"></a>    }</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>,<span class="dt">Show</span>)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true"></a><span class="ot">error_re ::</span> <span class="dt">RegexSource</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true"></a>error_re <span class="ot">=</span> <span class="dt">RegexSource</span> <span class="op">$</span> <span class="fu">unwords</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true"></a>  [ <span class="st">&quot;(@{%date.slashes})&quot;</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true"></a>  , <span class="st">&quot;(@{%time})&quot;</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true"></a>  , <span class="st">&quot;\\[(@{%syslog.severity})\\]&quot;</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true"></a>  , <span class="st">&quot;(@{pid#tid:})(.*)&quot;</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true"></a>  ]</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true"></a></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true"></a><span class="ot">parse_e ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Error</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true"></a>parse_e lbs <span class="ot">=</span> parse_error <span class="op">$</span> lbs <span class="op">?=~</span> [re_|@{error}|] lpo</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true"></a><span class="ot">parse_error ::</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Error</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true"></a>parse_error cs <span class="ot">=</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true"></a>  <span class="dt">ERROR</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true"></a>    <span class="op">&lt;$&gt;</span> f parseSlashesDate    [cp|1|]</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseTimeOfDay      [cp|2|]</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parseSeverity [cp|3|]</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f parse_pid_tid       [cp|4|]</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true"></a>    <span class="op">&lt;*&gt;</span> f <span class="dt">Just</span>                [cp|5|]</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true"></a>    f psr i <span class="ot">=</span> psr <span class="op">$</span> capturedText <span class="op">$</span> capture i cs</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true"></a></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true"></a></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true"></a><span class="co">-- User, parseUser</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true"></a></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">User</span> <span class="ot">=</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true"></a>    <span class="dt">User</span> {<span class="ot"> _User ::</span> <span class="dt">LBS.ByteString</span> }</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">IsString</span>,<span class="dt">Ord</span>,<span class="dt">Eq</span>,<span class="dt">Show</span>)</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true"></a></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true"></a><span class="ot">parse_user ::</span> <span class="dt">Replace</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">User</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true"></a>parse_user <span class="ot">=</span> <span class="dt">Just</span> <span class="op">.</span> <span class="dt">User</span> <span class="op">.</span> LBS.pack <span class="op">.</span> unpackR</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true"></a></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true"></a></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true"></a><span class="co">-- parse_pid_tid</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true"></a></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true"></a><span class="ot">parse_pid_tid ::</span> <span class="dt">Replace</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Int</span>,<span class="dt">Int</span>)</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true"></a>parse_pid_tid x <span class="ot">=</span> <span class="kw">case</span> allMatches <span class="op">$</span> unpackR x <span class="op">S.*=~</span> [re|@{%nat}|] <span class="kw">of</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true"></a>    [cs,cs&#39;] <span class="ot">-&gt;</span> (,) <span class="op">&lt;$&gt;</span> p cs <span class="op">&lt;*&gt;</span> p cs&#39;</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true"></a>    _        <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true"></a>    p cs <span class="ot">=</span> matchCapture cs <span class="op">&gt;&gt;=</span> parseInteger <span class="op">.</span> capturedText</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true"></a></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true"></a><span class="ot">regexType ::</span> <span class="dt">RegexType</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true"></a>regexType <span class="ot">=</span> PCRE.regexType</span></code></pre></div>
</div>    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-92650418-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>
