<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>regex â€“ examples/re-prep.lhs</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="lib/lhs-styles.css" />
  <link rel="stylesheet" href="lib/bs.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/>
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="mask-icon" href="/safari-pinned-tab.svg"/>
  <meta name="theme-color" content="#ffffff"/>
</head>
<body>
<div class='bcdiv'>
  <ol class='breadcrumb'>
    <li><a href="." style="font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;" id="branding">[<span style='color:red;'>re</span>|${<span style='color:red;'>gex</span>}(.*)|<span></span>]</a></li>
    <li><a title='source file' href='https://github.com/iconnect/regex/blob/master/examples/re-prep.lhs'>examples/re-prep.lhs</a></li>
</ol>
</div>
<div class='litcontent'>
<header>
<h1 class="title">examples/re-prep.lhs</h1>
</header>
<h1 id="regex-page-prep">Regex (Page) Prep</h1>
<p>This tool turns the markdown and literate Haskell into the HTML that makes up the website and the README.md for GitHub and for Hackage (based on the index.md for the website) and the test suite based on the tutorial.</p>
<p>The tool is self-testing: run it with no arguments (or <code>cabal test</code>).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE NoImplicitPrelude          #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE RecordWildCards            #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="ot">{-# LANGUAGE FlexibleContexts           #-}</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">module</span> <span class="dt">Main</span></a>
<a class="sourceLine" id="cb1-10" title="10">  ( main</a>
<a class="sourceLine" id="cb1-11" title="11">  ) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">import</span>           <span class="dt">Control.Applicative</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Char8</span>                    <span class="kw">as</span> <span class="dt">B</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span>               <span class="kw">as</span> <span class="dt">LBS</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="kw">import</span>           <span class="dt">Data.IORef</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.List</span>                                <span class="kw">as</span> <span class="dt">L</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="kw">import</span>           <span class="dt">Data.Maybe</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Monoid</span>                              <span class="kw">as</span> <span class="dt">M</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span>                                <span class="kw">as</span> <span class="dt">T</span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="kw">import</span>           <span class="dt">Network.HTTP.Conduit</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="kw">import</span>           <span class="dt">Prelude.Compat</span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Shelly</span>                                   <span class="kw">as</span> <span class="dt">SH</span></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="kw">import</span>           <span class="dt">System.Directory</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="kw">import</span>           <span class="dt">System.Environment</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="kw">import</span>           <span class="dt">System.FilePath</span></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="kw">import</span>           <span class="dt">System.IO</span></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="kw">import</span>           <span class="dt">TestKit</span></a>
<a class="sourceLine" id="cb1-29" title="29"><span class="kw">import</span>           <span class="dt">Text.Heredoc</span></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="kw">import</span>           <span class="dt">Text.RE.Replace</span></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="kw">import</span>           <span class="dt">Text.RE.TDFA.ByteString.Lazy</span></a>
<a class="sourceLine" id="cb1-32" title="32"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.RE.TDFA.String</span>                      <span class="kw">as</span> <span class="dt">TS</span></a>
<a class="sourceLine" id="cb1-33" title="33"><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Grep</span></a>
<a class="sourceLine" id="cb1-34" title="34"><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Sed</span></a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-2" title="2">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-3" title="3">  as  <span class="ot">&lt;-</span> getArgs</a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="kw">case</span> as <span class="kw">of</span></a>
<a class="sourceLine" id="cb2-5" title="5">    []                          <span class="ot">-&gt;</span> test</a>
<a class="sourceLine" id="cb2-6" title="6">    [<span class="st">&quot;test&quot;</span>]                    <span class="ot">-&gt;</span> test</a>
<a class="sourceLine" id="cb2-7" title="7">    [<span class="st">&quot;doc&quot;</span>,fn,fn&#39;] <span class="fu">|</span> is_file fn <span class="ot">-&gt;</span> doc fn fn&#39;</a>
<a class="sourceLine" id="cb2-8" title="8">    [<span class="st">&quot;gen&quot;</span>,fn,fn&#39;] <span class="fu">|</span> is_file fn <span class="ot">-&gt;</span> gen fn fn&#39;</a>
<a class="sourceLine" id="cb2-9" title="9">    [<span class="st">&quot;badges&quot;</span>]                  <span class="ot">-&gt;</span> badges</a>
<a class="sourceLine" id="cb2-10" title="10">    [<span class="st">&quot;blog-badge&quot;</span>]              <span class="ot">-&gt;</span> blog_badge</a>
<a class="sourceLine" id="cb2-11" title="11">    [<span class="st">&quot;pages&quot;</span>]                   <span class="ot">-&gt;</span> pages</a>
<a class="sourceLine" id="cb2-12" title="12">    [<span class="st">&quot;all&quot;</span>]                     <span class="ot">-&gt;</span> gen_all</a>
<a class="sourceLine" id="cb2-13" title="13">    _                           <span class="ot">-&gt;</span> usage</a>
<a class="sourceLine" id="cb2-14" title="14">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-15" title="15">    is_file <span class="fu">=</span> <span class="fu">not</span> <span class="fu">.</span> (<span class="fu">==</span> <span class="st">&quot;--&quot;</span>) <span class="fu">.</span> <span class="fu">take</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb2-16" title="16"></a>
<a class="sourceLine" id="cb2-17" title="17">    doc fn fn&#39; <span class="fu">=</span>                    prepare_tutorial <span class="dt">Doc</span> fn fn&#39;</a>
<a class="sourceLine" id="cb2-18" title="18">    gen fn fn&#39; <span class="fu">=</span> genMode <span class="fu">&gt;&gt;=</span> \gm <span class="ot">-&gt;</span> prepare_tutorial gm  fn fn&#39;</a>
<a class="sourceLine" id="cb2-19" title="19"></a>
<a class="sourceLine" id="cb2-20" title="20">    usage <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-21" title="21">      pnm <span class="ot">&lt;-</span> getProgName</a>
<a class="sourceLine" id="cb2-22" title="22">      <span class="kw">let</span> prg <span class="fu">=</span> ((<span class="st">&quot;  &quot;</span><span class="fu">++</span>pnm<span class="fu">++</span><span class="st">&quot; &quot;</span>)<span class="fu">++</span>)</a>
<a class="sourceLine" id="cb2-23" title="23">      hPutStr stderr <span class="fu">$</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb2-24" title="24">        [ <span class="st">&quot;usage:&quot;</span></a>
<a class="sourceLine" id="cb2-25" title="25">        , prg <span class="st">&quot;--help&quot;</span></a>
<a class="sourceLine" id="cb2-26" title="26">        , prg <span class="st">&quot;[test]&quot;</span></a>
<a class="sourceLine" id="cb2-27" title="27">        , prg <span class="st">&quot;badges&quot;</span></a>
<a class="sourceLine" id="cb2-28" title="28">        , prg <span class="st">&quot;blog-badge&quot;</span></a>
<a class="sourceLine" id="cb2-29" title="29">        , prg <span class="st">&quot;pages&quot;</span></a>
<a class="sourceLine" id="cb2-30" title="30">        , prg <span class="st">&quot;all&quot;</span></a>
<a class="sourceLine" id="cb2-31" title="31">        , prg <span class="st">&quot;doc (-|&lt;in-file&gt;) (-|&lt;out-file&gt;)&quot;</span></a>
<a class="sourceLine" id="cb2-32" title="32">        , prg <span class="st">&quot;gen (-|&lt;in-file&gt;) (-|&lt;out-file&gt;)&quot;</span></a>
<a class="sourceLine" id="cb2-33" title="33">        ]</a></code></pre></div>
<h2 id="script-to-generate-the-whole-web-site">Script to Generate the Whole Web Site</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="ot">gen_all ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-2" title="2">gen_all <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="co">-- prepare HTML docs for the (literate) tools</span></a>
<a class="sourceLine" id="cb3-4" title="4">    pd <span class="st">&quot;re-gen-cabals&quot;</span></a>
<a class="sourceLine" id="cb3-5" title="5">    pd <span class="st">&quot;re-gen-modules&quot;</span></a>
<a class="sourceLine" id="cb3-6" title="6">    pd <span class="st">&quot;re-include&quot;</span></a>
<a class="sourceLine" id="cb3-7" title="7">    pd <span class="st">&quot;re-nginx-log-processor&quot;</span></a>
<a class="sourceLine" id="cb3-8" title="8">    pd <span class="st">&quot;re-prep&quot;</span></a>
<a class="sourceLine" id="cb3-9" title="9">    pd <span class="st">&quot;re-sort-imports&quot;</span></a>
<a class="sourceLine" id="cb3-10" title="10">    pd <span class="st">&quot;re-top&quot;</span></a>
<a class="sourceLine" id="cb3-11" title="11">    pd <span class="st">&quot;re-tests&quot;</span></a>
<a class="sourceLine" id="cb3-12" title="12">    pd <span class="st">&quot;TestKit&quot;</span></a>
<a class="sourceLine" id="cb3-13" title="13">    pd <span class="st">&quot;RE/REOptions&quot;</span></a>
<a class="sourceLine" id="cb3-14" title="14">    pd <span class="st">&quot;RE/Tools/Edit&quot;</span></a>
<a class="sourceLine" id="cb3-15" title="15">    pd <span class="st">&quot;RE/Tools/Grep&quot;</span></a>
<a class="sourceLine" id="cb3-16" title="16">    pd <span class="st">&quot;RE/Tools/Sed&quot;</span></a>
<a class="sourceLine" id="cb3-17" title="17">    pd <span class="st">&quot;RE/ZeInternals/NamedCaptures&quot;</span></a>
<a class="sourceLine" id="cb3-18" title="18">    pd <span class="st">&quot;RE/ZeInternals/Replace&quot;</span></a>
<a class="sourceLine" id="cb3-19" title="19">    pd <span class="st">&quot;RE/ZeInternals/TestBench&quot;</span></a>
<a class="sourceLine" id="cb3-20" title="20">    pd <span class="st">&quot;RE/ZeInternals/Tools/Lex&quot;</span></a>
<a class="sourceLine" id="cb3-21" title="21">    pd <span class="st">&quot;RE/ZeInternals/Types/IsRegex&quot;</span></a>
<a class="sourceLine" id="cb3-22" title="22">    pd <span class="st">&quot;RE/ZeInternals/Types/Matches&quot;</span></a>
<a class="sourceLine" id="cb3-23" title="23">    pd <span class="st">&quot;RE/ZeInternals/Types/Match&quot;</span></a>
<a class="sourceLine" id="cb3-24" title="24">    pd <span class="st">&quot;RE/ZeInternals/Types/Capture&quot;</span></a>
<a class="sourceLine" id="cb3-25" title="25">    <span class="co">-- render the tutorial in HTML</span></a>
<a class="sourceLine" id="cb3-26" title="26">    createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></a>
<a class="sourceLine" id="cb3-27" title="27">    gen_tutorial <span class="st">&quot;tutorial&quot;</span></a>
<a class="sourceLine" id="cb3-28" title="28">    gen_tutorial <span class="st">&quot;tutorial-options&quot;</span></a>
<a class="sourceLine" id="cb3-29" title="29">    gen_tutorial <span class="st">&quot;tutorial-replacing&quot;</span></a>
<a class="sourceLine" id="cb3-30" title="30">    gen_tutorial <span class="st">&quot;tutorial-testbench&quot;</span></a>
<a class="sourceLine" id="cb3-31" title="31">    gen_tutorial <span class="st">&quot;tutorial-tools&quot;</span></a>
<a class="sourceLine" id="cb3-32" title="32">    pages</a>
<a class="sourceLine" id="cb3-33" title="33">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-34" title="34">    pd fnm <span class="fu">=</span> <span class="kw">case</span> (mtch <span class="fu">!$$?</span> [cp|fdr|],mtch <span class="fu">!$$?</span> [cp|mnm|]) <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-35" title="35">        (<span class="dt">Nothing</span> ,<span class="dt">Just</span> mnm) <span class="ot">-&gt;</span> pandoc_lhs (<span class="st">&quot;Text.RE.&quot;</span>          <span class="fu">++</span>mnm) (<span class="st">&quot;Text/&quot;</span>    <span class="fu">++</span>fnm<span class="fu">++</span><span class="st">&quot;.lhs&quot;</span>) (<span class="st">&quot;docs/&quot;</span><span class="fu">++</span>mnm<span class="fu">++</span><span class="st">&quot;.html&quot;</span>)</a>
<a class="sourceLine" id="cb3-36" title="36">        (<span class="dt">Just</span> fdr,<span class="dt">Just</span> mnm) <span class="ot">-&gt;</span> pandoc_lhs (<span class="st">&quot;Text.RE.&quot;</span><span class="fu">++</span>fdr<span class="fu">++</span><span class="st">&quot;.&quot;</span><span class="fu">++</span>mnm) (<span class="st">&quot;Text/&quot;</span>    <span class="fu">++</span>fnm<span class="fu">++</span><span class="st">&quot;.lhs&quot;</span>) (<span class="st">&quot;docs/&quot;</span><span class="fu">++</span>mnm<span class="fu">++</span><span class="st">&quot;.html&quot;</span>)</a>
<a class="sourceLine" id="cb3-37" title="37">        _                   <span class="ot">-&gt;</span> pandoc_lhs (<span class="st">&quot;examples/&quot;</span><span class="fu">++</span>fnm<span class="fu">++</span><span class="st">&quot;.lhs&quot;</span> ) (<span class="st">&quot;examples/&quot;</span><span class="fu">++</span>fnm<span class="fu">++</span><span class="st">&quot;.lhs&quot;</span>) (<span class="st">&quot;docs/&quot;</span><span class="fu">++</span>fnm<span class="fu">++</span><span class="st">&quot;.html&quot;</span>)</a>
<a class="sourceLine" id="cb3-38" title="38">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-39" title="39">        mtch <span class="fu">=</span> fnm <span class="fu">TS.?=~</span> [re|^RE/(${fdr}([a-zA-Z/]+)/)?${mnm}(@{%id})|]</a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="ot">gen_tutorial ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-2" title="2">gen_tutorial nm <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-3" title="3">    prepare_tutorial <span class="dt">Doc</span> (<span class="st">&quot;examples&quot;</span> <span class="fu">&lt;/&gt;</span> mst) (<span class="st">&quot;tmp&quot;</span> <span class="fu">&lt;/&gt;</span> tgt)</a>
<a class="sourceLine" id="cb4-4" title="4">    pandoc_lhs&#39;       tgt</a>
<a class="sourceLine" id="cb4-5" title="5">      (<span class="st">&quot;examples&quot;</span> <span class="fu">&lt;/&gt;</span> tgt)</a>
<a class="sourceLine" id="cb4-6" title="6">      (<span class="st">&quot;tmp&quot;</span>      <span class="fu">&lt;/&gt;</span> tgt)</a>
<a class="sourceLine" id="cb4-7" title="7">      (<span class="st">&quot;docs&quot;</span>     <span class="fu">&lt;/&gt;</span> htm)</a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="co">-- generate the tutorial-based tests</span></a>
<a class="sourceLine" id="cb4-9" title="9">    gm <span class="ot">&lt;-</span> genMode</a>
<a class="sourceLine" id="cb4-10" title="10">    prepare_tutorial gm (<span class="st">&quot;examples&quot;</span> <span class="fu">&lt;/&gt;</span> mst) (<span class="st">&quot;examples&quot;</span> <span class="fu">&lt;/&gt;</span> tgt)</a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="fu">putStrLn</span> <span class="fu">$</span> <span class="st">&quot;&gt;&gt; &quot;</span> <span class="fu">++</span> (<span class="st">&quot;examples&quot;</span> <span class="fu">&lt;/&gt;</span> tgt)</a>
<a class="sourceLine" id="cb4-12" title="12">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-13" title="13">    tgt <span class="fu">=</span> <span class="st">&quot;re-&quot;</span> <span class="fu">++</span> nm <span class="fu">++</span> <span class="st">&quot;.lhs&quot;</span></a>
<a class="sourceLine" id="cb4-14" title="14">    htm <span class="fu">=</span> <span class="st">&quot;re-&quot;</span> <span class="fu">++</span> nm <span class="fu">++</span> <span class="st">&quot;.html&quot;</span></a>
<a class="sourceLine" id="cb4-15" title="15">    mst <span class="fu">=</span> <span class="st">&quot;re-&quot;</span> <span class="fu">++</span> nm <span class="fu">++</span> <span class="st">&quot;-master.lhs&quot;</span></a></code></pre></div>
<h2 id="the-tutorial-preprocessor">The Tutorial Preprocessor</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="co">-- | the MODE determines whether we are generating documentation</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">-- or a Haskell testsuite and includes any IO-accessible state</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="co">-- needed by the relevant processor</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">data</span> <span class="dt">MODE</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="fu">=</span> <span class="dt">Doc</span>           <span class="co">-- ^ generating mardown+lhs input for pandoc</span></a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="fu">|</span> <span class="dt">Gen</span> <span class="dt">GenState</span>  <span class="co">-- ^ adjusting-the-program-for-testing state</span></a></code></pre></div>
<p>The <code>DocState</code> is initialised to <code>Outside</code> and flips though the different states as it traverses a code block, so that we can wrap code blocks in special <code>&lt;div class=&quot;replcodeblock&quot;&gt;</code> blocks when their first line indicates that it contains a REPL calculation, which the style sheet can pick up and present accordingly.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="co">-- | the state is the accumulated test function identifiers for</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">-- generating the list of them gets added to the end of the programme</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="kw">type</span> <span class="dt">GenState</span> <span class="fu">=</span> <span class="dt">IORef</span> [<span class="dt">String</span>]</a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="ot">genMode ::</span> <span class="dt">IO</span> <span class="dt">MODE</span></a>
<a class="sourceLine" id="cb6-6" title="6">genMode <span class="fu">=</span> <span class="dt">Gen</span> <span class="fu">&lt;$&gt;</span> newIORef []</a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="ot">prepare_tutorial ::</span> <span class="dt">MODE</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb7-2" title="2">prepare_tutorial mode fp_in fp_out <span class="fu">=</span></a>
<a class="sourceLine" id="cb7-3" title="3">  LBS.readFile fp_in <span class="fu">&gt;&gt;=</span> prep_tutorial_pp mode <span class="fu">&gt;&gt;=</span> incld <span class="fu">&gt;&gt;=</span></a>
<a class="sourceLine" id="cb7-4" title="4">    LBS.writeFile fp_out <span class="fu">.</span> sortImports</a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-6" title="6">    incld <span class="fu">=</span> <span class="kw">case</span> mode <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-7" title="7">      <span class="dt">Doc</span>   <span class="ot">-&gt;</span> include_code_pp</a>
<a class="sourceLine" id="cb7-8" title="8">      <span class="dt">Gen</span> _ <span class="ot">-&gt;</span> <span class="fu">return</span></a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="ot">prep_tutorial_pp ::</span> <span class="dt">MODE</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb8-2" title="2">prep_tutorial_pp mode <span class="fu">=</span></a>
<a class="sourceLine" id="cb8-3" title="3">  sed&#39; <span class="fu">$</span> <span class="dt">Select</span></a>
<a class="sourceLine" id="cb8-4" title="4">    [ <span class="dt">LineEdit</span> [re|^%main ${arg}(top|bottom)$|]                            <span class="fu">$</span> main_    mode</a>
<a class="sourceLine" id="cb8-5" title="5">    , <span class="dt">LineEdit</span> [re|^import *TestKit$|]                                     <span class="fu">$</span> hide     mode</a>
<a class="sourceLine" id="cb8-6" title="6">    , <span class="dt">LineEdit</span> [re|^\{-# OPTIONS_GHC -fno-warn-missing-signatures *#-\}$|] <span class="fu">$</span> hide     mode</a>
<a class="sourceLine" id="cb8-7" title="7">    , <span class="dt">Function</span> [re|^${fn}(evalme@{%id}) += +(checkThis|checkThisWith +@{%id}) +${arg}(@{%string}) +\(${ans}([^)]+)\) +\$ +\(${exp}(.*)\)$|]</a>
<a class="sourceLine" id="cb8-8" title="8">                                                                       <span class="dt">TOP</span> <span class="fu">$</span> evalme   mode</a>
<a class="sourceLine" id="cb8-9" title="9">    , <span class="dt">Function</span> [re|^${fn}(evalme@{%id}) += +(checkThis|checkThisWith +@{%id}) +${arg}(@{%string}) +\(${ans}([^)]+)\) +\$ +${exp}(.*)$|]</a>
<a class="sourceLine" id="cb8-10" title="10">                                                                       <span class="dt">TOP</span> <span class="fu">$</span> evalme   mode</a>
<a class="sourceLine" id="cb8-11" title="11">    , <span class="dt">Function</span> [re|^.*$|]                                              <span class="dt">TOP</span> <span class="fu">$</span> passthru</a>
<a class="sourceLine" id="cb8-12" title="12">    ]</a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="ot">evalme ::</span> <span class="dt">MODE</span></a>
<a class="sourceLine" id="cb9-2" title="2">       <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb9-3" title="3">       <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb9-4" title="4">       <span class="ot">-&gt;</span> <span class="dt">RELocation</span></a>
<a class="sourceLine" id="cb9-5" title="5">       <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb9-6" title="6">       <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb9-7" title="7">evalme  <span class="dt">Doc</span>     <span class="fu">=</span> evalmeDoc</a>
<a class="sourceLine" id="cb9-8" title="8">evalme (<span class="dt">Gen</span> gs) <span class="fu">=</span> evalmeGen  gs</a>
<a class="sourceLine" id="cb9-9" title="9"></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="ot">main_ ::</span> <span class="dt">MODE</span></a>
<a class="sourceLine" id="cb9-11" title="11">      <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb9-12" title="12">      <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb9-13" title="13">      <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb9-14" title="14">main_   <span class="dt">Doc</span>     <span class="fu">=</span> delete</a>
<a class="sourceLine" id="cb9-15" title="15">main_  (<span class="dt">Gen</span> gs) <span class="fu">=</span> mainGen    gs</a>
<a class="sourceLine" id="cb9-16" title="16"></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="ot">hide ::</span> <span class="dt">MODE</span></a>
<a class="sourceLine" id="cb9-18" title="18">     <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb9-19" title="19">     <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb9-20" title="20">    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb9-21" title="21">hide  <span class="dt">Doc</span>    <span class="fu">=</span> delete</a>
<a class="sourceLine" id="cb9-22" title="22">hide (<span class="dt">Gen</span> _) <span class="fu">=</span> passthru_</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="ot">evalmeDoc ::</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb10-2" title="2">          <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb10-3" title="3">          <span class="ot">-&gt;</span> <span class="dt">RELocation</span></a>
<a class="sourceLine" id="cb10-4" title="4">          <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb10-5" title="5">          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb10-6" title="6">evalmeDoc _ mtch _ _ <span class="fu">=</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="fu">$</span> <span class="fu">flip</span> replace mtch <span class="fu">$</span> LBS.intercalate <span class="st">&quot;\n&quot;</span></a>
<a class="sourceLine" id="cb10-7" title="7">  [ <span class="st">&quot;ghci&gt; ${exp}&quot;</span></a>
<a class="sourceLine" id="cb10-8" title="8">  , <span class="st">&quot;${ans}&quot;</span></a>
<a class="sourceLine" id="cb10-9" title="9">  ]</a></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="ot">evalmeGen ::</span> <span class="dt">GenState</span></a>
<a class="sourceLine" id="cb11-2" title="2">          <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb11-3" title="3">          <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb11-4" title="4">          <span class="ot">-&gt;</span> <span class="dt">RELocation</span></a>
<a class="sourceLine" id="cb11-5" title="5">          <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb11-6" title="6">          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb11-7" title="7">evalmeGen gs _ mtch0 _ _ <span class="fu">=</span> <span class="dt">Just</span> <span class="fu">&lt;$&gt;</span></a>
<a class="sourceLine" id="cb11-8" title="8">    replaceCapturesM replaceMethods <span class="dt">ALL</span> f mtch0</a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-10" title="10">    f mtch loc _ <span class="fu">=</span></a>
<a class="sourceLine" id="cb11-11" title="11">      <span class="kw">case</span> locationCapture loc <span class="fu">==</span> arg_i <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-12" title="12">        <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-13" title="13">            modifyIORef gs (ide<span class="fu">:</span>)</a>
<a class="sourceLine" id="cb11-14" title="14">            <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="fu">$</span> LBS.pack <span class="fu">$</span> <span class="fu">show</span> ide</a>
<a class="sourceLine" id="cb11-15" title="15">          <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-16" title="16">            ide <span class="fu">=</span> LBS.unpack <span class="fu">$</span> captureText [cp|fn|] mtch</a>
<a class="sourceLine" id="cb11-17" title="17">        <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb11-18" title="18"></a>
<a class="sourceLine" id="cb11-19" title="19">    arg_i <span class="fu">=</span> <span class="fu">either</span> oops <span class="fu">id</span> <span class="fu">$</span> findCaptureID [cp|arg|] <span class="fu">$</span> captureNames mtch0</a>
<a class="sourceLine" id="cb11-20" title="20"></a>
<a class="sourceLine" id="cb11-21" title="21">    oops  <span class="fu">=</span> <span class="fu">error</span> <span class="st">&quot;evalmeGen: confused captures!&quot;</span></a></code></pre></div>
<p>How are we doing?</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1"><span class="ot">mainGen ::</span> <span class="dt">GenState</span></a>
<a class="sourceLine" id="cb12-2" title="2">        <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb12-3" title="3">        <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb12-4" title="4">        <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb12-5" title="5">mainGen gs _ mtchs <span class="fu">=</span> <span class="kw">case</span> allMatches mtchs <span class="kw">of</span></a>
<a class="sourceLine" id="cb12-6" title="6">  [mtch]  <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="kw">case</span> captureText [cp|arg|] <span class="fu">$</span> mtch <span class="kw">of</span></a>
<a class="sourceLine" id="cb12-8" title="8">      <span class="st">&quot;top&quot;</span>    <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">ReplaceWith</span> <span class="fu">$</span> LBS.unlines <span class="fu">$</span></a>
<a class="sourceLine" id="cb12-9" title="9">          [ begin_code</a>
<a class="sourceLine" id="cb12-10" title="10">          , <span class="st">&quot;module Main(main) where&quot;</span></a>
<a class="sourceLine" id="cb12-11" title="11">          , end_code</a>
<a class="sourceLine" id="cb12-12" title="12">          , <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb12-13" title="13">          , <span class="st">&quot;*********************************************************&quot;</span></a>
<a class="sourceLine" id="cb12-14" title="14">          , <span class="st">&quot;*&quot;</span></a>
<a class="sourceLine" id="cb12-15" title="15">          , <span class="st">&quot;* WARNING: this is generated from pp-tutorial-master.lhs &quot;</span></a>
<a class="sourceLine" id="cb12-16" title="16">          , <span class="st">&quot;*&quot;</span></a>
<a class="sourceLine" id="cb12-17" title="17">          , <span class="st">&quot;*********************************************************&quot;</span></a>
<a class="sourceLine" id="cb12-18" title="18">          ]</a>
<a class="sourceLine" id="cb12-19" title="19">      <span class="st">&quot;bottom&quot;</span> <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb12-20" title="20">        fns <span class="ot">&lt;-</span> readIORef gs</a>
<a class="sourceLine" id="cb12-21" title="21">        <span class="fu">return</span> <span class="fu">$</span> <span class="dt">ReplaceWith</span> <span class="fu">$</span> LBS.unlines <span class="fu">$</span></a>
<a class="sourceLine" id="cb12-22" title="22">          [ begin_code</a>
<a class="sourceLine" id="cb12-23" title="23">          , <span class="st">&quot;main :: IO ()&quot;</span></a>
<a class="sourceLine" id="cb12-24" title="24">          , <span class="st">&quot;main = runTheTests&quot;</span></a>
<a class="sourceLine" id="cb12-25" title="25">          ] <span class="fu">++</span> mk_list fns <span class="fu">++</span></a>
<a class="sourceLine" id="cb12-26" title="26">          [ end_code</a>
<a class="sourceLine" id="cb12-27" title="27">          ]</a>
<a class="sourceLine" id="cb12-28" title="28">      _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;mainGen (b)&quot;</span></a>
<a class="sourceLine" id="cb12-29" title="29">  _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;mainGen (a)&quot;</span></a></code></pre></div>
<p>We cannot place these strings inline without confusing pandoc so we use these definitions instead.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">begin_code,<span class="ot"> end_code ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb13-2" title="2">begin_code <span class="fu">=</span> <span class="st">&quot;\\&quot;</span> <span class="fu">M.&lt;&gt;</span>  <span class="st">&quot;begin{code}&quot;</span></a>
<a class="sourceLine" id="cb13-3" title="3">end_code   <span class="fu">=</span> <span class="st">&quot;\\&quot;</span> <span class="fu">M.&lt;&gt;</span>  <span class="st">&quot;end{code}&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="ot">mk_list ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> [<span class="dt">LBS.ByteString</span>]</a>
<a class="sourceLine" id="cb14-2" title="2">mk_list []          <span class="fu">=</span> [<span class="st">&quot;  []&quot;</span>]</a>
<a class="sourceLine" id="cb14-3" title="3">mk_list (ide0<span class="fu">:</span>ides) <span class="fu">=</span> f <span class="st">&quot;[&quot;</span> ide0 <span class="fu">$</span> <span class="fu">foldr</span> (f <span class="st">&quot;,&quot;</span>) [<span class="st">&quot;  ]&quot;</span>] ides</a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb14-5" title="5">    f pfx ide t <span class="fu">=</span> (<span class="st">&quot;  &quot;</span> <span class="fu">M.&lt;&gt;</span> pfx <span class="fu">M.&lt;&gt;</span> <span class="st">&quot; &quot;</span> <span class="fu">M.&lt;&gt;</span> LBS.pack ide) <span class="fu">:</span> t</a></code></pre></div>
<h2 id="include_code_pp">include_code_pp</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1"><span class="ot">include_code_pp ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb15-2" title="2">include_code_pp <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-3" title="3">  sed&#39; <span class="fu">$</span> <span class="dt">Select</span></a>
<a class="sourceLine" id="cb15-4" title="4">    [ <span class="dt">Function</span> [re|^%include ${file}(@{%string}) ${rex}(@{%string})$|] <span class="dt">TOP</span>  inc_code</a>
<a class="sourceLine" id="cb15-5" title="5">    , <span class="dt">Function</span> [re|^.*$|]                                              <span class="dt">TOP</span>  passthru</a>
<a class="sourceLine" id="cb15-6" title="6">    ]</a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1"><span class="ot">inc_code ::</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb16-2" title="2">         <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb16-3" title="3">         <span class="ot">-&gt;</span> <span class="dt">RELocation</span></a>
<a class="sourceLine" id="cb16-4" title="4">         <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb16-5" title="5">         <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb16-6" title="6">inc_code _ mtch _ _ <span class="fu">=</span> <span class="fu">fmap</span> <span class="dt">Just</span> <span class="fu">$</span></a>
<a class="sourceLine" id="cb16-7" title="7">    extract fp <span class="fu">=&lt;&lt;</span> compileRegex re_s</a>
<a class="sourceLine" id="cb16-8" title="8">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb16-9" title="9">    fp    <span class="fu">=</span> prs_s <span class="fu">$</span> captureText [cp|file|] mtch</a>
<a class="sourceLine" id="cb16-10" title="10">    re_s  <span class="fu">=</span> prs_s <span class="fu">$</span> captureText [cp|rex|]  mtch</a>
<a class="sourceLine" id="cb16-11" title="11"></a>
<a class="sourceLine" id="cb16-12" title="12">    prs_s <span class="fu">=</span> <span class="fu">maybe</span> (<span class="fu">error</span> <span class="st">&quot;include_code&quot;</span>) T.unpack <span class="fu">.</span> parseString</a></code></pre></div>
<h2 id="passthru-and-delete-actions">passthru and delete actions</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1"><span class="ot">passthru ::</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb17-2" title="2">         <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb17-3" title="3">         <span class="ot">-&gt;</span> <span class="dt">RELocation</span></a>
<a class="sourceLine" id="cb17-4" title="4">         <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb17-5" title="5">         <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb17-6" title="6">passthru _ _ _ _ <span class="fu">=</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="ot">passthru_ ::</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb17-9" title="9">          <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb17-10" title="10">          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb17-11" title="11">passthru_ _ _ <span class="fu">=</span> <span class="fu">return</span> <span class="dt">NoEdit</span></a>
<a class="sourceLine" id="cb17-12" title="12"></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="ot">delete ::</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb17-14" title="14">       <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb17-15" title="15">       <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb17-16" title="16">delete _ _ <span class="fu">=</span> <span class="fu">return</span> <span class="dt">Delete</span></a></code></pre></div>
<h2 id="extracting-a-literate-fragment-from-a-haskell-program-text">Extracting a Literate Fragment from a Haskell Program Text</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1"><span class="ot">extract ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">RE</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb18-2" title="2">extract fp rex <span class="fu">=</span> extr <span class="fu">.</span> LBS.lines <span class="fu">&lt;$&gt;</span> LBS.readFile fp</a>
<a class="sourceLine" id="cb18-3" title="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb18-4" title="4">    extr lns <span class="fu">=</span></a>
<a class="sourceLine" id="cb18-5" title="5">      <span class="kw">case</span> parse <span class="fu">$</span> scan rex lns <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-6" title="6">        <span class="dt">Nothing</span>      <span class="ot">-&gt;</span> oops</a>
<a class="sourceLine" id="cb18-7" title="7">        <span class="dt">Just</span> (lno,n) <span class="ot">-&gt;</span> LBS.unlines <span class="fu">$</span> (hdr <span class="fu">:</span>) <span class="fu">$</span> (<span class="fu">take</span> n <span class="fu">$</span> <span class="fu">drop</span> i lns) <span class="fu">++</span> [ftr]</a>
<a class="sourceLine" id="cb18-8" title="8">          <span class="kw">where</span></a>
<a class="sourceLine" id="cb18-9" title="9">            i <span class="fu">=</span> getZeroBasedLineNo lno</a>
<a class="sourceLine" id="cb18-10" title="10"></a>
<a class="sourceLine" id="cb18-11" title="11">    oops <span class="fu">=</span> <span class="fu">error</span> <span class="fu">$</span> <span class="fu">concat</span></a>
<a class="sourceLine" id="cb18-12" title="12">      [ <span class="st">&quot;failed to locate fragment matching &quot;</span></a>
<a class="sourceLine" id="cb18-13" title="13">      , <span class="fu">show</span> <span class="fu">$</span> reSource rex</a>
<a class="sourceLine" id="cb18-14" title="14">      , <span class="st">&quot; in file &quot;</span></a>
<a class="sourceLine" id="cb18-15" title="15">      , <span class="fu">show</span> fp</a>
<a class="sourceLine" id="cb18-16" title="16">      ]</a>
<a class="sourceLine" id="cb18-17" title="17"></a>
<a class="sourceLine" id="cb18-18" title="18">    hdr  <span class="fu">=</span> <span class="st">&quot;&lt;div class=&#39;includedcodeblock&#39;&gt;&quot;</span></a>
<a class="sourceLine" id="cb18-19" title="19">    ftr  <span class="fu">=</span> <span class="st">&quot;&lt;/div&gt;&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1"><span class="ot">parse ::</span> [<span class="dt">Token</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">LineNo</span>,<span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb19-2" title="2">parse []       <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb19-3" title="3">parse (tk<span class="fu">:</span>tks) <span class="fu">=</span> <span class="kw">case</span> (tk,tks) <span class="kw">of</span></a>
<a class="sourceLine" id="cb19-4" title="4">  (<span class="dt">Bra</span> b_ln,<span class="dt">Hit</span><span class="fu">:</span><span class="dt">Ket</span> k_ln<span class="fu">:</span>_) <span class="ot">-&gt;</span> <span class="dt">Just</span> (b_ln,count_lines_incl b_ln k_ln)</a>
<a class="sourceLine" id="cb19-5" title="5">  _                         <span class="ot">-&gt;</span> parse tks</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1"><span class="ot">count_lines_incl ::</span> <span class="dt">LineNo</span> <span class="ot">-&gt;</span> <span class="dt">LineNo</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb20-2" title="2">count_lines_incl b_ln k_ln <span class="fu">=</span></a>
<a class="sourceLine" id="cb20-3" title="3">  getZeroBasedLineNo k_ln <span class="fu">+</span> <span class="dv">1</span> <span class="fu">-</span> getZeroBasedLineNo b_ln</a></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">data</span> <span class="dt">Token</span> <span class="fu">=</span> <span class="dt">Bra</span> <span class="dt">LineNo</span> <span class="fu">|</span> <span class="dt">Hit</span> <span class="fu">|</span> <span class="dt">Ket</span> <span class="dt">LineNo</span>   <span class="kw">deriving</span> (<span class="dt">Show</span>)</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" title="1"><span class="ot">scan ::</span> <span class="dt">RE</span> <span class="ot">-&gt;</span> [<span class="dt">LBS.ByteString</span>] <span class="ot">-&gt;</span> [<span class="dt">Token</span>]</a>
<a class="sourceLine" id="cb22-2" title="2">scan rex <span class="fu">=</span> grepWithScript</a>
<a class="sourceLine" id="cb22-3" title="3">    [ (,) [re|\\begin\{code\}|] <span class="fu">$</span> \i <span class="ot">-&gt;</span> chk <span class="fu">$</span> <span class="dt">Bra</span> i</a>
<a class="sourceLine" id="cb22-4" title="4">    , (,) rex                   <span class="fu">$</span> \_ <span class="ot">-&gt;</span> chk   <span class="dt">Hit</span></a>
<a class="sourceLine" id="cb22-5" title="5">    , (,) [re|\\end\{code\}|]   <span class="fu">$</span> \i <span class="ot">-&gt;</span> chk <span class="fu">$</span> <span class="dt">Ket</span> i</a>
<a class="sourceLine" id="cb22-6" title="6">    ]</a>
<a class="sourceLine" id="cb22-7" title="7">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb22-8" title="8">    chk x mtchs <span class="fu">=</span> <span class="kw">case</span> anyMatches mtchs <span class="kw">of</span></a>
<a class="sourceLine" id="cb22-9" title="9">      <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="dt">Just</span> x</a>
<a class="sourceLine" id="cb22-10" title="10">      <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a></code></pre></div>
<h2 id="badges">badges</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" title="1"><span class="ot">badges ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb23-2" title="2">badges <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb23-3" title="3">    <span class="fu">mapM_</span> collect</a>
<a class="sourceLine" id="cb23-4" title="4">      [ (,) <span class="st">&quot;license&quot;</span>             <span class="st">&quot;https://img.shields.io/badge/license-BSD3-brightgreen.svg&quot;</span></a>
<a class="sourceLine" id="cb23-5" title="5">      , (,) <span class="st">&quot;unix-build&quot;</span>          <span class="st">&quot;https://img.shields.io/travis/iconnect/regex.svg?label=Linux%2BmacOS&quot;</span></a>
<a class="sourceLine" id="cb23-6" title="6">      , (,) <span class="st">&quot;windows-build&quot;</span>       <span class="st">&quot;https://img.shields.io/appveyor/ci/cdornan/regex.svg?label=Windows&quot;</span></a>
<a class="sourceLine" id="cb23-7" title="7">      , (,) <span class="st">&quot;coverage&quot;</span>            <span class="st">&quot;https://img.shields.io/coveralls/iconnect/regex.svg&quot;</span></a>
<a class="sourceLine" id="cb23-8" title="8">      , (,) <span class="st">&quot;build-status&quot;</span>        <span class="st">&quot;https://img.shields.io/travis/iconnect/regex.svg?label=Build%20Status&quot;</span></a>
<a class="sourceLine" id="cb23-9" title="9">      , (,) <span class="st">&quot;maintainers-contact&quot;</span> <span class="st">&quot;https://img.shields.io/badge/email-maintainers%40regex.uk-blue.svg&quot;</span></a>
<a class="sourceLine" id="cb23-10" title="10">      , (,) <span class="st">&quot;feedback-contact&quot;</span>    <span class="st">&quot;https://img.shields.io/badge/email-feedback%40regex.uk-blue.svg&quot;</span></a>
<a class="sourceLine" id="cb23-11" title="11">      ]</a>
<a class="sourceLine" id="cb23-12" title="12">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb23-13" title="13">    collect (nm,url) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb23-14" title="14">      <span class="fu">putStrLn</span> <span class="fu">$</span> <span class="st">&quot;updating badge: &quot;</span> <span class="fu">++</span> nm</a>
<a class="sourceLine" id="cb23-15" title="15">      simpleHttp url <span class="fu">&gt;&gt;=</span> LBS.writeFile (badge_fn nm)</a>
<a class="sourceLine" id="cb23-16" title="16"></a>
<a class="sourceLine" id="cb23-17" title="17">    badge_fn nm <span class="fu">=</span> <span class="st">&quot;docs/badges/&quot;</span><span class="fu">++</span>nm<span class="fu">++</span><span class="st">&quot;.svg&quot;</span></a></code></pre></div>
<h2 id="blog_badge">blog_badge</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1"><span class="ot">blog_badge ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb24-2" title="2">blog_badge <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb24-3" title="3">  dts <span class="ot">&lt;-</span> L.sortBy (<span class="fu">flip</span> <span class="fu">compare</span>) <span class="fu">.</span> <span class="fu">map</span> (<span class="fu">take</span> <span class="dv">10</span>) <span class="fu">&lt;$&gt;</span></a>
<a class="sourceLine" id="cb24-4" title="4">            getDirectoryContents <span class="st">&quot;../regex-blog/posts&quot;</span></a>
<a class="sourceLine" id="cb24-5" title="5">  <span class="kw">case</span> dts <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-6" title="6">    []   <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;No posts found!&quot;</span></a>
<a class="sourceLine" id="cb24-7" title="7">    dt<span class="fu">:</span>_ <span class="ot">-&gt;</span> <span class="kw">case</span> matched <span class="fu">$</span> dt_lbs <span class="fu">?=~</span> date_re <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-8" title="8">        <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="fu">$</span> <span class="st">&quot;Post date format not recognised: &quot;</span> <span class="fu">++</span> dt</a>
<a class="sourceLine" id="cb24-9" title="9">        <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb24-10" title="10">          <span class="fu">putStrLn</span> <span class="fu">$</span> <span class="st">&quot;Latest blog is: &quot;</span> <span class="fu">++</span> dt</a>
<a class="sourceLine" id="cb24-11" title="11">          lbs <span class="ot">&lt;-</span> lbsReadFile badges_file</a>
<a class="sourceLine" id="cb24-12" title="12">          LBS.writeFile badges_file <span class="fu">$</span> replaceAll dt_lbs <span class="fu">$</span> lbs <span class="fu">*=~</span> date_re</a>
<a class="sourceLine" id="cb24-13" title="13">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb24-14" title="14">        dt_lbs      <span class="fu">=</span> LBS.pack dt</a>
<a class="sourceLine" id="cb24-15" title="15">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb24-16" title="16">    date_re     <span class="fu">=</span> [re|[0-9]{4}-[0-9]{2}-[0-9]{2}|]</a>
<a class="sourceLine" id="cb24-17" title="17">    badges_file <span class="fu">=</span> <span class="st">&quot;docs/badges/blog.svg&quot;</span></a></code></pre></div>
<h2 id="pages">pages</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" title="1"><span class="ot">pages ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb25-2" title="2">pages <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb25-3" title="3">  prep_page <span class="st">&quot;regex&quot;</span>          <span class="dt">MM_hackage</span> <span class="st">&quot;lib/md/index.md&quot;</span> <span class="st">&quot;lib/README-regex.md&quot;</span></a>
<a class="sourceLine" id="cb25-4" title="4">  prep_page <span class="st">&quot;regex-examples&quot;</span> <span class="dt">MM_hackage</span> <span class="st">&quot;lib/md/index.md&quot;</span> <span class="st">&quot;lib/README-regex-examples.md&quot;</span></a>
<a class="sourceLine" id="cb25-5" title="5">  prep_page <span class="st">&quot;regex&quot;</span>          <span class="dt">MM_github</span>  <span class="st">&quot;lib/md/index.md&quot;</span> <span class="st">&quot;README.md&quot;</span></a>
<a class="sourceLine" id="cb25-6" title="6">  <span class="fu">mapM_</span> pandoc_page [<span class="fu">minBound..maxBound</span>]</a></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">data</span> <span class="dt">Page</span></a>
<a class="sourceLine" id="cb26-2" title="2">  <span class="fu">=</span> <span class="dt">PG_index</span></a>
<a class="sourceLine" id="cb26-3" title="3">  <span class="fu">|</span> <span class="dt">PG_about</span></a>
<a class="sourceLine" id="cb26-4" title="4">  <span class="fu">|</span> <span class="dt">PG_reblog</span></a>
<a class="sourceLine" id="cb26-5" title="5">  <span class="fu">|</span> <span class="dt">PG_contact</span></a>
<a class="sourceLine" id="cb26-6" title="6">  <span class="fu">|</span> <span class="dt">PG_build_status</span></a>
<a class="sourceLine" id="cb26-7" title="7">  <span class="fu">|</span> <span class="dt">PG_installation</span></a>
<a class="sourceLine" id="cb26-8" title="8">  <span class="fu">|</span> <span class="dt">PG_tutorial</span></a>
<a class="sourceLine" id="cb26-9" title="9">  <span class="fu">|</span> <span class="dt">PG_examples</span></a>
<a class="sourceLine" id="cb26-10" title="10">  <span class="fu">|</span> <span class="dt">PG_roadmap</span></a>
<a class="sourceLine" id="cb26-11" title="11">  <span class="fu">|</span> <span class="dt">PG_macros</span></a>
<a class="sourceLine" id="cb26-12" title="12">  <span class="fu">|</span> <span class="dt">PG_directory</span></a>
<a class="sourceLine" id="cb26-13" title="13">  <span class="fu">|</span> <span class="dt">PG_changelog</span></a>
<a class="sourceLine" id="cb26-14" title="14">  <span class="kw">deriving</span> (<span class="dt">Bounded</span>,<span class="dt">Enum</span>,<span class="dt">Eq</span>,<span class="dt">Ord</span>,<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb26-15" title="15"></a>
<a class="sourceLine" id="cb26-16" title="16"><span class="ot">page_root ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb26-17" title="17">page_root <span class="fu">=</span> <span class="fu">map</span> tr <span class="fu">.</span> <span class="fu">drop</span> <span class="dv">3</span> <span class="fu">.</span> <span class="fu">show</span></a>
<a class="sourceLine" id="cb26-18" title="18">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb26-19" title="19">    tr <span class="ch">&#39;_&#39;</span> <span class="fu">=</span> <span class="ch">&#39;-&#39;</span></a>
<a class="sourceLine" id="cb26-20" title="20">    tr c   <span class="fu">=</span> c</a>
<a class="sourceLine" id="cb26-21" title="21"></a>
<a class="sourceLine" id="cb26-22" title="22">page_master_file,<span class="ot"> page_docs_file ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span></a>
<a class="sourceLine" id="cb26-23" title="23">page_master_file pg <span class="fu">=</span> <span class="st">&quot;lib/md/&quot;</span> <span class="fu">++</span> page_root pg <span class="fu">++</span> <span class="st">&quot;.md&quot;</span></a>
<a class="sourceLine" id="cb26-24" title="24">page_docs_file   pg <span class="fu">=</span> <span class="st">&quot;docs/&quot;</span>   <span class="fu">++</span> page_root pg <span class="fu">++</span> <span class="st">&quot;.html&quot;</span></a>
<a class="sourceLine" id="cb26-25" title="25"></a>
<a class="sourceLine" id="cb26-26" title="26"><span class="ot">page_address ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb26-27" title="27">page_address <span class="dt">PG_reblog</span> <span class="fu">=</span> <span class="st">&quot;blog&quot;</span></a>
<a class="sourceLine" id="cb26-28" title="28">page_address pg        <span class="fu">=</span> LBS.pack <span class="fu">$</span> page_root pg</a>
<a class="sourceLine" id="cb26-29" title="29"></a>
<a class="sourceLine" id="cb26-30" title="30"><span class="ot">page_title ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb26-31" title="31">page_title pg <span class="fu">=</span> <span class="kw">case</span> pg <span class="kw">of</span></a>
<a class="sourceLine" id="cb26-32" title="32">  <span class="dt">PG_index</span>        <span class="ot">-&gt;</span> <span class="st">&quot;Home&quot;</span></a>
<a class="sourceLine" id="cb26-33" title="33">  <span class="dt">PG_about</span>        <span class="ot">-&gt;</span> <span class="st">&quot;About&quot;</span></a>
<a class="sourceLine" id="cb26-34" title="34">  <span class="dt">PG_reblog</span>       <span class="ot">-&gt;</span> <span class="st">&quot;Blog&quot;</span></a>
<a class="sourceLine" id="cb26-35" title="35">  <span class="dt">PG_contact</span>      <span class="ot">-&gt;</span> <span class="st">&quot;Contact&quot;</span></a>
<a class="sourceLine" id="cb26-36" title="36">  <span class="dt">PG_build_status</span> <span class="ot">-&gt;</span> <span class="st">&quot;Build Status&quot;</span></a>
<a class="sourceLine" id="cb26-37" title="37">  <span class="dt">PG_installation</span> <span class="ot">-&gt;</span> <span class="st">&quot;Installation&quot;</span></a>
<a class="sourceLine" id="cb26-38" title="38">  <span class="dt">PG_tutorial</span>     <span class="ot">-&gt;</span> <span class="st">&quot;Tutorial&quot;</span></a>
<a class="sourceLine" id="cb26-39" title="39">  <span class="dt">PG_examples</span>     <span class="ot">-&gt;</span> <span class="st">&quot;Examples&quot;</span></a>
<a class="sourceLine" id="cb26-40" title="40">  <span class="dt">PG_roadmap</span>      <span class="ot">-&gt;</span> <span class="st">&quot;Roadmap&quot;</span></a>
<a class="sourceLine" id="cb26-41" title="41">  <span class="dt">PG_macros</span>       <span class="ot">-&gt;</span> <span class="st">&quot;Macro Tables&quot;</span></a>
<a class="sourceLine" id="cb26-42" title="42">  <span class="dt">PG_directory</span>    <span class="ot">-&gt;</span> <span class="st">&quot;Directory&quot;</span></a>
<a class="sourceLine" id="cb26-43" title="43">  <span class="dt">PG_changelog</span>    <span class="ot">-&gt;</span> <span class="st">&quot;Change Log&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" title="1"><span class="ot">pandoc_page ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb27-2" title="2">pandoc_page pg <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb27-3" title="3">  mt_lbs <span class="ot">&lt;-</span> setup_ttl <span class="fu">&lt;$&gt;</span> LBS.readFile (page_master_file pg)</a>
<a class="sourceLine" id="cb27-4" title="4">  (hdgs,md_lbs) <span class="ot">&lt;-</span> prep_page&#39; <span class="dt">MM_pandoc</span> mt_lbs</a>
<a class="sourceLine" id="cb27-5" title="5">  LBS.writeFile <span class="st">&quot;tmp/metadata.markdown&quot;</span>  <span class="fu">$</span> LBS.unlines [<span class="st">&quot;---&quot;</span>,<span class="st">&quot;title: &quot;</span> <span class="fu">M.&lt;&gt;</span> page_title pg,<span class="st">&quot;---&quot;</span>]</a>
<a class="sourceLine" id="cb27-6" title="6">  LBS.writeFile <span class="st">&quot;tmp/heading.markdown&quot;</span>   <span class="fu">$</span> page_heading pg</a>
<a class="sourceLine" id="cb27-7" title="7">  LBS.writeFile <span class="st">&quot;tmp/page_pre_body.html&quot;</span> <span class="fu">$</span> mk_pre_body_html pg hdgs</a>
<a class="sourceLine" id="cb27-8" title="8">  LBS.writeFile <span class="st">&quot;tmp/page_pst_body.html&quot;</span>   pst_body_html</a>
<a class="sourceLine" id="cb27-9" title="9">  LBS.writeFile <span class="st">&quot;tmp/page.markdown&quot;</span>        md_lbs</a>
<a class="sourceLine" id="cb27-10" title="10">  SH.shelly <span class="fu">$</span> SH.verbosely <span class="fu">$</span></a>
<a class="sourceLine" id="cb27-11" title="11">    SH.run_ <span class="st">&quot;pandoc&quot;</span></a>
<a class="sourceLine" id="cb27-12" title="12">      [ <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;markdown+grid_tables+autolink_bare_uris&quot;</span></a>
<a class="sourceLine" id="cb27-13" title="13">      , <span class="st">&quot;-t&quot;</span>, <span class="st">&quot;html5&quot;</span></a>
<a class="sourceLine" id="cb27-14" title="14">      , <span class="st">&quot;-T&quot;</span>, <span class="st">&quot;regex&quot;</span></a>
<a class="sourceLine" id="cb27-15" title="15">      , <span class="st">&quot;-s&quot;</span></a>
<a class="sourceLine" id="cb27-16" title="16">      , <span class="st">&quot;-H&quot;</span>, <span class="st">&quot;lib/favicons.html&quot;</span></a>
<a class="sourceLine" id="cb27-17" title="17">      , <span class="st">&quot;-B&quot;</span>, <span class="st">&quot;tmp/page_pre_body.html&quot;</span></a>
<a class="sourceLine" id="cb27-18" title="18">      , <span class="st">&quot;-A&quot;</span>, <span class="st">&quot;tmp/page_pst_body.html&quot;</span></a>
<a class="sourceLine" id="cb27-19" title="19">      , <span class="st">&quot;-c&quot;</span>, <span class="st">&quot;lib/styles.css&quot;</span></a>
<a class="sourceLine" id="cb27-20" title="20">      , <span class="st">&quot;-o&quot;</span>, T.pack <span class="fu">$</span> page_docs_file pg</a>
<a class="sourceLine" id="cb27-21" title="21">      , <span class="st">&quot;tmp/metadata.markdown&quot;</span></a>
<a class="sourceLine" id="cb27-22" title="22">      , <span class="st">&quot;tmp/heading.markdown&quot;</span></a>
<a class="sourceLine" id="cb27-23" title="23">      , <span class="st">&quot;tmp/page.markdown&quot;</span></a>
<a class="sourceLine" id="cb27-24" title="24">      ]</a>
<a class="sourceLine" id="cb27-25" title="25">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb27-26" title="26">    setup_ttl <span class="fu">=</span> <span class="kw">case</span> pg <span class="kw">of</span></a>
<a class="sourceLine" id="cb27-27" title="27">      <span class="dt">PG_index</span> <span class="ot">-&gt;</span> set_title <span class="st">&quot;regex&quot;</span></a>
<a class="sourceLine" id="cb27-28" title="28">      _        <span class="ot">-&gt;</span> <span class="fu">id</span></a>
<a class="sourceLine" id="cb27-29" title="29"></a>
<a class="sourceLine" id="cb27-30" title="30"><span class="kw">data</span> <span class="dt">Heading</span> <span class="fu">=</span></a>
<a class="sourceLine" id="cb27-31" title="31">  <span class="dt">Heading</span></a>
<a class="sourceLine" id="cb27-32" title="32">    {<span class="ot"> _hdg_id    ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-33" title="33">    ,<span class="ot"> _hdg_title ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-34" title="34">    }</a>
<a class="sourceLine" id="cb27-35" title="35">  <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb27-36" title="36"></a>
<a class="sourceLine" id="cb27-37" title="37"><span class="kw">data</span> <span class="dt">MarkdownMode</span></a>
<a class="sourceLine" id="cb27-38" title="38">  <span class="fu">=</span> <span class="dt">MM_github</span></a>
<a class="sourceLine" id="cb27-39" title="39">  <span class="fu">|</span> <span class="dt">MM_hackage</span></a>
<a class="sourceLine" id="cb27-40" title="40">  <span class="fu">|</span> <span class="dt">MM_pandoc</span></a>
<a class="sourceLine" id="cb27-41" title="41">  <span class="kw">deriving</span> (<span class="dt">Eq</span>,<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb27-42" title="42"></a>
<a class="sourceLine" id="cb27-43" title="43"><span class="ot">page_heading ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-44" title="44">page_heading <span class="dt">PG_index</span> <span class="fu">=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb27-45" title="45">page_heading pg       <span class="fu">=</span></a>
<a class="sourceLine" id="cb27-46" title="46">  <span class="st">&quot;&lt;p class=&#39;pagebc&#39;&gt;&lt;a href=&#39;.&#39; title=&#39;Home&#39;&gt;Home&lt;/a&gt; &amp;raquo; **&quot;</span> <span class="fu">M.&lt;&gt;</span> page_title pg <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;**&lt;/p&gt;\n&quot;</span></a>
<a class="sourceLine" id="cb27-47" title="47"></a>
<a class="sourceLine" id="cb27-48" title="48"><span class="ot">prep_page ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">MarkdownMode</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb27-49" title="49">prep_page ttl mmd in_fp out_fp <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb27-50" title="50">  lbs      <span class="ot">&lt;-</span> set_title ttl <span class="fu">&lt;$&gt;</span> LBS.readFile in_fp</a>
<a class="sourceLine" id="cb27-51" title="51">  (_,lbs&#39;) <span class="ot">&lt;-</span> prep_page&#39; mmd lbs</a>
<a class="sourceLine" id="cb27-52" title="52">  LBS.writeFile out_fp lbs&#39;</a>
<a class="sourceLine" id="cb27-53" title="53"></a>
<a class="sourceLine" id="cb27-54" title="54"><span class="ot">set_title ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-55" title="55">set_title ttl lbs <span class="fu">=</span> fromMaybe oops <span class="fu">$</span> <span class="fu">flip</span> sed&#39; lbs <span class="fu">$</span> <span class="dt">Pipe</span></a>
<a class="sourceLine" id="cb27-56" title="56">    [ <span class="dt">Function</span> [re|&lt;&lt;\$title\$&gt;&gt;|] <span class="dt">TOP</span> <span class="fu">$</span> \_ _ _ _<span class="ot">-&gt;</span><span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> ttl</a>
<a class="sourceLine" id="cb27-57" title="57">    ]</a>
<a class="sourceLine" id="cb27-58" title="58">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb27-59" title="59">    <span class="co">-- runIdentity added to base in 4.9 only</span></a>
<a class="sourceLine" id="cb27-60" title="60">    oops <span class="fu">=</span> <span class="fu">error</span> <span class="st">&quot;set_title&quot;</span></a>
<a class="sourceLine" id="cb27-61" title="61"></a>
<a class="sourceLine" id="cb27-62" title="62"><span class="ot">prep_page&#39; ::</span> <span class="dt">MarkdownMode</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ([<span class="dt">Heading</span>],<span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb27-63" title="63">prep_page&#39; mmd lbs <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb27-64" title="64">    rf_h <span class="ot">&lt;-</span> newIORef []</a>
<a class="sourceLine" id="cb27-65" title="65">    rf_t <span class="ot">&lt;-</span> newIORef <span class="dt">False</span></a>
<a class="sourceLine" id="cb27-66" title="66">    lbs1 <span class="ot">&lt;-</span> <span class="fu">fmap</span> (tweak_md mmd) <span class="fu">$</span> sed&#39; (scr rf_h rf_t) <span class="fu">=&lt;&lt;</span> include lbs</a>
<a class="sourceLine" id="cb27-67" title="67">    lbs2 <span class="ot">&lt;-</span> fromMaybe <span class="st">&quot;&quot;</span> <span class="fu">&lt;$&gt;</span> fin_task_list&#39; mmd rf_t</a>
<a class="sourceLine" id="cb27-68" title="68">    hdgs <span class="ot">&lt;-</span> <span class="fu">reverse</span> <span class="fu">&lt;$&gt;</span> readIORef rf_h</a>
<a class="sourceLine" id="cb27-69" title="69">    <span class="fu">return</span> (hdgs,lbs1 <span class="fu">M.&lt;&gt;</span> lbs2)</a>
<a class="sourceLine" id="cb27-70" title="70">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb27-71" title="71">    scr rf_h rf_t <span class="fu">=</span> <span class="dt">Select</span></a>
<a class="sourceLine" id="cb27-72" title="72">      [ <span class="dt">Function</span> [re|^%heading#${ide}(@{%id}) +${ttl}([^ ].*)$|] <span class="dt">TOP</span> <span class="fu">$</span> heading       mmd rf_t rf_h</a>
<a class="sourceLine" id="cb27-73" title="73">      , <span class="dt">Function</span> [re|^- \[ \] +${itm}(.*)$|]                     <span class="dt">TOP</span> <span class="fu">$</span> task_list     mmd rf_t <span class="dt">False</span></a>
<a class="sourceLine" id="cb27-74" title="74">      , <span class="dt">Function</span> [re|^- \[[Xx]\] +${itm}(.*)$|]                  <span class="dt">TOP</span> <span class="fu">$</span> task_list     mmd rf_t <span class="dt">True</span></a>
<a class="sourceLine" id="cb27-75" title="75">      , <span class="dt">Function</span> [re|^.*$|]                                      <span class="dt">TOP</span> <span class="fu">$</span> fin_task_list mmd rf_t</a>
<a class="sourceLine" id="cb27-76" title="76">      ]</a>
<a class="sourceLine" id="cb27-77" title="77"></a>
<a class="sourceLine" id="cb27-78" title="78"><span class="ot">heading ::</span> <span class="dt">MarkdownMode</span></a>
<a class="sourceLine" id="cb27-79" title="79">        <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb27-80" title="80">        <span class="ot">-&gt;</span> <span class="dt">IORef</span> [<span class="dt">Heading</span>]</a>
<a class="sourceLine" id="cb27-81" title="81">        <span class="ot">-&gt;</span> <span class="dt">LineNo</span></a>
<a class="sourceLine" id="cb27-82" title="82">        <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-83" title="83">        <span class="ot">-&gt;</span> <span class="dt">RELocation</span></a>
<a class="sourceLine" id="cb27-84" title="84">        <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-85" title="85">        <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</a>
<a class="sourceLine" id="cb27-86" title="86">heading mmd rf_t rf_h _ mtch _ _ <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb27-87" title="87">    lbs <span class="ot">&lt;-</span> fromMaybe <span class="st">&quot;&quot;</span> <span class="fu">&lt;$&gt;</span> fin_task_list&#39; mmd rf_t</a>
<a class="sourceLine" id="cb27-88" title="88">    modifyIORef rf_h (<span class="dt">Heading</span> ide ttl<span class="fu">:</span>)</a>
<a class="sourceLine" id="cb27-89" title="89">    <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="fu">$</span> lbs <span class="fu">M.&lt;&gt;</span> h2</a>
<a class="sourceLine" id="cb27-90" title="90">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb27-91" title="91">    h2 <span class="fu">=</span> <span class="kw">case</span> mmd <span class="kw">of</span></a>
<a class="sourceLine" id="cb27-92" title="92">      <span class="dt">MM_github</span>  <span class="ot">-&gt;</span> <span class="st">&quot;## &quot;</span> <span class="fu">M.&lt;&gt;</span> ttl</a>
<a class="sourceLine" id="cb27-93" title="93">      <span class="dt">MM_hackage</span> <span class="ot">-&gt;</span> <span class="st">&quot;## &quot;</span> <span class="fu">M.&lt;&gt;</span> ttl</a>
<a class="sourceLine" id="cb27-94" title="94">      <span class="dt">MM_pandoc</span>  <span class="ot">-&gt;</span> <span class="st">&quot;&lt;h2 id=&#39;&quot;</span> <span class="fu">M.&lt;&gt;</span> ide <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;&#39;&gt;&quot;</span> <span class="fu">M.&lt;&gt;</span> ttl <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;&lt;/h2&gt;&quot;</span></a>
<a class="sourceLine" id="cb27-95" title="95"></a>
<a class="sourceLine" id="cb27-96" title="96">    ide <span class="fu">=</span> mtch <span class="fu">!$$</span> [cp|ide|]</a>
<a class="sourceLine" id="cb27-97" title="97">    ttl <span class="fu">=</span> mtch <span class="fu">!$$</span> [cp|ttl|]</a>
<a class="sourceLine" id="cb27-98" title="98"></a>
<a class="sourceLine" id="cb27-99" title="99"><span class="ot">mk_pre_body_html ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> [<span class="dt">Heading</span>] <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-100" title="100">mk_pre_body_html pg hdgs <span class="fu">=</span> hdr <span class="fu">M.&lt;&gt;</span> LBS.concat (<span class="fu">map</span> nav [<span class="fu">minBound..maxBound</span>]) <span class="fu">M.&lt;&gt;</span> ftr</a>
<a class="sourceLine" id="cb27-101" title="101">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb27-102" title="102"><span class="ot">    hdr ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-103" title="103">    hdr <span class="fu">=</span> [here|    &lt;div id=&quot;container&quot;&gt;</a>
<a class="sourceLine" id="cb27-104" title="104">    &lt;div id=&quot;sidebar&quot;&gt;</a>
<a class="sourceLine" id="cb27-105" title="105">      &lt;div id=&quot;corner&quot;&gt;</a>
<a class="sourceLine" id="cb27-106" title="106">        |] <span class="fu">M.&lt;&gt;</span> branding <span class="fu">M.&lt;&gt;</span> [here|</a>
<a class="sourceLine" id="cb27-107" title="107">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-108" title="108">      &lt;div class=&quot;widget&quot; id=&quot;pages&quot;&gt;</a>
<a class="sourceLine" id="cb27-109" title="109">        &lt;ul class=&quot;page-nav&quot;&gt;</a>
<a class="sourceLine" id="cb27-110" title="110">|]</a>
<a class="sourceLine" id="cb27-111" title="111"></a>
<a class="sourceLine" id="cb27-112" title="112">    nav dst_pg <span class="fu">=</span> LBS.unlines <span class="fu">$</span></a>
<a class="sourceLine" id="cb27-113" title="113">      nav_li <span class="st">&quot;          &quot;</span> pg_cls pg_adr pg_ttl <span class="fu">:</span></a>
<a class="sourceLine" id="cb27-114" title="114">        [ nav_li <span class="st">&quot;            &quot;</span> [<span class="st">&quot;secnav&quot;</span>] (<span class="st">&quot;#&quot;</span> <span class="fu">M.&lt;&gt;</span> _hdg_id) _hdg_title</a>
<a class="sourceLine" id="cb27-115" title="115">          <span class="fu">|</span> <span class="dt">Heading</span>{<span class="fu">..</span>} <span class="ot">&lt;-</span> hdgs</a>
<a class="sourceLine" id="cb27-116" title="116">          , is_moi</a>
<a class="sourceLine" id="cb27-117" title="117">          ]</a>
<a class="sourceLine" id="cb27-118" title="118">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb27-119" title="119">        pg_cls <span class="fu">=</span> [<span class="st">&quot;pagenav&quot;</span>,<span class="kw">if</span> is_moi <span class="kw">then</span> <span class="st">&quot;moi&quot;</span> <span class="kw">else</span> <span class="st">&quot;toi&quot;</span>]</a>
<a class="sourceLine" id="cb27-120" title="120">        pg_adr <span class="fu">=</span> page_address dst_pg</a>
<a class="sourceLine" id="cb27-121" title="121">        pg_ttl <span class="fu">=</span> page_title   dst_pg</a>
<a class="sourceLine" id="cb27-122" title="122">        is_moi <span class="fu">=</span> pg <span class="fu">==</span> dst_pg</a>
<a class="sourceLine" id="cb27-123" title="123"></a>
<a class="sourceLine" id="cb27-124" title="124">    nav_li pfx cls dst title <span class="fu">=</span> LBS.concat</a>
<a class="sourceLine" id="cb27-125" title="125">      [ pfx</a>
<a class="sourceLine" id="cb27-126" title="126">      , <span class="st">&quot;&lt;li class=&#39;&quot;</span></a>
<a class="sourceLine" id="cb27-127" title="127">      , LBS.unwords cls</a>
<a class="sourceLine" id="cb27-128" title="128">      , <span class="st">&quot;&#39;&gt;&lt;a href=&#39;&quot;</span></a>
<a class="sourceLine" id="cb27-129" title="129">      , dst</a>
<a class="sourceLine" id="cb27-130" title="130">      , <span class="st">&quot;&#39;&gt;&quot;</span></a>
<a class="sourceLine" id="cb27-131" title="131">      , title</a>
<a class="sourceLine" id="cb27-132" title="132">      , <span class="st">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span></a>
<a class="sourceLine" id="cb27-133" title="133">      ]</a>
<a class="sourceLine" id="cb27-134" title="134"></a>
<a class="sourceLine" id="cb27-135" title="135">    ftr <span class="fu">=</span> [here|          &lt;/ul&gt;</a>
<a class="sourceLine" id="cb27-136" title="136">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-137" title="137">      &lt;div class=&quot;supplementary widget&quot; id=&quot;github&quot;&gt;</a>
<a class="sourceLine" id="cb27-138" title="138">        &lt;a href=&quot;http://code.regex.uk&quot;&gt;&lt;img src=&quot;images/code.svg&quot; alt=&quot;github code&quot; /&gt; Code&lt;/a&gt;</a>
<a class="sourceLine" id="cb27-139" title="139">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-140" title="140">      &lt;div class=&quot;supplementary widget&quot; id=&quot;github-issues&quot;&gt;</a>
<a class="sourceLine" id="cb27-141" title="141">        &lt;a href=&quot;http://issues.regex.uk&quot;&gt;&lt;img src=&quot;images/issue-opened.svg&quot; alt=&quot;github issues&quot; /&gt; Issues&lt;/a&gt;</a>
<a class="sourceLine" id="cb27-142" title="142">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-143" title="143">      &lt;div class=&quot;widget-divider&quot;&gt;&amp;nbsp;&lt;/div&gt;</a>
<a class="sourceLine" id="cb27-144" title="144">      &lt;div class=&quot;supplementary widget&quot; id=&quot;blog-badge&quot;&gt;</a>
<a class="sourceLine" id="cb27-145" title="145">        &lt;a href=&quot;http://blog.regex.uk&quot;&gt;</a>
<a class="sourceLine" id="cb27-146" title="146">          &lt;img src=&quot;badges/blog.svg&quot; alt=&quot;regex blog&quot; /&gt;</a>
<a class="sourceLine" id="cb27-147" title="147">        &lt;/a&gt;</a>
<a class="sourceLine" id="cb27-148" title="148">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-149" title="149">      &lt;div class=&quot;supplementary widget&quot; id=&quot;hackage-badge&quot;&gt;</a>
<a class="sourceLine" id="cb27-150" title="150">        &lt;a href=&quot;https://hackage.haskell.org/package/regex&quot;&gt;</a>
<a class="sourceLine" id="cb27-151" title="151">          &lt;img src=&quot;badges/hackage.svg&quot; alt=&quot;hackage version&quot; /&gt;</a>
<a class="sourceLine" id="cb27-152" title="152">        &lt;/a&gt;</a>
<a class="sourceLine" id="cb27-153" title="153">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-154" title="154">      &lt;div class=&quot;supplementary widget&quot; id=&quot;build-status-badge&quot;&gt;</a>
<a class="sourceLine" id="cb27-155" title="155">        &lt;a href=&quot;build-status&quot;&gt;</a>
<a class="sourceLine" id="cb27-156" title="156">          &lt;img src=&quot;badges/build-status.svg&quot; alt=&quot;build status&quot; /&gt;</a>
<a class="sourceLine" id="cb27-157" title="157">        &lt;/a&gt;</a>
<a class="sourceLine" id="cb27-158" title="158">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-159" title="159">      &lt;div class=&quot;supplementary widget&quot; id=&quot;maintainers-contact&quot;&gt;</a>
<a class="sourceLine" id="cb27-160" title="160">        &lt;a href=&quot;mailto:maintainers@regex.uk&quot;&gt;</a>
<a class="sourceLine" id="cb27-161" title="161">          &lt;img src=&quot;badges/maintainers-contact.svg&quot; alt=&quot;maintainers contact&quot; /&gt;</a>
<a class="sourceLine" id="cb27-162" title="162">        &lt;/a&gt;</a>
<a class="sourceLine" id="cb27-163" title="163">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-164" title="164">      &lt;div class=&quot;supplementary widget&quot; id=&quot;feedback-contact&quot;&gt;</a>
<a class="sourceLine" id="cb27-165" title="165">        &lt;a href=&quot;mailto:feedback@regex.uk&quot;&gt;</a>
<a class="sourceLine" id="cb27-166" title="166">          &lt;img src=&quot;badges/feedback-contact.svg&quot; alt=&quot;deedback contact&quot; /&gt;</a>
<a class="sourceLine" id="cb27-167" title="167">        &lt;/a&gt;</a>
<a class="sourceLine" id="cb27-168" title="168">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-169" title="169">      &lt;div class=&quot;supplementary widget twitter&quot;&gt;</a>
<a class="sourceLine" id="cb27-170" title="170">        &lt;iframe style=&quot;width:162px; height:20px;&quot; src=&quot;https://platform.twitter.com/widgets/follow_button.html?screen_name=hregex&amp;amp;show_count=false&quot;&gt;</a>
<a class="sourceLine" id="cb27-171" title="171">        &lt;/iframe&gt;</a>
<a class="sourceLine" id="cb27-172" title="172">      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-173" title="173">    &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-174" title="174">    &lt;div id=&quot;content&quot;&gt;</a>
<a class="sourceLine" id="cb27-175" title="175">|]</a>
<a class="sourceLine" id="cb27-176" title="176"></a>
<a class="sourceLine" id="cb27-177" title="177"><span class="ot">pst_body_html ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb27-178" title="178">pst_body_html <span class="fu">=</span> [here|      &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-179" title="179">    &lt;/div&gt;</a>
<a class="sourceLine" id="cb27-180" title="180">|] <span class="fu">M.&lt;&gt;</span> tracking</a></code></pre></div>
<h2 id="task-lists">Task Lists</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" title="1"><span class="co">-- | replacement function to convert GFM task list line into HTML if we</span></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="co">-- aren&#39;t writing GFM (i.e.,  generating markdown for GitHub)</span></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="ot">task_list ::</span> <span class="dt">MarkdownMode</span>               <span class="co">-- ^ what flavour of md are we generating</span></a>
<a class="sourceLine" id="cb28-4" title="4">          <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span>                 <span class="co">-- ^ will contain True iff we have already entered a task list</span></a>
<a class="sourceLine" id="cb28-5" title="5">          <span class="ot">-&gt;</span> <span class="dt">Bool</span>                       <span class="co">-- ^ true if this is a checjed line</span></a>
<a class="sourceLine" id="cb28-6" title="6">          <span class="ot">-&gt;</span> <span class="dt">LineNo</span>                     <span class="co">-- ^ line no of the replacement redex (unused)</span></a>
<a class="sourceLine" id="cb28-7" title="7">          <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span>       <span class="co">-- ^ the matched task-list line</span></a>
<a class="sourceLine" id="cb28-8" title="8">          <span class="ot">-&gt;</span> <span class="dt">RELocation</span>                   <span class="co">-- ^ which match and capure (unused)</span></a>
<a class="sourceLine" id="cb28-9" title="9">          <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span>     <span class="co">-- ^ the capture weare replacing (unsuded)</span></a>
<a class="sourceLine" id="cb28-10" title="10">          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)  <span class="co">-- ^ the replacement text, or Nothing to indicate no change to this line</span></a>
<a class="sourceLine" id="cb28-11" title="11">task_list mmd rf chk _ mtch _ _ <span class="fu">=</span></a>
<a class="sourceLine" id="cb28-12" title="12">  <span class="kw">case</span> mmd <span class="kw">of</span></a>
<a class="sourceLine" id="cb28-13" title="13">    <span class="dt">MM_github</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb28-14" title="14">    <span class="dt">MM_hackage</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="fu">$</span> <span class="st">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> <span class="fu">M.&lt;&gt;</span> cb <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;&amp;nbsp;&amp;nbsp;&quot;</span> <span class="fu">M.&lt;&gt;</span> itm <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;\n&quot;</span></a>
<a class="sourceLine" id="cb28-15" title="15">    <span class="dt">MM_pandoc</span>  <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb28-16" title="16">      in_tl <span class="ot">&lt;-</span> readIORef rf</a>
<a class="sourceLine" id="cb28-17" title="17">      writeIORef rf <span class="dt">True</span></a>
<a class="sourceLine" id="cb28-18" title="18">      <span class="fu">return</span> <span class="fu">$</span> tl_line in_tl chk</a>
<a class="sourceLine" id="cb28-19" title="19">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb28-20" title="20">    tl_line in_tl enbl <span class="fu">=</span> <span class="dt">Just</span> <span class="fu">$</span> LBS.concat</a>
<a class="sourceLine" id="cb28-21" title="21">      [ <span class="kw">if</span> in_tl <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="kw">else</span> <span class="st">&quot;&lt;ul class=&#39;contains-task-list&#39;&gt;\n&quot;</span></a>
<a class="sourceLine" id="cb28-22" title="22">      , <span class="st">&quot;  &lt;li class=&#39;task-list-item&#39;&gt;&quot;</span></a>
<a class="sourceLine" id="cb28-23" title="23">      , <span class="st">&quot;&lt;input type=&#39;checkbox&#39; class=&#39;task-list-item-checkbox&#39;&quot;</span></a>
<a class="sourceLine" id="cb28-24" title="24">      , <span class="kw">if</span> enbl <span class="kw">then</span> <span class="st">&quot; checked=&#39;&#39;&quot;</span> <span class="kw">else</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb28-25" title="25">      , <span class="st">&quot; disabled=&#39;&#39;/&gt;&quot;</span></a>
<a class="sourceLine" id="cb28-26" title="26">      , itm</a>
<a class="sourceLine" id="cb28-27" title="27">      , <span class="st">&quot;&lt;/li&gt;&quot;</span></a>
<a class="sourceLine" id="cb28-28" title="28">      ]</a>
<a class="sourceLine" id="cb28-29" title="29"></a>
<a class="sourceLine" id="cb28-30" title="30">    cb  <span class="fu">=</span> <span class="kw">if</span> chk <span class="kw">then</span> <span class="st">&quot;&amp;#x2612;&quot;</span> <span class="kw">else</span> <span class="st">&quot;&amp;#x2610;&quot;</span></a>
<a class="sourceLine" id="cb28-31" title="31"></a>
<a class="sourceLine" id="cb28-32" title="32">    itm <span class="fu">=</span> mtch <span class="fu">!$$</span> [cp|itm|]</a>
<a class="sourceLine" id="cb28-33" title="33"></a>
<a class="sourceLine" id="cb28-34" title="34"><span class="co">-- | replacement function used for &#39;other&#39; lines -- terminate any task</span></a>
<a class="sourceLine" id="cb28-35" title="35"><span class="co">-- list that was being generated</span></a>
<a class="sourceLine" id="cb28-36" title="36"><span class="ot">fin_task_list ::</span> <span class="dt">MarkdownMode</span>               <span class="co">-- ^ what flavour of md are we generating</span></a>
<a class="sourceLine" id="cb28-37" title="37">              <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span>                 <span class="co">-- ^ will contain True iff we have already entered a task list</span></a>
<a class="sourceLine" id="cb28-38" title="38">              <span class="ot">-&gt;</span> <span class="dt">LineNo</span>                     <span class="co">-- ^ line no of the replacement redex (unused)</span></a>
<a class="sourceLine" id="cb28-39" title="39">              <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span>       <span class="co">-- ^ the matched task-list line</span></a>
<a class="sourceLine" id="cb28-40" title="40">              <span class="ot">-&gt;</span> <span class="dt">RELocation</span>                   <span class="co">-- ^ which match and capure (unused)</span></a>
<a class="sourceLine" id="cb28-41" title="41">              <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span>     <span class="co">-- ^ the capture weare replacing (unsuded)</span></a>
<a class="sourceLine" id="cb28-42" title="42">              <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)  <span class="co">-- ^ the replacement text, or Nothing to indicate no change to this line</span></a>
<a class="sourceLine" id="cb28-43" title="43">fin_task_list mmd rf_t _ mtch _ _ <span class="fu">=</span></a>
<a class="sourceLine" id="cb28-44" title="44">  <span class="fu">fmap</span> ( <span class="fu">M.&lt;&gt;</span> matchSource mtch) <span class="fu">&lt;$&gt;</span> fin_task_list&#39; mmd rf_t</a>
<a class="sourceLine" id="cb28-45" title="45"></a>
<a class="sourceLine" id="cb28-46" title="46"><span class="co">-- | close any task list being processed, returning the closing text</span></a>
<a class="sourceLine" id="cb28-47" title="47"><span class="co">-- as necessary</span></a>
<a class="sourceLine" id="cb28-48" title="48"><span class="ot">fin_task_list&#39; ::</span> <span class="dt">MarkdownMode</span>              <span class="co">-- ^ what flavour of md are we generating</span></a>
<a class="sourceLine" id="cb28-49" title="49">               <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span>                <span class="co">-- ^ will contain True iff we have already entered a task list</span></a>
<a class="sourceLine" id="cb28-50" title="50">               <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>) <span class="co">-- ^ task-list closure HTML, if task-list HTML needs closing</span></a>
<a class="sourceLine" id="cb28-51" title="51">fin_task_list&#39; mmd rf <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb28-52" title="52">  in_tl <span class="ot">&lt;-</span> readIORef rf</a>
<a class="sourceLine" id="cb28-53" title="53">  writeIORef rf <span class="dt">False</span></a>
<a class="sourceLine" id="cb28-54" title="54">  <span class="kw">case</span> mmd<span class="fu">==</span><span class="dt">MM_github</span> <span class="fu">||</span> <span class="fu">not</span> in_tl <span class="kw">of</span></a>
<a class="sourceLine" id="cb28-55" title="55">    <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb28-56" title="56">    <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="fu">$</span> <span class="st">&quot;&lt;/ul&gt;\n&quot;</span></a></code></pre></div>
<h2 id="literate-haskell-pages">Literate Haskell Pages</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb29-1" title="1"><span class="ot">pandoc_lhs ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb29-2" title="2">pandoc_lhs title in_file <span class="fu">=</span> pandoc_lhs&#39; title in_file in_file</a>
<a class="sourceLine" id="cb29-3" title="3"></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="ot">pandoc_lhs&#39; ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb29-5" title="5">pandoc_lhs&#39; title repo_path in_file out_file <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb29-6" title="6">  lbsReadFile in_file <span class="fu">&gt;&gt;=</span> include_code_pp <span class="fu">&gt;&gt;=</span> LBS.writeFile int_file</a>
<a class="sourceLine" id="cb29-7" title="7">  LBS.writeFile <span class="st">&quot;tmp/metadata.markdown&quot;</span>  <span class="fu">$</span></a>
<a class="sourceLine" id="cb29-8" title="8">                    LBS.unlines</a>
<a class="sourceLine" id="cb29-9" title="9">                      [ <span class="st">&quot;---&quot;</span></a>
<a class="sourceLine" id="cb29-10" title="10">                      , <span class="st">&quot;title: &quot;</span> <span class="fu">M.&lt;&gt;</span> LBS.pack title</a>
<a class="sourceLine" id="cb29-11" title="11">                      , <span class="st">&quot;---&quot;</span></a>
<a class="sourceLine" id="cb29-12" title="12">                      ]</a>
<a class="sourceLine" id="cb29-13" title="13">  LBS.writeFile <span class="st">&quot;tmp/bc.html&quot;</span> bc</a>
<a class="sourceLine" id="cb29-14" title="14">  LBS.writeFile <span class="st">&quot;tmp/ft.html&quot;</span> ft</a>
<a class="sourceLine" id="cb29-15" title="15">  <span class="fu">fmap</span> (<span class="fu">const</span> ()) <span class="fu">$</span></a>
<a class="sourceLine" id="cb29-16" title="16">    SH.shelly <span class="fu">$</span> SH.verbosely <span class="fu">$</span></a>
<a class="sourceLine" id="cb29-17" title="17">      SH.run <span class="st">&quot;pandoc&quot;</span></a>
<a class="sourceLine" id="cb29-18" title="18">        [ <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;markdown+lhs+grid_tables&quot;</span></a>
<a class="sourceLine" id="cb29-19" title="19">        , <span class="st">&quot;-t&quot;</span>, <span class="st">&quot;html5&quot;</span></a>
<a class="sourceLine" id="cb29-20" title="20">        , <span class="st">&quot;-T&quot;</span>, <span class="st">&quot;regex&quot;</span></a>
<a class="sourceLine" id="cb29-21" title="21">        , <span class="st">&quot;-s&quot;</span></a>
<a class="sourceLine" id="cb29-22" title="22">        , <span class="st">&quot;-H&quot;</span>, <span class="st">&quot;lib/favicons.html&quot;</span></a>
<a class="sourceLine" id="cb29-23" title="23">        , <span class="st">&quot;-B&quot;</span>, <span class="st">&quot;tmp/bc.html&quot;</span></a>
<a class="sourceLine" id="cb29-24" title="24">        , <span class="st">&quot;-A&quot;</span>, <span class="st">&quot;tmp/ft.html&quot;</span></a>
<a class="sourceLine" id="cb29-25" title="25">        , <span class="st">&quot;-c&quot;</span>, <span class="st">&quot;lib/lhs-styles.css&quot;</span></a>
<a class="sourceLine" id="cb29-26" title="26">        , <span class="st">&quot;-c&quot;</span>, <span class="st">&quot;lib/bs.css&quot;</span></a>
<a class="sourceLine" id="cb29-27" title="27">        , <span class="st">&quot;-o&quot;</span>, T.pack out_file</a>
<a class="sourceLine" id="cb29-28" title="28">        , <span class="st">&quot;tmp/metadata.markdown&quot;</span></a>
<a class="sourceLine" id="cb29-29" title="29">        , T.pack int_file</a>
<a class="sourceLine" id="cb29-30" title="30">        ]</a>
<a class="sourceLine" id="cb29-31" title="31">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb29-32" title="32">    bc <span class="fu">=</span> LBS.unlines</a>
<a class="sourceLine" id="cb29-33" title="33">    <span class="co">--  [ &quot;&lt;div class=&#39;brandingdiv&#39;&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-34" title="34">    <span class="co">--  , &quot;  &quot; M.&lt;&gt; branding</span></a>
<a class="sourceLine" id="cb29-35" title="35">    <span class="co">--  , &quot;&lt;/div&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-36" title="36">      [ <span class="st">&quot;&lt;div class=&#39;bcdiv&#39;&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-37" title="37">      , <span class="st">&quot;  &lt;ol class=&#39;breadcrumb&#39;&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-38" title="38">      , <span class="st">&quot;    &lt;li&gt;&quot;</span> <span class="fu">M.&lt;&gt;</span> branding <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;&lt;/li&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-39" title="39">      , <span class="st">&quot;    &lt;li&gt;&lt;a title=&#39;source file&#39; href=&#39;&quot;</span>  <span class="fu">M.&lt;&gt;</span></a>
<a class="sourceLine" id="cb29-40" title="40">              repo_url <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;&#39;&gt;&quot;</span> <span class="fu">M.&lt;&gt;</span> (LBS.pack title) <span class="fu">M.&lt;&gt;</span> <span class="st">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-41" title="41">      , <span class="st">&quot;&lt;/ol&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-42" title="42">      , <span class="st">&quot;&lt;/div&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-43" title="43">      , <span class="st">&quot;&lt;div class=&#39;litcontent&#39;&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-44" title="44">      ]</a>
<a class="sourceLine" id="cb29-45" title="45"></a>
<a class="sourceLine" id="cb29-46" title="46">    ft <span class="fu">=</span> LBS.concat</a>
<a class="sourceLine" id="cb29-47" title="47">      [ <span class="st">&quot;&lt;/div&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-48" title="48">      ] <span class="fu">M.&lt;&gt;</span> tracking</a>
<a class="sourceLine" id="cb29-49" title="49"></a>
<a class="sourceLine" id="cb29-50" title="50">    repo_url <span class="fu">=</span> LBS.concat</a>
<a class="sourceLine" id="cb29-51" title="51">      [ <span class="st">&quot;https://github.com/iconnect/regex/blob/master/&quot;</span></a>
<a class="sourceLine" id="cb29-52" title="52">      , LBS.pack repo_path</a>
<a class="sourceLine" id="cb29-53" title="53">      ]</a>
<a class="sourceLine" id="cb29-54" title="54"></a>
<a class="sourceLine" id="cb29-55" title="55">    int_file <span class="fu">=</span> <span class="st">&quot;tmp/pandoc-int.lhs&quot;</span></a></code></pre></div>
<h2 id="tweak_md">tweak_md</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" title="1"><span class="ot">tweak_md ::</span> <span class="dt">MarkdownMode</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb30-2" title="2">tweak_md mm lbs <span class="fu">=</span> <span class="kw">case</span> mm <span class="kw">of</span></a>
<a class="sourceLine" id="cb30-3" title="3">    <span class="dt">MM_github</span>  <span class="ot">-&gt;</span> lbs</a>
<a class="sourceLine" id="cb30-4" title="4">    <span class="dt">MM_pandoc</span>  <span class="ot">-&gt;</span> awk</a>
<a class="sourceLine" id="cb30-5" title="5">      [ <span class="dt">Template</span> [ed|&lt;https?://${rest}([^)]+)&gt;///[${rest}]($0)|]</a>
<a class="sourceLine" id="cb30-6" title="6">      ]</a>
<a class="sourceLine" id="cb30-7" title="7">    <span class="dt">MM_hackage</span> <span class="ot">-&gt;</span> awk</a>
<a class="sourceLine" id="cb30-8" title="8">      [ <span class="dt">Template</span> [ed|&lt;br/&gt;$///\n|]</a>
<a class="sourceLine" id="cb30-9" title="9">      ]</a>
<a class="sourceLine" id="cb30-10" title="10">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb30-11" title="11">    awk <span class="fu">=</span> fromMaybe oops <span class="fu">.</span> <span class="fu">flip</span> sed&#39; lbs <span class="fu">.</span> <span class="dt">Pipe</span></a>
<a class="sourceLine" id="cb30-12" title="12"></a>
<a class="sourceLine" id="cb30-13" title="13">    <span class="co">-- runIdentity added to base in 4.9 only</span></a>
<a class="sourceLine" id="cb30-14" title="14">    oops <span class="fu">=</span> <span class="fu">error</span> <span class="st">&quot;tweak_md&quot;</span></a></code></pre></div>
<h2 id="branding">branding</h2>
<div class="sourceCode" id="cb31"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb31-1" title="1"><span class="ot">branding ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb31-2" title="2">branding <span class="fu">=</span> [here|&lt;a href=&quot;.&quot; style=&quot;font-family: Arial, &#39;Helvetica Neue&#39;, Helvetica, sans-serif;&quot; id=&quot;branding&quot;&gt;[&lt;span style=&#39;color:red;&#39;&gt;re&lt;/span&gt;|${&lt;span style=&#39;color:red;&#39;&gt;gex&lt;/span&gt;}(.*)|&lt;span&gt;&lt;/span&gt;]&lt;/a&gt;|]</a></code></pre></div>
<h2 id="tracking">tracking</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb32-1" title="1"><span class="ot">tracking ::</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb32-2" title="2">tracking <span class="fu">=</span> [here|    &lt;script&gt;</a>
<a class="sourceLine" id="cb32-3" title="3">      (function(i,s,o,g,r,a,m){i[&#39;GoogleAnalyticsObject&#39;]=r;i[r]=i[r]||function(){</a>
<a class="sourceLine" id="cb32-4" title="4">      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),</a>
<a class="sourceLine" id="cb32-5" title="5">      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)</a>
<a class="sourceLine" id="cb32-6" title="6">      })(window,document,&#39;script&#39;,&#39;https://www.google-analytics.com/analytics.js&#39;,&#39;ga&#39;);</a>
<a class="sourceLine" id="cb32-7" title="7"></a>
<a class="sourceLine" id="cb32-8" title="8">      ga(&#39;create&#39;, &#39;UA-92650418-1&#39;, &#39;auto&#39;);</a>
<a class="sourceLine" id="cb32-9" title="9">      ga(&#39;send&#39;, &#39;pageview&#39;);</a>
<a class="sourceLine" id="cb32-10" title="10"></a>
<a class="sourceLine" id="cb32-11" title="11">    &lt;/script&gt;</a>
<a class="sourceLine" id="cb32-12" title="12">|]</a></code></pre></div>
<h2 id="testing">testing</h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb33-1" title="1"><span class="ot">test ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb33-2" title="2">test <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb33-3" title="3">  test_pp <span class="st">&quot;re-prep doc&quot;</span> (prepare_tutorial <span class="dt">Doc</span>) <span class="st">&quot;data/pp-test.lhs&quot;</span> <span class="st">&quot;data/pp-result-doc.lhs&quot;</span></a>
<a class="sourceLine" id="cb33-4" title="4">  gm <span class="ot">&lt;-</span> genMode</a>
<a class="sourceLine" id="cb33-5" title="5">  test_pp <span class="st">&quot;re-prep gen&quot;</span> (prepare_tutorial gm ) <span class="st">&quot;data/pp-test.lhs&quot;</span> <span class="st">&quot;data/pp-result-gen.lhs&quot;</span></a>
<a class="sourceLine" id="cb33-6" title="6">  <span class="fu">putStrLn</span> <span class="st">&quot;tests passed&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb34-1" title="1"><span class="ot">lbsReadFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></a>
<a class="sourceLine" id="cb34-2" title="2">lbsReadFile fp <span class="fu">=</span> LBS.fromStrict <span class="fu">&lt;$&gt;</span> B.readFile fp</a></code></pre></div>
</div>    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-92650418-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>
