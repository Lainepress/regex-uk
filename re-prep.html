<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>regex â€“ examples/re-prep.lhs</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="lib/lhs-styles.css" />
  <link rel="stylesheet" href="lib/bs.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/>
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="mask-icon" href="/safari-pinned-tab.svg"/>
  <meta name="theme-color" content="#ffffff"/>
</head>
<body>
<div class='bcdiv'>
  <ol class='breadcrumb'>
    <li><a href="." style="font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;" id="branding">[<span style='color:red;'>re</span>|${<span style='color:red;'>gex</span>}(.*)|<span></span>]</a></li>
    <li><a title='source file' href='https://github.com/iconnect/regex/blob/master/examples/re-prep.lhs'>examples/re-prep.lhs</a></li>
</ol>
</div>
<div class='litcontent'>
<header id="title-block-header">
<h1 class="title">examples/re-prep.lhs</h1>
</header>
<h1 id="regex-page-prep">Regex (Page) Prep</h1>
<p>This tool turns the markdown and literate Haskell into the HTML that makes up the website and the README.md for GitHub and for Hackage (based on the index.md for the website) and the test suite based on the tutorial.</p>
<p>The tool is self-testing: run it with no arguments (or <code>cabal test</code>).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude          #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="ot">{-# LANGUAGE RecordWildCards            #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="ot">{-# LANGUAGE FlexibleContexts           #-}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Main</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>  ( main</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>  ) <span class="kw">where</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Control.Applicative</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Char8</span>                    <span class="kw">as</span> <span class="dt">B</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span>               <span class="kw">as</span> <span class="dt">LBS</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.IORef</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.List</span>                                <span class="kw">as</span> <span class="dt">L</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Maybe</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Monoid</span>                              <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span>                                <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Conduit</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Prelude.Compat</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Shelly</span>                                   <span class="kw">as</span> <span class="dt">SH</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Directory</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.Environment</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.FilePath</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">System.IO</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">TestKit</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.Heredoc</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Replace</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.TDFA.ByteString.Lazy</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.RE.TDFA.String</span>                      <span class="kw">as</span> <span class="dt">TS</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Grep</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.RE.Tools.Sed</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  as  <span class="ot">&lt;-</span> getArgs</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  <span class="kw">case</span> as <span class="kw">of</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    []                          <span class="ot">-&gt;</span> test</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    [<span class="st">&quot;test&quot;</span>]                    <span class="ot">-&gt;</span> test</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>    [<span class="st">&quot;doc&quot;</span>,fn,fn&#39;] <span class="op">|</span> is_file fn <span class="ot">-&gt;</span> doc fn fn&#39;</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>    [<span class="st">&quot;gen&quot;</span>,fn,fn&#39;] <span class="op">|</span> is_file fn <span class="ot">-&gt;</span> gen fn fn&#39;</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    [<span class="st">&quot;badges&quot;</span>]                  <span class="ot">-&gt;</span> badges</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>    [<span class="st">&quot;blog-badge&quot;</span>]              <span class="ot">-&gt;</span> blog_badge</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    [<span class="st">&quot;pages&quot;</span>]                   <span class="ot">-&gt;</span> pages</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>    [<span class="st">&quot;all&quot;</span>]                     <span class="ot">-&gt;</span> gen_all</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>    _                           <span class="ot">-&gt;</span> usage</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>    is_file <span class="ot">=</span> <span class="fu">not</span> <span class="op">.</span> (<span class="op">==</span> <span class="st">&quot;--&quot;</span>) <span class="op">.</span> <span class="fu">take</span> <span class="dv">2</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>    doc fn fn&#39; <span class="ot">=</span>                    prepare_tutorial <span class="dt">Doc</span> fn fn&#39;</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a>    gen fn fn&#39; <span class="ot">=</span> genMode <span class="op">&gt;&gt;=</span> \gm <span class="ot">-&gt;</span> prepare_tutorial gm  fn fn&#39;</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>    usage <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>      pnm <span class="ot">&lt;-</span> getProgName</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>      <span class="kw">let</span> prg <span class="ot">=</span> ((<span class="st">&quot;  &quot;</span><span class="op">++</span>pnm<span class="op">++</span><span class="st">&quot; &quot;</span>)<span class="op">++</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>      hPutStr stderr <span class="op">$</span> <span class="fu">unlines</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>        [ <span class="st">&quot;usage:&quot;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>        , prg <span class="st">&quot;--help&quot;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>        , prg <span class="st">&quot;[test]&quot;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a>        , prg <span class="st">&quot;badges&quot;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true"></a>        , prg <span class="st">&quot;blog-badge&quot;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true"></a>        , prg <span class="st">&quot;pages&quot;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true"></a>        , prg <span class="st">&quot;all&quot;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true"></a>        , prg <span class="st">&quot;doc (-|&lt;in-file&gt;) (-|&lt;out-file&gt;)&quot;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true"></a>        , prg <span class="st">&quot;gen (-|&lt;in-file&gt;) (-|&lt;out-file&gt;)&quot;</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true"></a>        ]</span></code></pre></div>
<h2 id="script-to-generate-the-whole-web-site">Script to Generate the Whole Web Site</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ot">gen_all ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>gen_all <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    <span class="co">-- prepare HTML docs for the (literate) tools</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>    pd <span class="st">&quot;re-gen-cabals&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>    pd <span class="st">&quot;re-gen-modules&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    pd <span class="st">&quot;re-include&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>    pd <span class="st">&quot;re-nginx-log-processor&quot;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>    pd <span class="st">&quot;re-prep&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>    pd <span class="st">&quot;re-sort-imports&quot;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>    pd <span class="st">&quot;re-top&quot;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>    pd <span class="st">&quot;re-tests&quot;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>    pd <span class="st">&quot;TestKit&quot;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>    pd <span class="st">&quot;RE/REOptions&quot;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    pd <span class="st">&quot;RE/Tools/Edit&quot;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>    pd <span class="st">&quot;RE/Tools/Grep&quot;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>    pd <span class="st">&quot;RE/Tools/Sed&quot;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/NamedCaptures&quot;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/Replace&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/TestBench&quot;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/Tools/Lex&quot;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/Types/IsRegex&quot;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/Types/Matches&quot;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/Types/Match&quot;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>    pd <span class="st">&quot;RE/ZeInternals/Types/Capture&quot;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>    <span class="co">-- render the tutorial in HTML</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>    createDirectoryIfMissing <span class="dt">False</span> <span class="st">&quot;tmp&quot;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>    gen_tutorial <span class="st">&quot;tutorial&quot;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a>    gen_tutorial <span class="st">&quot;tutorial-options&quot;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a>    gen_tutorial <span class="st">&quot;tutorial-replacing&quot;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a>    gen_tutorial <span class="st">&quot;tutorial-testbench&quot;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a>    gen_tutorial <span class="st">&quot;tutorial-tools&quot;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a>    pages</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true"></a>    pd fnm <span class="ot">=</span> <span class="kw">case</span> (mtch <span class="op">!$$?</span> [cp|fdr|],mtch <span class="op">!$$?</span> [cp|mnm|]) <span class="kw">of</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true"></a>        (<span class="dt">Nothing</span> ,<span class="dt">Just</span> mnm) <span class="ot">-&gt;</span> pandoc_lhs (<span class="st">&quot;Text.RE.&quot;</span>          <span class="op">++</span>mnm) (<span class="st">&quot;Text/&quot;</span>    <span class="op">++</span>fnm<span class="op">++</span><span class="st">&quot;.lhs&quot;</span>) (<span class="st">&quot;docs/&quot;</span><span class="op">++</span>mnm<span class="op">++</span><span class="st">&quot;.html&quot;</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true"></a>        (<span class="dt">Just</span> fdr,<span class="dt">Just</span> mnm) <span class="ot">-&gt;</span> pandoc_lhs (<span class="st">&quot;Text.RE.&quot;</span><span class="op">++</span>fdr<span class="op">++</span><span class="st">&quot;.&quot;</span><span class="op">++</span>mnm) (<span class="st">&quot;Text/&quot;</span>    <span class="op">++</span>fnm<span class="op">++</span><span class="st">&quot;.lhs&quot;</span>) (<span class="st">&quot;docs/&quot;</span><span class="op">++</span>mnm<span class="op">++</span><span class="st">&quot;.html&quot;</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true"></a>        _                   <span class="ot">-&gt;</span> pandoc_lhs (<span class="st">&quot;examples/&quot;</span><span class="op">++</span>fnm<span class="op">++</span><span class="st">&quot;.lhs&quot;</span> ) (<span class="st">&quot;examples/&quot;</span><span class="op">++</span>fnm<span class="op">++</span><span class="st">&quot;.lhs&quot;</span>) (<span class="st">&quot;docs/&quot;</span><span class="op">++</span>fnm<span class="op">++</span><span class="st">&quot;.html&quot;</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true"></a>      <span class="kw">where</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true"></a>        mtch <span class="ot">=</span> fnm <span class="op">TS.?=~</span> [re|^RE/(${fdr}([a-zA-Z/]+)/)?${mnm}(@{%id})|]</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="ot">gen_tutorial ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>gen_tutorial nm <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    prepare_tutorial <span class="dt">Doc</span> (<span class="st">&quot;examples&quot;</span> <span class="op">&lt;/&gt;</span> mst) (<span class="st">&quot;tmp&quot;</span> <span class="op">&lt;/&gt;</span> tgt)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>    pandoc_lhs&#39;       tgt</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>      (<span class="st">&quot;examples&quot;</span> <span class="op">&lt;/&gt;</span> tgt)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>      (<span class="st">&quot;tmp&quot;</span>      <span class="op">&lt;/&gt;</span> tgt)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>      (<span class="st">&quot;docs&quot;</span>     <span class="op">&lt;/&gt;</span> htm)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    <span class="co">-- generate the tutorial-based tests</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    gm <span class="ot">&lt;-</span> genMode</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>    prepare_tutorial gm (<span class="st">&quot;examples&quot;</span> <span class="op">&lt;/&gt;</span> mst) (<span class="st">&quot;examples&quot;</span> <span class="op">&lt;/&gt;</span> tgt)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;&gt;&gt; &quot;</span> <span class="op">++</span> (<span class="st">&quot;examples&quot;</span> <span class="op">&lt;/&gt;</span> tgt)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>    tgt <span class="ot">=</span> <span class="st">&quot;re-&quot;</span> <span class="op">++</span> nm <span class="op">++</span> <span class="st">&quot;.lhs&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>    htm <span class="ot">=</span> <span class="st">&quot;re-&quot;</span> <span class="op">++</span> nm <span class="op">++</span> <span class="st">&quot;.html&quot;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>    mst <span class="ot">=</span> <span class="st">&quot;re-&quot;</span> <span class="op">++</span> nm <span class="op">++</span> <span class="st">&quot;-master.lhs&quot;</span></span></code></pre></div>
<h2 id="the-tutorial-preprocessor">The Tutorial Preprocessor</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="co">-- | the MODE determines whether we are generating documentation</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="co">-- or a Haskell testsuite and includes any IO-accessible state</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="co">-- needed by the relevant processor</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">MODE</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>  <span class="ot">=</span> <span class="dt">Doc</span>           <span class="co">-- ^ generating mardown+lhs input for pandoc</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">Gen</span> <span class="dt">GenState</span>  <span class="co">-- ^ adjusting-the-program-for-testing state</span></span></code></pre></div>
<p>The <code>DocState</code> is initialised to <code>Outside</code> and flips though the different states as it traverses a code block, so that we can wrap code blocks in special <code>&lt;div class="replcodeblock"&gt;</code> blocks when their first line indicates that it contains a REPL calculation, which the style sheet can pick up and present accordingly.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co">-- | the state is the accumulated test function identifiers for</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="co">-- generating the list of them gets added to the end of the programme</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">GenState</span> <span class="ot">=</span> <span class="dt">IORef</span> [<span class="dt">String</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="ot">genMode ::</span> <span class="dt">IO</span> <span class="dt">MODE</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>genMode <span class="ot">=</span> <span class="dt">Gen</span> <span class="op">&lt;$&gt;</span> newIORef []</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="ot">prepare_tutorial ::</span> <span class="dt">MODE</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>prepare_tutorial mode fp_in fp_out <span class="ot">=</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>  LBS.readFile fp_in <span class="op">&gt;&gt;=</span> prep_tutorial_pp mode <span class="op">&gt;&gt;=</span> incld <span class="op">&gt;&gt;=</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>    LBS.writeFile fp_out <span class="op">.</span> sortImports</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>    incld <span class="ot">=</span> <span class="kw">case</span> mode <span class="kw">of</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>      <span class="dt">Doc</span>   <span class="ot">-&gt;</span> include_code_pp</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>      <span class="dt">Gen</span> _ <span class="ot">-&gt;</span> <span class="fu">return</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ot">prep_tutorial_pp ::</span> <span class="dt">MODE</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>prep_tutorial_pp mode <span class="ot">=</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>  sed&#39; <span class="op">$</span> <span class="dt">Select</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    [ <span class="dt">LineEdit</span> [re|^%main ${arg}(top|bottom)$|]                            <span class="op">$</span> main_    mode</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^import *TestKit$|]                                     <span class="op">$</span> hide     mode</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    , <span class="dt">LineEdit</span> [re|^\{-# OPTIONS_GHC -fno-warn-missing-signatures *#-\}$|] <span class="op">$</span> hide     mode</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    , <span class="dt">Function</span> [re|^${fn}(evalme@{%id}) += +(checkThis|checkThisWith +@{%id}) +${arg}(@{%string}) +\(${ans}([^)]+)\) +\$ +\(${exp}(.*)\)$|]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>                                                                       <span class="dt">TOP</span> <span class="op">$</span> evalme   mode</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>    , <span class="dt">Function</span> [re|^${fn}(evalme@{%id}) += +(checkThis|checkThisWith +@{%id}) +${arg}(@{%string}) +\(${ans}([^)]+)\) +\$ +${exp}(.*)$|]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>                                                                       <span class="dt">TOP</span> <span class="op">$</span> evalme   mode</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>    , <span class="dt">Function</span> [re|^.*$|]                                              <span class="dt">TOP</span> <span class="op">$</span> passthru</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>    ]</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="ot">evalme ::</span> <span class="dt">MODE</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>       <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>       <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>       <span class="ot">-&gt;</span> <span class="dt">RELocation</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>       <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>       <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>evalme  <span class="dt">Doc</span>     <span class="ot">=</span> evalmeDoc</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>evalme (<span class="dt">Gen</span> gs) <span class="ot">=</span> evalmeGen  gs</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a><span class="ot">main_ ::</span> <span class="dt">MODE</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>      <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>      <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a>      <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>main_   <span class="dt">Doc</span>     <span class="ot">=</span> delete</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>main_  (<span class="dt">Gen</span> gs) <span class="ot">=</span> mainGen    gs</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a><span class="ot">hide ::</span> <span class="dt">MODE</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>     <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>     <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a>hide  <span class="dt">Doc</span>    <span class="ot">=</span> delete</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>hide (<span class="dt">Gen</span> _) <span class="ot">=</span> passthru_</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="ot">evalmeDoc ::</span> <span class="dt">LineNo</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">RELocation</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>evalmeDoc _ mtch _ _ <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span> <span class="fu">flip</span> replace mtch <span class="op">$</span> LBS.intercalate <span class="st">&quot;\n&quot;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>  [ <span class="st">&quot;ghci&gt; ${exp}&quot;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>  , <span class="st">&quot;${ans}&quot;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>  ]</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="ot">evalmeGen ::</span> <span class="dt">GenState</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">RELocation</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>evalmeGen gs _ mtch0 _ _ <span class="ot">=</span> <span class="dt">Just</span> <span class="op">&lt;$&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>    replaceCapturesM replaceMethods <span class="dt">ALL</span> f mtch0</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>    f mtch loc _ <span class="ot">=</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>      <span class="kw">case</span> locationCapture loc <span class="op">==</span> arg_i <span class="kw">of</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a>        <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>            modifyIORef gs (ide<span class="op">:</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>            <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span> LBS.pack <span class="op">$</span> <span class="fu">show</span> ide</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a>          <span class="kw">where</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a>            ide <span class="ot">=</span> LBS.unpack <span class="op">$</span> captureText [cp|fn|] mtch</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a>        <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a>    arg_i <span class="ot">=</span> <span class="fu">either</span> oops <span class="fu">id</span> <span class="op">$</span> findCaptureID [cp|arg|] <span class="op">$</span> captureNames mtch0</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a>    oops  <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;evalmeGen: confused captures!&quot;</span></span></code></pre></div>
<p>How are we doing?</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="ot">mainGen ::</span> <span class="dt">GenState</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>mainGen gs _ mtchs <span class="ot">=</span> <span class="kw">case</span> allMatches mtchs <span class="kw">of</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>  [mtch]  <span class="ot">-&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>    <span class="kw">case</span> captureText [cp|arg|] <span class="op">$</span> mtch <span class="kw">of</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>      <span class="st">&quot;top&quot;</span>    <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">ReplaceWith</span> <span class="op">$</span> LBS.unlines <span class="op">$</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>          [ begin_code</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>          , <span class="st">&quot;module Main(main) where&quot;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>          , end_code</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>          , <span class="st">&quot;&quot;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>          , <span class="st">&quot;*********************************************************&quot;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>          , <span class="st">&quot;*&quot;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>          , <span class="st">&quot;* WARNING: this is generated from pp-tutorial-master.lhs &quot;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>          , <span class="st">&quot;*&quot;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a>          , <span class="st">&quot;*********************************************************&quot;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>          ]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>      <span class="st">&quot;bottom&quot;</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>        fns <span class="ot">&lt;-</span> readIORef gs</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a>        <span class="fu">return</span> <span class="op">$</span> <span class="dt">ReplaceWith</span> <span class="op">$</span> LBS.unlines <span class="op">$</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>          [ begin_code</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a>          , <span class="st">&quot;main :: IO ()&quot;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a>          , <span class="st">&quot;main = runTheTests&quot;</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a>          ] <span class="op">++</span> mk_list fns <span class="op">++</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>          [ end_code</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a>          ]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a>      _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;mainGen (b)&quot;</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a>  _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;mainGen (a)&quot;</span></span></code></pre></div>
<p>We cannot place these strings inline without confusing pandoc so we use these definitions instead.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>begin_code,<span class="ot"> end_code ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>begin_code <span class="ot">=</span> <span class="st">&quot;\\&quot;</span> <span class="op">M.&lt;&gt;</span>  <span class="st">&quot;begin{code}&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>end_code   <span class="ot">=</span> <span class="st">&quot;\\&quot;</span> <span class="op">M.&lt;&gt;</span>  <span class="st">&quot;end{code}&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="ot">mk_list ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> [<span class="dt">LBS.ByteString</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>mk_list []          <span class="ot">=</span> [<span class="st">&quot;  []&quot;</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>mk_list (ide0<span class="op">:</span>ides) <span class="ot">=</span> f <span class="st">&quot;[&quot;</span> ide0 <span class="op">$</span> <span class="fu">foldr</span> (f <span class="st">&quot;,&quot;</span>) [<span class="st">&quot;  ]&quot;</span>] ides</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>    f pfx ide t <span class="ot">=</span> (<span class="st">&quot;  &quot;</span> <span class="op">M.&lt;&gt;</span> pfx <span class="op">M.&lt;&gt;</span> <span class="st">&quot; &quot;</span> <span class="op">M.&lt;&gt;</span> LBS.pack ide) <span class="op">:</span> t</span></code></pre></div>
<h2 id="include_code_pp">include_code_pp</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="ot">include_code_pp ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>include_code_pp <span class="ot">=</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>  sed&#39; <span class="op">$</span> <span class="dt">Select</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>    [ <span class="dt">Function</span> [re|^%include ${file}(@{%string}) ${rex}(@{%string})$|] <span class="dt">TOP</span>  inc_code</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>    , <span class="dt">Function</span> [re|^.*$|]                                              <span class="dt">TOP</span>  passthru</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>    ]</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="ot">inc_code ::</span> <span class="dt">LineNo</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">RELocation</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>inc_code _ mtch _ _ <span class="ot">=</span> <span class="fu">fmap</span> <span class="dt">Just</span> <span class="op">$</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>    extract fp <span class="op">=&lt;&lt;</span> compileRegex re_s</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a>    fp    <span class="ot">=</span> prs_s <span class="op">$</span> captureText [cp|file|] mtch</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>    re_s  <span class="ot">=</span> prs_s <span class="op">$</span> captureText [cp|rex|]  mtch</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>    prs_s <span class="ot">=</span> <span class="fu">maybe</span> (<span class="fu">error</span> <span class="st">&quot;include_code&quot;</span>) T.unpack <span class="op">.</span> parseString</span></code></pre></div>
<h2 id="passthru-and-delete-actions">passthru and delete actions</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="ot">passthru ::</span> <span class="dt">LineNo</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">RELocation</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>         <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a>passthru _ _ _ _ <span class="ot">=</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a><span class="ot">passthru_ ::</span> <span class="dt">LineNo</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a>passthru_ _ _ <span class="ot">=</span> <span class="fu">return</span> <span class="dt">NoEdit</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a><span class="ot">delete ::</span> <span class="dt">LineNo</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a>       <span class="ot">-&gt;</span> <span class="dt">Matches</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a>       <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LineEdit</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a>delete _ _ <span class="ot">=</span> <span class="fu">return</span> <span class="dt">Delete</span></span></code></pre></div>
<h2 id="extracting-a-literate-fragment-from-a-haskell-program-text">Extracting a Literate Fragment from a Haskell Program Text</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="ot">extract ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">RE</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>extract fp rex <span class="ot">=</span> extr <span class="op">.</span> LBS.lines <span class="op">&lt;$&gt;</span> LBS.readFile fp</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>    extr lns <span class="ot">=</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a>      <span class="kw">case</span> parse <span class="op">$</span> scan rex lns <span class="kw">of</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a>        <span class="dt">Nothing</span>      <span class="ot">-&gt;</span> oops</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a>        <span class="dt">Just</span> (lno,n) <span class="ot">-&gt;</span> LBS.unlines <span class="op">$</span> (hdr <span class="op">:</span>) <span class="op">$</span> (<span class="fu">take</span> n <span class="op">$</span> <span class="fu">drop</span> i lns) <span class="op">++</span> [ftr]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a>          <span class="kw">where</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a>            i <span class="ot">=</span> getZeroBasedLineNo lno</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a>    oops <span class="ot">=</span> <span class="fu">error</span> <span class="op">$</span> <span class="fu">concat</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true"></a>      [ <span class="st">&quot;failed to locate fragment matching &quot;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true"></a>      , <span class="fu">show</span> <span class="op">$</span> reSource rex</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true"></a>      , <span class="st">&quot; in file &quot;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true"></a>      , <span class="fu">show</span> fp</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true"></a>      ]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true"></a>    hdr  <span class="ot">=</span> <span class="st">&quot;&lt;div class=&#39;includedcodeblock&#39;&gt;&quot;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true"></a>    ftr  <span class="ot">=</span> <span class="st">&quot;&lt;/div&gt;&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="ot">parse ::</span> [<span class="dt">Token</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">LineNo</span>,<span class="dt">Int</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>parse []       <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>parse (tk<span class="op">:</span>tks) <span class="ot">=</span> <span class="kw">case</span> (tk,tks) <span class="kw">of</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>  (<span class="dt">Bra</span> b_ln,<span class="dt">Hit</span><span class="op">:</span><span class="dt">Ket</span> k_ln<span class="op">:</span>_) <span class="ot">-&gt;</span> <span class="dt">Just</span> (b_ln,count_lines_incl b_ln k_ln)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>  _                         <span class="ot">-&gt;</span> parse tks</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="ot">count_lines_incl ::</span> <span class="dt">LineNo</span> <span class="ot">-&gt;</span> <span class="dt">LineNo</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>count_lines_incl b_ln k_ln <span class="ot">=</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>  getZeroBasedLineNo k_ln <span class="op">+</span> <span class="dv">1</span> <span class="op">-</span> getZeroBasedLineNo b_ln</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Token</span> <span class="ot">=</span> <span class="dt">Bra</span> <span class="dt">LineNo</span> <span class="op">|</span> <span class="dt">Hit</span> <span class="op">|</span> <span class="dt">Ket</span> <span class="dt">LineNo</span>   <span class="kw">deriving</span> (<span class="dt">Show</span>)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="ot">scan ::</span> <span class="dt">RE</span> <span class="ot">-&gt;</span> [<span class="dt">LBS.ByteString</span>] <span class="ot">-&gt;</span> [<span class="dt">Token</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>scan rex <span class="ot">=</span> grepWithScript</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>    [ (,) [re|\\begin\{code\}|] <span class="op">$</span> \i <span class="ot">-&gt;</span> chk <span class="op">$</span> <span class="dt">Bra</span> i</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a>    , (,) rex                   <span class="op">$</span> \_ <span class="ot">-&gt;</span> chk   <span class="dt">Hit</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>    , (,) [re|\\end\{code\}|]   <span class="op">$</span> \i <span class="ot">-&gt;</span> chk <span class="op">$</span> <span class="dt">Ket</span> i</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a>    ]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a>    chk x mtchs <span class="ot">=</span> <span class="kw">case</span> anyMatches mtchs <span class="kw">of</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a>      <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="dt">Just</span> x</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a>      <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
<h2 id="badges">badges</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="ot">badges ::</span> <span class="dt">IO</span> ()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>badges <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a>    <span class="fu">mapM_</span> collect</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a>      [ (,) <span class="st">&quot;license&quot;</span>             <span class="st">&quot;https://img.shields.io/badge/license-BSD3-brightgreen.svg&quot;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a>      , (,) <span class="st">&quot;unix-build&quot;</span>          <span class="st">&quot;https://img.shields.io/travis/iconnect/regex.svg?label=Linux%2BmacOS&quot;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>      , (,) <span class="st">&quot;windows-build&quot;</span>       <span class="st">&quot;https://img.shields.io/appveyor/ci/cdornan/regex.svg?label=Windows&quot;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a>      , (,) <span class="st">&quot;coverage&quot;</span>            <span class="st">&quot;https://img.shields.io/coveralls/iconnect/regex.svg&quot;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a>      , (,) <span class="st">&quot;build-status&quot;</span>        <span class="st">&quot;https://img.shields.io/travis/iconnect/regex.svg?label=Build%20Status&quot;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true"></a>      , (,) <span class="st">&quot;maintainers-contact&quot;</span> <span class="st">&quot;https://img.shields.io/badge/email-maintainers%40regex.uk-blue.svg&quot;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true"></a>      , (,) <span class="st">&quot;feedback-contact&quot;</span>    <span class="st">&quot;https://img.shields.io/badge/email-feedback%40regex.uk-blue.svg&quot;</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true"></a>      ]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true"></a>    collect (nm,url) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true"></a>      <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;updating badge: &quot;</span> <span class="op">++</span> nm</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true"></a>      simpleHttp url <span class="op">&gt;&gt;=</span> LBS.writeFile (badge_fn nm)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true"></a>    badge_fn nm <span class="ot">=</span> <span class="st">&quot;docs/badges/&quot;</span><span class="op">++</span>nm<span class="op">++</span><span class="st">&quot;.svg&quot;</span></span></code></pre></div>
<h2 id="blog_badge">blog_badge</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="ot">blog_badge ::</span> <span class="dt">IO</span> ()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>blog_badge <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>  dts <span class="ot">&lt;-</span> L.sortBy (<span class="fu">flip</span> <span class="fu">compare</span>) <span class="op">.</span> <span class="fu">map</span> (<span class="fu">take</span> <span class="dv">10</span>) <span class="op">&lt;$&gt;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>            getDirectoryContents <span class="st">&quot;../regex-blog/posts&quot;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>  <span class="kw">case</span> dts <span class="kw">of</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>    []   <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;No posts found!&quot;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>    dt<span class="op">:</span>_ <span class="ot">-&gt;</span> <span class="kw">case</span> matched <span class="op">$</span> dt_lbs <span class="op">?=~</span> date_re <span class="kw">of</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>        <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Post date format not recognised: &quot;</span> <span class="op">++</span> dt</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a>        <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>          <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Latest blog is: &quot;</span> <span class="op">++</span> dt</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a>          lbs <span class="ot">&lt;-</span> lbsReadFile badges_file</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a>          LBS.writeFile badges_file <span class="op">$</span> replaceAll dt_lbs <span class="op">$</span> lbs <span class="op">*=~</span> date_re</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>      <span class="kw">where</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a>        dt_lbs      <span class="ot">=</span> LBS.pack dt</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a>    date_re     <span class="ot">=</span> [re|[0-9]{4}-[0-9]{2}-[0-9]{2}|]</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a>    badges_file <span class="ot">=</span> <span class="st">&quot;docs/badges/blog.svg&quot;</span></span></code></pre></div>
<h2 id="pages">pages</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="ot">pages ::</span> <span class="dt">IO</span> ()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a>pages <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a>  prep_page <span class="st">&quot;regex&quot;</span>          <span class="dt">MM_hackage</span> <span class="st">&quot;lib/md/index.md&quot;</span> <span class="st">&quot;lib/README-regex.md&quot;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>  prep_page <span class="st">&quot;regex-examples&quot;</span> <span class="dt">MM_hackage</span> <span class="st">&quot;lib/md/index.md&quot;</span> <span class="st">&quot;lib/README-regex-examples.md&quot;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>  prep_page <span class="st">&quot;regex&quot;</span>          <span class="dt">MM_github</span>  <span class="st">&quot;lib/md/index.md&quot;</span> <span class="st">&quot;README.md&quot;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>  <span class="fu">mapM_</span> pandoc_page [<span class="fu">minBound</span><span class="op">..</span><span class="fu">maxBound</span>]</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Page</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>  <span class="ot">=</span> <span class="dt">PG_index</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_about</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_reblog</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_contact</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_build_status</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_installation</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_tutorial</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_examples</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_roadmap</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_macros</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_directory</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">PG_changelog</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Bounded</span>,<span class="dt">Enum</span>,<span class="dt">Eq</span>,<span class="dt">Ord</span>,<span class="dt">Show</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true"></a><span class="ot">page_root ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true"></a>page_root <span class="ot">=</span> <span class="fu">map</span> tr <span class="op">.</span> <span class="fu">drop</span> <span class="dv">3</span> <span class="op">.</span> <span class="fu">show</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true"></a>    tr <span class="ch">&#39;_&#39;</span> <span class="ot">=</span> <span class="ch">&#39;-&#39;</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true"></a>    tr c   <span class="ot">=</span> c</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true"></a>page_master_file,<span class="ot"> page_docs_file ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true"></a>page_master_file pg <span class="ot">=</span> <span class="st">&quot;lib/md/&quot;</span> <span class="op">++</span> page_root pg <span class="op">++</span> <span class="st">&quot;.md&quot;</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true"></a>page_docs_file   pg <span class="ot">=</span> <span class="st">&quot;docs/&quot;</span>   <span class="op">++</span> page_root pg <span class="op">++</span> <span class="st">&quot;.html&quot;</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true"></a><span class="ot">page_address ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true"></a>page_address <span class="dt">PG_reblog</span> <span class="ot">=</span> <span class="st">&quot;blog&quot;</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true"></a>page_address pg        <span class="ot">=</span> LBS.pack <span class="op">$</span> page_root pg</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true"></a><span class="ot">page_title ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true"></a>page_title pg <span class="ot">=</span> <span class="kw">case</span> pg <span class="kw">of</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true"></a>  <span class="dt">PG_index</span>        <span class="ot">-&gt;</span> <span class="st">&quot;Home&quot;</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true"></a>  <span class="dt">PG_about</span>        <span class="ot">-&gt;</span> <span class="st">&quot;About&quot;</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true"></a>  <span class="dt">PG_reblog</span>       <span class="ot">-&gt;</span> <span class="st">&quot;Blog&quot;</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true"></a>  <span class="dt">PG_contact</span>      <span class="ot">-&gt;</span> <span class="st">&quot;Contact&quot;</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true"></a>  <span class="dt">PG_build_status</span> <span class="ot">-&gt;</span> <span class="st">&quot;Build Status&quot;</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true"></a>  <span class="dt">PG_installation</span> <span class="ot">-&gt;</span> <span class="st">&quot;Installation&quot;</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true"></a>  <span class="dt">PG_tutorial</span>     <span class="ot">-&gt;</span> <span class="st">&quot;Tutorial&quot;</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true"></a>  <span class="dt">PG_examples</span>     <span class="ot">-&gt;</span> <span class="st">&quot;Examples&quot;</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true"></a>  <span class="dt">PG_roadmap</span>      <span class="ot">-&gt;</span> <span class="st">&quot;Roadmap&quot;</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true"></a>  <span class="dt">PG_macros</span>       <span class="ot">-&gt;</span> <span class="st">&quot;Macro Tables&quot;</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true"></a>  <span class="dt">PG_directory</span>    <span class="ot">-&gt;</span> <span class="st">&quot;Directory&quot;</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true"></a>  <span class="dt">PG_changelog</span>    <span class="ot">-&gt;</span> <span class="st">&quot;Change Log&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="ot">pandoc_page ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a>pandoc_page pg <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>  mt_lbs <span class="ot">&lt;-</span> setup_ttl <span class="op">&lt;$&gt;</span> LBS.readFile (page_master_file pg)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>  (hdgs,md_lbs) <span class="ot">&lt;-</span> prep_page&#39; <span class="dt">MM_pandoc</span> mt_lbs</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/metadata.markdown&quot;</span>  <span class="op">$</span> LBS.unlines [<span class="st">&quot;---&quot;</span>,<span class="st">&quot;title: &quot;</span> <span class="op">M.&lt;&gt;</span> page_title pg,<span class="st">&quot;---&quot;</span>]</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/heading.markdown&quot;</span>   <span class="op">$</span> page_heading pg</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/page_pre_body.html&quot;</span> <span class="op">$</span> mk_pre_body_html pg hdgs</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/page_pst_body.html&quot;</span>   pst_body_html</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/page.markdown&quot;</span>        md_lbs</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a>  SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>    SH.run_ <span class="st">&quot;pandoc&quot;</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>      [ <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;markdown+grid_tables+autolink_bare_uris&quot;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a>      , <span class="st">&quot;-t&quot;</span>, <span class="st">&quot;html5&quot;</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>      , <span class="st">&quot;-T&quot;</span>, <span class="st">&quot;regex&quot;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true"></a>      , <span class="st">&quot;-s&quot;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true"></a>      , <span class="st">&quot;-H&quot;</span>, <span class="st">&quot;lib/favicons.html&quot;</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true"></a>      , <span class="st">&quot;-B&quot;</span>, <span class="st">&quot;tmp/page_pre_body.html&quot;</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true"></a>      , <span class="st">&quot;-A&quot;</span>, <span class="st">&quot;tmp/page_pst_body.html&quot;</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true"></a>      , <span class="st">&quot;-c&quot;</span>, <span class="st">&quot;lib/styles.css&quot;</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true"></a>      , <span class="st">&quot;-o&quot;</span>, T.pack <span class="op">$</span> page_docs_file pg</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true"></a>      , <span class="st">&quot;tmp/metadata.markdown&quot;</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true"></a>      , <span class="st">&quot;tmp/heading.markdown&quot;</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true"></a>      , <span class="st">&quot;tmp/page.markdown&quot;</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true"></a>      ]</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true"></a>    setup_ttl <span class="ot">=</span> <span class="kw">case</span> pg <span class="kw">of</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true"></a>      <span class="dt">PG_index</span> <span class="ot">-&gt;</span> set_title <span class="st">&quot;regex&quot;</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true"></a>      _        <span class="ot">-&gt;</span> <span class="fu">id</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Heading</span> <span class="ot">=</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true"></a>  <span class="dt">Heading</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true"></a>    {<span class="ot"> _hdg_id    ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true"></a>    ,<span class="ot"> _hdg_title ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true"></a>    }</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">MarkdownMode</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true"></a>  <span class="ot">=</span> <span class="dt">MM_github</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">MM_hackage</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true"></a>  <span class="op">|</span> <span class="dt">MM_pandoc</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>,<span class="dt">Show</span>)</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true"></a><span class="ot">page_heading ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true"></a>page_heading <span class="dt">PG_index</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true"></a>page_heading pg       <span class="ot">=</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true"></a>  <span class="st">&quot;&lt;p class=&#39;pagebc&#39;&gt;&lt;a href=&#39;.&#39; title=&#39;Home&#39;&gt;Home&lt;/a&gt; &amp;raquo; **&quot;</span> <span class="op">M.&lt;&gt;</span> page_title pg <span class="op">M.&lt;&gt;</span> <span class="st">&quot;**&lt;/p&gt;\n&quot;</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true"></a></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true"></a><span class="ot">prep_page ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">MarkdownMode</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true"></a>prep_page ttl mmd in_fp out_fp <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true"></a>  lbs      <span class="ot">&lt;-</span> set_title ttl <span class="op">&lt;$&gt;</span> LBS.readFile in_fp</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true"></a>  (_,lbs&#39;) <span class="ot">&lt;-</span> prep_page&#39; mmd lbs</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true"></a>  LBS.writeFile out_fp lbs&#39;</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true"></a></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true"></a><span class="ot">set_title ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true"></a>set_title ttl lbs <span class="ot">=</span> fromMaybe oops <span class="op">$</span> <span class="fu">flip</span> sed&#39; lbs <span class="op">$</span> <span class="dt">Pipe</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true"></a>    [ <span class="dt">Function</span> [re|&lt;&lt;\$title\$&gt;&gt;|] <span class="dt">TOP</span> <span class="op">$</span> \_ _ _ _<span class="ot">-&gt;</span><span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> ttl</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true"></a>    ]</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true"></a>    <span class="co">-- runIdentity added to base in 4.9 only</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true"></a>    oops <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;set_title&quot;</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true"></a></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true"></a><span class="ot">prep_page&#39; ::</span> <span class="dt">MarkdownMode</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ([<span class="dt">Heading</span>],<span class="dt">LBS.ByteString</span>)</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true"></a>prep_page&#39; mmd lbs <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true"></a>    rf_h <span class="ot">&lt;-</span> newIORef []</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true"></a>    rf_t <span class="ot">&lt;-</span> newIORef <span class="dt">False</span></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true"></a>    lbs1 <span class="ot">&lt;-</span> <span class="fu">fmap</span> (tweak_md mmd) <span class="op">$</span> sed&#39; (scr rf_h rf_t) <span class="op">=&lt;&lt;</span> include lbs</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true"></a>    lbs2 <span class="ot">&lt;-</span> fromMaybe <span class="st">&quot;&quot;</span> <span class="op">&lt;$&gt;</span> fin_task_list&#39; mmd rf_t</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true"></a>    hdgs <span class="ot">&lt;-</span> <span class="fu">reverse</span> <span class="op">&lt;$&gt;</span> readIORef rf_h</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true"></a>    <span class="fu">return</span> (hdgs,lbs1 <span class="op">M.&lt;&gt;</span> lbs2)</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true"></a>    scr rf_h rf_t <span class="ot">=</span> <span class="dt">Select</span></span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true"></a>      [ <span class="dt">Function</span> [re|^%heading#${ide}(@{%id}) +${ttl}([^ ].*)$|] <span class="dt">TOP</span> <span class="op">$</span> heading       mmd rf_t rf_h</span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true"></a>      , <span class="dt">Function</span> [re|^- \[ \] +${itm}(.*)$|]                     <span class="dt">TOP</span> <span class="op">$</span> task_list     mmd rf_t <span class="dt">False</span></span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true"></a>      , <span class="dt">Function</span> [re|^- \[[Xx]\] +${itm}(.*)$|]                  <span class="dt">TOP</span> <span class="op">$</span> task_list     mmd rf_t <span class="dt">True</span></span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true"></a>      , <span class="dt">Function</span> [re|^.*$|]                                      <span class="dt">TOP</span> <span class="op">$</span> fin_task_list mmd rf_t</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true"></a>      ]</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true"></a></span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true"></a><span class="ot">heading ::</span> <span class="dt">MarkdownMode</span></span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span></span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">IORef</span> [<span class="dt">Heading</span>]</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">LineNo</span></span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">RELocation</span></span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true"></a>        <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)</span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true"></a>heading mmd rf_t rf_h _ mtch _ _ <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true"></a>    lbs <span class="ot">&lt;-</span> fromMaybe <span class="st">&quot;&quot;</span> <span class="op">&lt;$&gt;</span> fin_task_list&#39; mmd rf_t</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true"></a>    modifyIORef rf_h (<span class="dt">Heading</span> ide ttl<span class="op">:</span>)</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span> lbs <span class="op">M.&lt;&gt;</span> h2</span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true"></a>    h2 <span class="ot">=</span> <span class="kw">case</span> mmd <span class="kw">of</span></span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true"></a>      <span class="dt">MM_github</span>  <span class="ot">-&gt;</span> <span class="st">&quot;## &quot;</span> <span class="op">M.&lt;&gt;</span> ttl</span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true"></a>      <span class="dt">MM_hackage</span> <span class="ot">-&gt;</span> <span class="st">&quot;## &quot;</span> <span class="op">M.&lt;&gt;</span> ttl</span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true"></a>      <span class="dt">MM_pandoc</span>  <span class="ot">-&gt;</span> <span class="st">&quot;&lt;h2 id=&#39;&quot;</span> <span class="op">M.&lt;&gt;</span> ide <span class="op">M.&lt;&gt;</span> <span class="st">&quot;&#39;&gt;&quot;</span> <span class="op">M.&lt;&gt;</span> ttl <span class="op">M.&lt;&gt;</span> <span class="st">&quot;&lt;/h2&gt;&quot;</span></span>
<span id="cb27-95"><a href="#cb27-95" aria-hidden="true"></a></span>
<span id="cb27-96"><a href="#cb27-96" aria-hidden="true"></a>    ide <span class="ot">=</span> mtch <span class="op">!$$</span> [cp|ide|]</span>
<span id="cb27-97"><a href="#cb27-97" aria-hidden="true"></a>    ttl <span class="ot">=</span> mtch <span class="op">!$$</span> [cp|ttl|]</span>
<span id="cb27-98"><a href="#cb27-98" aria-hidden="true"></a></span>
<span id="cb27-99"><a href="#cb27-99" aria-hidden="true"></a><span class="ot">mk_pre_body_html ::</span> <span class="dt">Page</span> <span class="ot">-&gt;</span> [<span class="dt">Heading</span>] <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-100"><a href="#cb27-100" aria-hidden="true"></a>mk_pre_body_html pg hdgs <span class="ot">=</span> hdr <span class="op">M.&lt;&gt;</span> LBS.concat (<span class="fu">map</span> nav [<span class="fu">minBound</span><span class="op">..</span><span class="fu">maxBound</span>]) <span class="op">M.&lt;&gt;</span> ftr</span>
<span id="cb27-101"><a href="#cb27-101" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb27-102"><a href="#cb27-102" aria-hidden="true"></a><span class="ot">    hdr ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-103"><a href="#cb27-103" aria-hidden="true"></a>    hdr <span class="ot">=</span> [here|    &lt;div id=&quot;container&quot;&gt;</span>
<span id="cb27-104"><a href="#cb27-104" aria-hidden="true"></a>    &lt;div id=&quot;sidebar&quot;&gt;</span>
<span id="cb27-105"><a href="#cb27-105" aria-hidden="true"></a>      &lt;div id=&quot;corner&quot;&gt;</span>
<span id="cb27-106"><a href="#cb27-106" aria-hidden="true"></a>        |] <span class="op">M.&lt;&gt;</span> branding <span class="op">M.&lt;&gt;</span> [here|</span>
<span id="cb27-107"><a href="#cb27-107" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-108"><a href="#cb27-108" aria-hidden="true"></a>      &lt;div class=&quot;widget&quot; id=&quot;pages&quot;&gt;</span>
<span id="cb27-109"><a href="#cb27-109" aria-hidden="true"></a>        &lt;ul class=&quot;page-nav&quot;&gt;</span>
<span id="cb27-110"><a href="#cb27-110" aria-hidden="true"></a>|]</span>
<span id="cb27-111"><a href="#cb27-111" aria-hidden="true"></a></span>
<span id="cb27-112"><a href="#cb27-112" aria-hidden="true"></a>    nav dst_pg <span class="ot">=</span> LBS.unlines <span class="op">$</span></span>
<span id="cb27-113"><a href="#cb27-113" aria-hidden="true"></a>      nav_li <span class="st">&quot;          &quot;</span> pg_cls pg_adr pg_ttl <span class="op">:</span></span>
<span id="cb27-114"><a href="#cb27-114" aria-hidden="true"></a>        [ nav_li <span class="st">&quot;            &quot;</span> [<span class="st">&quot;secnav&quot;</span>] (<span class="st">&quot;#&quot;</span> <span class="op">M.&lt;&gt;</span> _hdg_id) _hdg_title</span>
<span id="cb27-115"><a href="#cb27-115" aria-hidden="true"></a>          <span class="op">|</span> <span class="dt">Heading</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> hdgs</span>
<span id="cb27-116"><a href="#cb27-116" aria-hidden="true"></a>          , is_moi</span>
<span id="cb27-117"><a href="#cb27-117" aria-hidden="true"></a>          ]</span>
<span id="cb27-118"><a href="#cb27-118" aria-hidden="true"></a>      <span class="kw">where</span></span>
<span id="cb27-119"><a href="#cb27-119" aria-hidden="true"></a>        pg_cls <span class="ot">=</span> [<span class="st">&quot;pagenav&quot;</span>,<span class="kw">if</span> is_moi <span class="kw">then</span> <span class="st">&quot;moi&quot;</span> <span class="kw">else</span> <span class="st">&quot;toi&quot;</span>]</span>
<span id="cb27-120"><a href="#cb27-120" aria-hidden="true"></a>        pg_adr <span class="ot">=</span> page_address dst_pg</span>
<span id="cb27-121"><a href="#cb27-121" aria-hidden="true"></a>        pg_ttl <span class="ot">=</span> page_title   dst_pg</span>
<span id="cb27-122"><a href="#cb27-122" aria-hidden="true"></a>        is_moi <span class="ot">=</span> pg <span class="op">==</span> dst_pg</span>
<span id="cb27-123"><a href="#cb27-123" aria-hidden="true"></a></span>
<span id="cb27-124"><a href="#cb27-124" aria-hidden="true"></a>    nav_li pfx cls dst title <span class="ot">=</span> LBS.concat</span>
<span id="cb27-125"><a href="#cb27-125" aria-hidden="true"></a>      [ pfx</span>
<span id="cb27-126"><a href="#cb27-126" aria-hidden="true"></a>      , <span class="st">&quot;&lt;li class=&#39;&quot;</span></span>
<span id="cb27-127"><a href="#cb27-127" aria-hidden="true"></a>      , LBS.unwords cls</span>
<span id="cb27-128"><a href="#cb27-128" aria-hidden="true"></a>      , <span class="st">&quot;&#39;&gt;&lt;a href=&#39;&quot;</span></span>
<span id="cb27-129"><a href="#cb27-129" aria-hidden="true"></a>      , dst</span>
<span id="cb27-130"><a href="#cb27-130" aria-hidden="true"></a>      , <span class="st">&quot;&#39;&gt;&quot;</span></span>
<span id="cb27-131"><a href="#cb27-131" aria-hidden="true"></a>      , title</span>
<span id="cb27-132"><a href="#cb27-132" aria-hidden="true"></a>      , <span class="st">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span></span>
<span id="cb27-133"><a href="#cb27-133" aria-hidden="true"></a>      ]</span>
<span id="cb27-134"><a href="#cb27-134" aria-hidden="true"></a></span>
<span id="cb27-135"><a href="#cb27-135" aria-hidden="true"></a>    ftr <span class="ot">=</span> [here|          &lt;/ul&gt;</span>
<span id="cb27-136"><a href="#cb27-136" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-137"><a href="#cb27-137" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget&quot; id=&quot;github&quot;&gt;</span>
<span id="cb27-138"><a href="#cb27-138" aria-hidden="true"></a>        &lt;a href=&quot;http://code.regex.uk&quot;&gt;&lt;img src=&quot;images/code.svg&quot; alt=&quot;github code&quot; /&gt; Code&lt;/a&gt;</span>
<span id="cb27-139"><a href="#cb27-139" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-140"><a href="#cb27-140" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget&quot; id=&quot;github-issues&quot;&gt;</span>
<span id="cb27-141"><a href="#cb27-141" aria-hidden="true"></a>        &lt;a href=&quot;http://issues.regex.uk&quot;&gt;&lt;img src=&quot;images/issue-opened.svg&quot; alt=&quot;github issues&quot; /&gt; Issues&lt;/a&gt;</span>
<span id="cb27-142"><a href="#cb27-142" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-143"><a href="#cb27-143" aria-hidden="true"></a>      &lt;div class=&quot;widget-divider&quot;&gt;&amp;nbsp;&lt;/div&gt;</span>
<span id="cb27-144"><a href="#cb27-144" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget&quot; id=&quot;blog-badge&quot;&gt;</span>
<span id="cb27-145"><a href="#cb27-145" aria-hidden="true"></a>        &lt;a href=&quot;http://blog.regex.uk&quot;&gt;</span>
<span id="cb27-146"><a href="#cb27-146" aria-hidden="true"></a>          &lt;img src=&quot;badges/blog.svg&quot; alt=&quot;regex blog&quot; /&gt;</span>
<span id="cb27-147"><a href="#cb27-147" aria-hidden="true"></a>        &lt;/a&gt;</span>
<span id="cb27-148"><a href="#cb27-148" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-149"><a href="#cb27-149" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget&quot; id=&quot;hackage-badge&quot;&gt;</span>
<span id="cb27-150"><a href="#cb27-150" aria-hidden="true"></a>        &lt;a href=&quot;https://hackage.haskell.org/package/regex&quot;&gt;</span>
<span id="cb27-151"><a href="#cb27-151" aria-hidden="true"></a>          &lt;img src=&quot;badges/hackage.svg&quot; alt=&quot;hackage version&quot; /&gt;</span>
<span id="cb27-152"><a href="#cb27-152" aria-hidden="true"></a>        &lt;/a&gt;</span>
<span id="cb27-153"><a href="#cb27-153" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-154"><a href="#cb27-154" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget&quot; id=&quot;build-status-badge&quot;&gt;</span>
<span id="cb27-155"><a href="#cb27-155" aria-hidden="true"></a>        &lt;a href=&quot;build-status&quot;&gt;</span>
<span id="cb27-156"><a href="#cb27-156" aria-hidden="true"></a>          &lt;img src=&quot;badges/build-status.svg&quot; alt=&quot;build status&quot; /&gt;</span>
<span id="cb27-157"><a href="#cb27-157" aria-hidden="true"></a>        &lt;/a&gt;</span>
<span id="cb27-158"><a href="#cb27-158" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-159"><a href="#cb27-159" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget&quot; id=&quot;maintainers-contact&quot;&gt;</span>
<span id="cb27-160"><a href="#cb27-160" aria-hidden="true"></a>        &lt;a href=&quot;mailto:maintainers@regex.uk&quot;&gt;</span>
<span id="cb27-161"><a href="#cb27-161" aria-hidden="true"></a>          &lt;img src=&quot;badges/maintainers-contact.svg&quot; alt=&quot;maintainers contact&quot; /&gt;</span>
<span id="cb27-162"><a href="#cb27-162" aria-hidden="true"></a>        &lt;/a&gt;</span>
<span id="cb27-163"><a href="#cb27-163" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-164"><a href="#cb27-164" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget&quot; id=&quot;feedback-contact&quot;&gt;</span>
<span id="cb27-165"><a href="#cb27-165" aria-hidden="true"></a>        &lt;a href=&quot;mailto:feedback@regex.uk&quot;&gt;</span>
<span id="cb27-166"><a href="#cb27-166" aria-hidden="true"></a>          &lt;img src=&quot;badges/feedback-contact.svg&quot; alt=&quot;deedback contact&quot; /&gt;</span>
<span id="cb27-167"><a href="#cb27-167" aria-hidden="true"></a>        &lt;/a&gt;</span>
<span id="cb27-168"><a href="#cb27-168" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-169"><a href="#cb27-169" aria-hidden="true"></a>      &lt;div class=&quot;supplementary widget twitter&quot;&gt;</span>
<span id="cb27-170"><a href="#cb27-170" aria-hidden="true"></a>        &lt;iframe style=&quot;width:162px; height:20px;&quot; src=&quot;https://platform.twitter.com/widgets/follow_button.html?screen_name=hregex&amp;amp;show_count=false&quot;&gt;</span>
<span id="cb27-171"><a href="#cb27-171" aria-hidden="true"></a>        &lt;/iframe&gt;</span>
<span id="cb27-172"><a href="#cb27-172" aria-hidden="true"></a>      &lt;/div&gt;</span>
<span id="cb27-173"><a href="#cb27-173" aria-hidden="true"></a>    &lt;/div&gt;</span>
<span id="cb27-174"><a href="#cb27-174" aria-hidden="true"></a>    &lt;div id=&quot;content&quot;&gt;</span>
<span id="cb27-175"><a href="#cb27-175" aria-hidden="true"></a>|]</span>
<span id="cb27-176"><a href="#cb27-176" aria-hidden="true"></a></span>
<span id="cb27-177"><a href="#cb27-177" aria-hidden="true"></a><span class="ot">pst_body_html ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb27-178"><a href="#cb27-178" aria-hidden="true"></a>pst_body_html <span class="ot">=</span> [here|      &lt;/div&gt;</span>
<span id="cb27-179"><a href="#cb27-179" aria-hidden="true"></a>    &lt;/div&gt;</span>
<span id="cb27-180"><a href="#cb27-180" aria-hidden="true"></a>|] <span class="op">M.&lt;&gt;</span> tracking</span></code></pre></div>
<h2 id="task-lists">Task Lists</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a><span class="co">-- | replacement function to convert GFM task list line into HTML if we</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a><span class="co">-- aren&#39;t writing GFM (i.e.,  generating markdown for GitHub)</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a><span class="ot">task_list ::</span> <span class="dt">MarkdownMode</span>               <span class="co">-- ^ what flavour of md are we generating</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span>                 <span class="co">-- ^ will contain True iff we have already entered a task list</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Bool</span>                       <span class="co">-- ^ true if this is a checjed line</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">LineNo</span>                     <span class="co">-- ^ line no of the replacement redex (unused)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span>       <span class="co">-- ^ the matched task-list line</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">RELocation</span>                   <span class="co">-- ^ which match and capure (unused)</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span>     <span class="co">-- ^ the capture weare replacing (unsuded)</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true"></a>          <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)  <span class="co">-- ^ the replacement text, or Nothing to indicate no change to this line</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true"></a>task_list mmd rf chk _ mtch _ _ <span class="ot">=</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true"></a>  <span class="kw">case</span> mmd <span class="kw">of</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true"></a>    <span class="dt">MM_github</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true"></a>    <span class="dt">MM_hackage</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span> <span class="st">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> <span class="op">M.&lt;&gt;</span> cb <span class="op">M.&lt;&gt;</span> <span class="st">&quot;&amp;nbsp;&amp;nbsp;&quot;</span> <span class="op">M.&lt;&gt;</span> itm <span class="op">M.&lt;&gt;</span> <span class="st">&quot;\n&quot;</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true"></a>    <span class="dt">MM_pandoc</span>  <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true"></a>      in_tl <span class="ot">&lt;-</span> readIORef rf</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true"></a>      writeIORef rf <span class="dt">True</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true"></a>      <span class="fu">return</span> <span class="op">$</span> tl_line in_tl chk</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true"></a>    tl_line in_tl enbl <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span> LBS.concat</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true"></a>      [ <span class="kw">if</span> in_tl <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="kw">else</span> <span class="st">&quot;&lt;ul class=&#39;contains-task-list&#39;&gt;\n&quot;</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true"></a>      , <span class="st">&quot;  &lt;li class=&#39;task-list-item&#39;&gt;&quot;</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true"></a>      , <span class="st">&quot;&lt;input type=&#39;checkbox&#39; class=&#39;task-list-item-checkbox&#39;&quot;</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true"></a>      , <span class="kw">if</span> enbl <span class="kw">then</span> <span class="st">&quot; checked=&#39;&#39;&quot;</span> <span class="kw">else</span> <span class="st">&quot;&quot;</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true"></a>      , <span class="st">&quot; disabled=&#39;&#39;/&gt;&quot;</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true"></a>      , itm</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true"></a>      , <span class="st">&quot;&lt;/li&gt;&quot;</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true"></a>      ]</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true"></a>    cb  <span class="ot">=</span> <span class="kw">if</span> chk <span class="kw">then</span> <span class="st">&quot;&amp;#x2612;&quot;</span> <span class="kw">else</span> <span class="st">&quot;&amp;#x2610;&quot;</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true"></a>    itm <span class="ot">=</span> mtch <span class="op">!$$</span> [cp|itm|]</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true"></a><span class="co">-- | replacement function used for &#39;other&#39; lines -- terminate any task</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true"></a><span class="co">-- list that was being generated</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true"></a><span class="ot">fin_task_list ::</span> <span class="dt">MarkdownMode</span>               <span class="co">-- ^ what flavour of md are we generating</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span>                 <span class="co">-- ^ will contain True iff we have already entered a task list</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">LineNo</span>                     <span class="co">-- ^ line no of the replacement redex (unused)</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">Match</span> <span class="dt">LBS.ByteString</span>       <span class="co">-- ^ the matched task-list line</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">RELocation</span>                   <span class="co">-- ^ which match and capure (unused)</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">Capture</span> <span class="dt">LBS.ByteString</span>     <span class="co">-- ^ the capture weare replacing (unsuded)</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true"></a>              <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>)  <span class="co">-- ^ the replacement text, or Nothing to indicate no change to this line</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true"></a>fin_task_list mmd rf_t _ mtch _ _ <span class="ot">=</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true"></a>  <span class="fu">fmap</span> ( <span class="op">M.&lt;&gt;</span> matchSource mtch) <span class="op">&lt;$&gt;</span> fin_task_list&#39; mmd rf_t</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true"></a></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true"></a><span class="co">-- | close any task list being processed, returning the closing text</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true"></a><span class="co">-- as necessary</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true"></a><span class="ot">fin_task_list&#39; ::</span> <span class="dt">MarkdownMode</span>              <span class="co">-- ^ what flavour of md are we generating</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true"></a>               <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">Bool</span>                <span class="co">-- ^ will contain True iff we have already entered a task list</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true"></a>               <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">LBS.ByteString</span>) <span class="co">-- ^ task-list closure HTML, if task-list HTML needs closing</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true"></a>fin_task_list&#39; mmd rf <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true"></a>  in_tl <span class="ot">&lt;-</span> readIORef rf</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true"></a>  writeIORef rf <span class="dt">False</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true"></a>  <span class="kw">case</span> mmd<span class="op">==</span><span class="dt">MM_github</span> <span class="op">||</span> <span class="fu">not</span> in_tl <span class="kw">of</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true"></a>    <span class="dt">True</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true"></a>    <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> <span class="op">$</span> <span class="st">&quot;&lt;/ul&gt;\n&quot;</span></span></code></pre></div>
<h2 id="literate-haskell-pages">Literate Haskell Pages</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="ot">pandoc_lhs ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>pandoc_lhs title in_file <span class="ot">=</span> pandoc_lhs&#39; title in_file in_file</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a><span class="ot">pandoc_lhs&#39; ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true"></a>pandoc_lhs&#39; title repo_path in_file out_file <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true"></a>  lbsReadFile in_file <span class="op">&gt;&gt;=</span> include_code_pp <span class="op">&gt;&gt;=</span> LBS.writeFile int_file</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/metadata.markdown&quot;</span>  <span class="op">$</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true"></a>                    LBS.unlines</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true"></a>                      [ <span class="st">&quot;---&quot;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true"></a>                      , <span class="st">&quot;title: &quot;</span> <span class="op">M.&lt;&gt;</span> LBS.pack title</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true"></a>                      , <span class="st">&quot;---&quot;</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true"></a>                      ]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/bc.html&quot;</span> bc</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true"></a>  LBS.writeFile <span class="st">&quot;tmp/ft.html&quot;</span> ft</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true"></a>  <span class="fu">fmap</span> (<span class="fu">const</span> ()) <span class="op">$</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true"></a>    SH.shelly <span class="op">$</span> SH.verbosely <span class="op">$</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true"></a>      SH.run <span class="st">&quot;pandoc&quot;</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true"></a>        [ <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;markdown+lhs+grid_tables&quot;</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true"></a>        , <span class="st">&quot;-t&quot;</span>, <span class="st">&quot;html5&quot;</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true"></a>        , <span class="st">&quot;-T&quot;</span>, <span class="st">&quot;regex&quot;</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true"></a>        , <span class="st">&quot;-s&quot;</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true"></a>        , <span class="st">&quot;-H&quot;</span>, <span class="st">&quot;lib/favicons.html&quot;</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true"></a>        , <span class="st">&quot;-B&quot;</span>, <span class="st">&quot;tmp/bc.html&quot;</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true"></a>        , <span class="st">&quot;-A&quot;</span>, <span class="st">&quot;tmp/ft.html&quot;</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true"></a>        , <span class="st">&quot;-c&quot;</span>, <span class="st">&quot;lib/lhs-styles.css&quot;</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true"></a>        , <span class="st">&quot;-c&quot;</span>, <span class="st">&quot;lib/bs.css&quot;</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true"></a>        , <span class="st">&quot;-o&quot;</span>, T.pack out_file</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true"></a>        , <span class="st">&quot;tmp/metadata.markdown&quot;</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true"></a>        , T.pack int_file</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true"></a>        ]</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true"></a>    bc <span class="ot">=</span> LBS.unlines</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true"></a>    <span class="co">--  [ &quot;&lt;div class=&#39;brandingdiv&#39;&gt;&quot;</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true"></a>    <span class="co">--  , &quot;  &quot; M.&lt;&gt; branding</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true"></a>    <span class="co">--  , &quot;&lt;/div&gt;&quot;</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true"></a>      [ <span class="st">&quot;&lt;div class=&#39;bcdiv&#39;&gt;&quot;</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true"></a>      , <span class="st">&quot;  &lt;ol class=&#39;breadcrumb&#39;&gt;&quot;</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true"></a>      , <span class="st">&quot;    &lt;li&gt;&quot;</span> <span class="op">M.&lt;&gt;</span> branding <span class="op">M.&lt;&gt;</span> <span class="st">&quot;&lt;/li&gt;&quot;</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true"></a>      , <span class="st">&quot;    &lt;li&gt;&lt;a title=&#39;source file&#39; href=&#39;&quot;</span>  <span class="op">M.&lt;&gt;</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true"></a>              repo_url <span class="op">M.&lt;&gt;</span> <span class="st">&quot;&#39;&gt;&quot;</span> <span class="op">M.&lt;&gt;</span> (LBS.pack title) <span class="op">M.&lt;&gt;</span> <span class="st">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true"></a>      , <span class="st">&quot;&lt;/ol&gt;&quot;</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true"></a>      , <span class="st">&quot;&lt;/div&gt;&quot;</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true"></a>      , <span class="st">&quot;&lt;div class=&#39;litcontent&#39;&gt;&quot;</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true"></a>      ]</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true"></a>    ft <span class="ot">=</span> LBS.concat</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true"></a>      [ <span class="st">&quot;&lt;/div&gt;&quot;</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true"></a>      ] <span class="op">M.&lt;&gt;</span> tracking</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true"></a>    repo_url <span class="ot">=</span> LBS.concat</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true"></a>      [ <span class="st">&quot;https://github.com/iconnect/regex/blob/master/&quot;</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true"></a>      , LBS.pack repo_path</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true"></a>      ]</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true"></a></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true"></a>    int_file <span class="ot">=</span> <span class="st">&quot;tmp/pandoc-int.lhs&quot;</span></span></code></pre></div>
<h2 id="tweak_md">tweak_md</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="ot">tweak_md ::</span> <span class="dt">MarkdownMode</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>tweak_md mm lbs <span class="ot">=</span> <span class="kw">case</span> mm <span class="kw">of</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>    <span class="dt">MM_github</span>  <span class="ot">-&gt;</span> lbs</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a>    <span class="dt">MM_pandoc</span>  <span class="ot">-&gt;</span> awk</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>      [ <span class="dt">Template</span> [ed|&lt;https?://${rest}([^)]+)&gt;///[${rest}]($0)|]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>      ]</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a>    <span class="dt">MM_hackage</span> <span class="ot">-&gt;</span> awk</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a>      [ <span class="dt">Template</span> [ed|&lt;br/&gt;$///\n|]</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a>      ]</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true"></a>    awk <span class="ot">=</span> fromMaybe oops <span class="op">.</span> <span class="fu">flip</span> sed&#39; lbs <span class="op">.</span> <span class="dt">Pipe</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true"></a>    <span class="co">-- runIdentity added to base in 4.9 only</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true"></a>    oops <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;tweak_md&quot;</span></span></code></pre></div>
<h2 id="branding">branding</h2>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a><span class="ot">branding ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a>branding <span class="ot">=</span> [here|&lt;a href=&quot;.&quot; style=&quot;font-family: Arial, &#39;Helvetica Neue&#39;, Helvetica, sans-serif;&quot; id=&quot;branding&quot;&gt;[&lt;span style=&#39;color:red;&#39;&gt;re&lt;/span&gt;|${&lt;span style=&#39;color:red;&#39;&gt;gex&lt;/span&gt;}(.*)|&lt;span&gt;&lt;/span&gt;]&lt;/a&gt;|]</span></code></pre></div>
<h2 id="tracking">tracking</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="ot">tracking ::</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a>tracking <span class="ot">=</span> [here|    &lt;script&gt;</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a>      (function(i,s,o,g,r,a,m){i[&#39;GoogleAnalyticsObject&#39;]=r;i[r]=i[r]||function(){</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true"></a>      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true"></a>      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true"></a>      })(window,document,&#39;script&#39;,&#39;https://www.google-analytics.com/analytics.js&#39;,&#39;ga&#39;);</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true"></a>      ga(&#39;create&#39;, &#39;UA-92650418-1&#39;, &#39;auto&#39;);</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true"></a>      ga(&#39;send&#39;, &#39;pageview&#39;);</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true"></a>    &lt;/script&gt;</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true"></a>|]</span></code></pre></div>
<h2 id="testing">testing</h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="ot">test ::</span> <span class="dt">IO</span> ()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a>test <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a>  test_pp <span class="st">&quot;re-prep doc&quot;</span> (prepare_tutorial <span class="dt">Doc</span>) <span class="st">&quot;data/pp-test.lhs&quot;</span> <span class="st">&quot;data/pp-result-doc.lhs&quot;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true"></a>  gm <span class="ot">&lt;-</span> genMode</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true"></a>  test_pp <span class="st">&quot;re-prep gen&quot;</span> (prepare_tutorial gm ) <span class="st">&quot;data/pp-test.lhs&quot;</span> <span class="st">&quot;data/pp-result-gen.lhs&quot;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;tests passed&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="ot">lbsReadFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LBS.ByteString</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a>lbsReadFile fp <span class="ot">=</span> LBS.fromStrict <span class="op">&lt;$&gt;</span> B.readFile fp</span></code></pre></div>
</div>    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-92650418-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>
